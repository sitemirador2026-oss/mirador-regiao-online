<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="siteTitle">Notícia - Mirador e Região Online</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* Logo styles for public site */
        .site-logo {
            max-height: 55px;
            max-width: 280px;
            object-fit: contain;
        }
        
        .logo-text {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
            letter-spacing: -0.02em;
        }
        
        /* Estilos para o conteúdo da notícia */
        .news-content img {
            max-width: 100%;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
        
        .news-content p {
            margin-bottom: 1.5rem;
            line-height: 1.8;
        }
        
        .news-content h2, .news-content h3 {
            margin: 2rem 0 1rem;
            line-height: 1.3;
        }
        
        .news-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: var(--muted-foreground);
        }
        
        .news-content ul, .news-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
        }
        
        .news-content li {
            margin-bottom: 0.5rem;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo" id="siteLogoLink">
                    <img id="siteLogoImg" class="site-logo" src="" alt="" style="display: none;">
                    <span id="siteLogoText" class="logo-text">Mirador e Região Online</span>
                </a>
                <a href="index.html" class="view-all">← Voltar</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <article class="container" id="newsArticle" style="max-width: 800px; padding: 2rem 0;">
            <!-- Conteúdo será carregado aqui -->
        </article>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p id="footerCopyright">&copy; 2026 Mirador e Região Online. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Config -->
    <script src="js/firebase-config.js?v=9"></script>
    
    <script>
        // Carregar configurações do Firebase
        async function loadAndApplySettings() {
            console.log('[Noticia] Carregando configurações...');
            try {
                // Carregar cores
                console.log('[Noticia] Carregando cores...');
                const colorsDoc = await db.collection('settings').doc('colors').get();
                console.log('[Noticia] Cores encontradas?', colorsDoc.exists);
                if (colorsDoc.exists) {
                    const colors = colorsDoc.data();
                    const root = document.documentElement;
                    if (colors.Primary) root.style.setProperty('--primary', colors.Primary);
                    if (colors.Secondary) root.style.setProperty('--secondary', colors.Secondary);
                    if (colors.Accent) root.style.setProperty('--accent', colors.Accent);
                    if (colors.Background) root.style.setProperty('--background', colors.Background);
                    if (colors.Foreground) root.style.setProperty('--foreground', colors.Foreground);
                    if (colors.Muted) root.style.setProperty('--muted', colors.Muted);
                    if (colors.MutedForeground) root.style.setProperty('--muted-foreground', colors.MutedForeground);
                    if (colors.Header) root.style.setProperty('--header-bg', colors.Header);
                    if (colors.HeaderText) root.style.setProperty('--header-text', colors.HeaderText);
                }
                
                // Carregar marca
                console.log('[Noticia] Carregando marca...');
                const brandDoc = await db.collection('settings').doc('brand').get();
                console.log('[Noticia] Marca encontrada?', brandDoc.exists);
                if (brandDoc.exists) {
                    const brand = brandDoc.data();
                    console.log('[Noticia] Dados da marca:', { siteName: brand.siteName, hasLogo: !!brand.logo });
                    var siteName = brand.siteName || 'Mirador e Região Online';
                    
                    // Update title
                    var siteTitleEl = document.getElementById('siteTitle');
                    if (siteTitleEl) siteTitleEl.textContent = 'Notícia - ' + siteName;
                    
                    // Update logo in header
                    var logoImg = document.getElementById('siteLogoImg');
                    var logoText = document.getElementById('siteLogoText');
                    
                    if (brand.logo && logoImg) {
                        logoImg.src = brand.logo;
                        logoImg.alt = siteName;
                        logoImg.style.display = 'block';
                        if (logoText) logoText.style.display = 'none';
                    } else if (logoText) {
                        if (logoImg) logoImg.style.display = 'none';
                        logoText.style.display = 'block';
                        logoText.textContent = siteName;
                    }
                    
                    // Update footer
                    var footerCopyright = document.getElementById('footerCopyright');
                    if (footerCopyright) {
                        footerCopyright.innerHTML = '&copy; ' + new Date().getFullYear() + ' ' + siteName + '. Todos os direitos reservados.';
                    }
                    
                    return siteName;
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
            }
            return 'Mirador e Região Online';
        }
        
        // Carregar notícia do Firebase
        async function loadNewsFromFirebase(newsId) {
            try {
                const doc = await db.collection('news').doc(newsId).get();
                if (doc.exists) {
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error('Erro ao carregar notícia:', error);
                return null;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('[Noticia] DOM carregado, iniciando...');
            console.log('[Noticia] URL:', window.location.href);
            console.log('[Noticia] db disponível?', typeof db !== 'undefined');
            
            // Carregar configurações do Firebase
            const siteName = await loadAndApplySettings();
            
            // Pegar ID da notícia - pode vir da URL ou do localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let newsId = urlParams.get('id') || localStorage.getItem('currentNewsId');
            
            console.log('[Noticia] ID da notícia:', newsId);
            
            const container = document.getElementById('newsArticle');

            if (!newsId) {
                console.log('[Noticia] ID não encontrado na URL nem no localStorage');
                container.innerHTML = '<div class="empty-state" style="padding: 4rem 0; text-align: center;"><h2>Notícia não encontrada</h2><p>ID da notícia não especificado.</p><a href="index.html" style="color: var(--primary);">Voltar para home</a></div>';
                return;
            }

            // Carregar notícia do Firebase
            console.log('[Noticia] Carregando notícia do Firebase...');
            const article = await loadNewsFromFirebase(newsId);
            console.log('[Noticia] Notícia carregada:', article ? 'SIM' : 'NÃO');

            if (!article) {
                console.log('[Noticia] Notícia não encontrada no Firebase para ID:', newsId);
                container.innerHTML = '<div class="empty-state" style="padding: 4rem 0; text-align: center;"><h2>Notícia não encontrada</h2><p>Não foi possível encontrar a notícia com ID: <code>' + newsId + '</code></p><a href="index.html" style="color: var(--primary);">Voltar para home</a></div>';
                return;
            }

            // Update page title with article title
            document.title = article.title + ' - ' + siteName;

            // Formatar data
            const formattedDate = new Date(article.date).toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric' 
            });

            // Montar HTML da notícia
            let html = `
                <div style="margin-bottom: 2rem;">
                    <span class="news-card-category">${article.categoryName || article.category || 'Geral'}</span>
                    <h1 style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0; line-height: 1.2; color: var(--foreground);">${article.title}</h1>
                    <div class="news-card-meta" style="margin-bottom: 2rem;">
                        <span>${formattedDate}</span>
                        <span>Por ${article.author || 'Redação'}</span>
                    </div>
                </div>
            `;
            
            // Adicionar imagem se existir
            if (article.image) {
                html += `<img src="${article.image}" alt="${article.title}" style="width: 100%; border-radius: 12px; margin-bottom: 2rem;">`;
            }
            
            // Adicionar conteúdo
            html += `
                <div class="news-content" style="font-size: 1.125rem; line-height: 1.8; color: var(--foreground);">
                    ${article.content || article.excerpt || ''}
                </div>
                
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                    <a href="index.html" class="view-all">← Voltar para home</a>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Incrementar visualizações
            try {
                await db.collection('news').doc(newsId).update({
                    views: firebase.firestore.FieldValue.increment(1)
                });
            } catch (e) {
                console.log('Erro ao incrementar views:', e);
            }
        });
    </script>
</body>

</html>
