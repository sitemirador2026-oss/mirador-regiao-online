<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin - Mirador e Regiao Online</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- R2 Config e Client -->
    <script src="js/r2-config.js"></script>
    <script src="js/r2-client.js"></script>

    <style>
        /* CSS Version: 2026-02-09-001 - MEDIA LIBRARY */
        :root {
            /* Cores Principais - Paleta sofisticada */
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --secondary: #64748b;
            --accent: #f59e0b;
            --sidebar-width: 260px;
            
            /* Cores de Fundo */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-sidebar: #0f172a;
            --bg-sidebar-hover: rgba(255, 255, 255, 0.03);
            --bg-card: #ffffff;
            
            /* Cores de Texto */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --text-sidebar: #cbd5e1;
            --text-sidebar-hover: #ffffff;
            
            /* Cores de Estado */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            /* Bordas e Sombras */
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            
            /* Espacamentos */
            --radius-sm: 6px;
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* TransicÃµes */
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ========================================
           LOGIN STYLES - DISCRETO E MODERNO
           ======================================== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0F172A;
            padding: 1.5rem;
        }

        .login-box {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        #loginLogoWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        .login-logo-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-sidebar);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .login-logo-img {
            max-width: 180px;
            max-height: 70px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .login-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9375rem;
            transition: var(--transition);
            background: var(--bg-card);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .btn-login {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-login:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .login-error {
            display: none;
            background: var(--danger-light);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--danger);
        }

        .link-site {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .link-site:hover {
            color: var(--primary);
        }

        /* ========================================
           ADMIN LAYOUT
           ======================================== */
        .admin-container {
            display: none;
        }

        .admin-layout {
            display: flex;
            min-height: 100vh;
            padding-left: var(--sidebar-width);
        }

        /* ========================================
           SIDEBAR - Design Moderno e Compacto
           ======================================== */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 50;
            overflow-x: hidden;
            overscroll-behavior: contain;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.875rem;
        }

        .brand-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .brand-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
        }

        .brand-tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0.75rem;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            overscroll-behavior-y: contain;
            overscroll-behavior: contain;
        }

        .sidebar-nav::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
            display: none;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding: 0 0.875rem;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.875rem;
            margin: 0.125rem 0.5rem;
            color: var(--text-sidebar);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .nav-item:hover {
            color: var(--text-sidebar-hover);
            background: var(--bg-sidebar-hover);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .nav-item.active .nav-icon {
            color: var(--primary-light);
        }

        /* Ãcones pequenos e elegantes */
        .nav-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            opacity: 0.9;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--primary);
            color: white;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
        }

        /* User Profile no Footer da Sidebar */
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            color: white;
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .btn-logout {
            width: 100%;
            padding: 0.625rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            color: var(--text-sidebar);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */
        .main-content {
            flex: 1;
            width: 100%;
            min-width: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Top Header */
        .top-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-search {
            position: relative;
            width: 320px;
        }

        .header-search input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--bg-primary);
            transition: var(--transition);
        }

        .header-search input:focus {
            outline: none;
            border-color: var(--primary-light);
            background: var(--bg-card);
        }

        .header-search svg {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition);
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
        }

        .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-card);
        }

        /* Page Content */
        .page-content {
            padding: 2rem;
            max-width: 1400px;
            position: relative;
            z-index: 1;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        /* ========================================
           STATS CARDS - Design Moderno
           ======================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success) 0%, #34d399 100%); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%); }
        .stat-card.info::before { background: linear-gradient(90deg, var(--info) 0%, #60a5fa 100%); }

        .stat-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon svg {
            width: 22px;
            height: 22px;
        }

        .stat-icon.primary {
            background: var(--info-light);
            color: var(--primary);
        }

        .stat-icon.success {
            background: var(--success-light);
            color: var(--success);
        }

        .stat-icon.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .stat-icon.info {
            background: var(--info-light);
            color: var(--info);
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .stat-trend.up {
            color: var(--success);
            background: var(--success-light);
        }

        .stat-trend.down {
            color: var(--danger);
            background: var(--danger-light);
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ========================================
           CONTENT SECTIONS
           ======================================== */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .content-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .section-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* ========================================
           STORAGE ACCOUNTS
           ======================================== */
        .accounts-layout {
            display: grid;
            gap: 1.25rem;
        }

        .account-block {
            position: relative;
            overflow: hidden;
        }

        .account-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            opacity: 0.9;
        }

        .account-render::before {
            background: linear-gradient(90deg, #374151 0%, #6b7280 100%);
        }

        .account-cloudflare::before {
            background: linear-gradient(90deg, #f97316 0%, #fb923c 100%);
        }

        .account-firebase::before {
            background: linear-gradient(90deg, #f59e0b 0%, #fcd34d 100%);
        }

        .account-head {
            padding: 1.25rem 1.5rem 0.75rem;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .account-brand {
            display: grid;
            gap: 0.375rem;
        }

        .account-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            width: fit-content;
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-size: 0.6875rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .account-render .account-badge {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .account-cloudflare .account-badge {
            background: #fff7ed;
            color: #9a3412;
            border: 1px solid #fdba74;
        }

        .account-firebase .account-badge {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .account-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .account-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .account-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .account-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .account-link:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .account-render .account-link:hover {
            border-color: #9ca3af;
            color: #111827;
            background: #f9fafb;
        }

        .account-cloudflare .account-link:hover {
            border-color: #fdba74;
            color: #9a3412;
            background: #fff7ed;
        }

        .account-firebase .account-link:hover {
            border-color: #fcd34d;
            color: #92400e;
            background: #fffbeb;
        }

        .account-block .stats-grid {
            margin: 0;
            padding: 0 1.5rem 1rem;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 1rem;
        }

        .account-block .stat-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-color: var(--border);
            padding: 1.1rem;
        }

        .account-meta {
            margin: 0 1.5rem 1.25rem;
            padding: 0.9rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .account-progress-wrap {
            margin: 0 1.5rem 1rem;
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border-light);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* ========================================
           DATA TABLE - Estilo Profissional
           ======================================== */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.875rem 1.5rem;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .data-table tr:hover td {
            background: var(--bg-primary);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-published {
            background: var(--success-light);
            color: var(--success);
        }

        .status-published::before {
            background: var(--success);
        }

        .status-draft {
            background: var(--warning-light);
            color: var(--warning);
        }

        .status-draft::before {
            background: var(--warning);
        }

        .status-scheduled {
            background: var(--info-light);
            color: var(--info);
        }

        .status-scheduled::before {
            background: var(--info);
        }

        /* Category Badge */
        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
        }

        /* Action Buttons */
        .actions-cell {
            display: flex;
            gap: 0.375rem;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--bg-primary);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .action-btn.delete:hover {
            color: var(--danger);
            border-color: var(--danger);
            background: var(--danger-light);
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        /* Media Library */
        .media-library-section {
            padding: 1.25rem;
        }

        .media-toolbar {
            margin-bottom: 1rem;
        }

        .media-toolbar-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .media-search-wrap {
            position: relative;
            flex: 1;
            min-width: 260px;
        }

        .media-search-wrap svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .media-search-wrap .form-input {
            padding-left: 2.25rem;
        }

        .media-filter-select {
            width: 210px;
            max-width: 100%;
            min-width: 170px;
        }

        .media-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .media-summary-card {
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .media-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .media-summary-value {
            font-size: 1.25rem;
            line-height: 1.1;
            font-weight: 700;
            color: var(--text-primary);
        }

        .media-status-text {
            margin-bottom: 1rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(10, minmax(0, 1fr));
            gap: 0.5rem;
        }

        .media-card {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .media-preview-wrap {
            aspect-ratio: 16 / 9;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .media-preview-wrap img,
        .media-preview-wrap video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .media-preview-wrap video {
            background: #000;
        }

        .media-preview-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            background:
                linear-gradient(135deg, rgba(148, 163, 184, 0.16) 0%, rgba(148, 163, 184, 0.08) 100%);
        }

        .media-kind-badge,
        .media-size-badge {
            position: absolute;
            top: 0.28rem;
            padding: 0.18rem 0.36rem;
            border-radius: 999px;
            font-size: 0.6rem;
            font-weight: 600;
            line-height: 1;
            color: #fff;
            backdrop-filter: blur(2px);
            background: rgba(15, 23, 42, 0.75);
        }

        .media-kind-badge {
            left: 0.28rem;
        }

        .media-size-badge {
            right: 0.28rem;
        }

        .media-card-body {
            padding: 0.45rem;
            display: flex;
            flex-direction: column;
            gap: 0.32rem;
            flex: 1;
        }

        .media-key {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.64rem;
            color: var(--text-secondary);
            word-break: normal;
            line-height: 1.25;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-owner-line {
            font-size: 0.66rem;
            color: var(--text-secondary);
            line-height: 1.25;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-owner-chip-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0.22rem;
        }

        .media-owner-chip {
            font-size: 0.58rem;
            padding: 0.16rem 0.32rem;
            border-radius: var(--radius-sm);
            background: var(--info-light);
            color: #1e3a8a;
            font-weight: 600;
            line-height: 1.2;
        }

        .media-owner-chip.locked {
            background: var(--warning-light);
            color: #92400e;
        }

        .media-owner-chip.orphan {
            background: var(--danger-light);
            color: #991b1b;
        }

        .media-meta-row {
            display: flex;
            justify-content: space-between;
            gap: 0.3rem;
            font-size: 0.62rem;
            color: var(--text-muted);
        }

        .media-meta-row span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-actions {
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.25rem;
        }

        .media-actions .btn {
            min-height: 24px;
            padding: 0.2rem 0.38rem;
            font-size: 0.64rem;
        }

        .media-delete-btn[disabled] {
            opacity: 0.55;
            cursor: not-allowed;
            pointer-events: none;
        }

        @media (max-width: 1400px) {
            .media-grid {
                grid-template-columns: repeat(8, minmax(0, 1fr));
            }
        }

        @media (max-width: 1200px) {
            .media-grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }

        @media (max-width: 992px) {
            .media-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        /* News Table Styles - OVERRIDE data-table */
        .news-table {
            table-layout: fixed !important;
            border-collapse: separate !important;
        }

        .news-table th,
        .news-table td {
            padding: 0.75rem !important;
        }

        .news-table colgroup col:first-child {
            width: 60px;
        }

        .news-table colgroup col:nth-child(2) {
            width: auto;
        }

        .news-table colgroup col:nth-child(3) {
            width: 100px;
        }

        .news-table colgroup col:nth-child(4) {
            width: 90px;
        }

        .news-table colgroup col:nth-child(5) {
            width: 80px;
        }

        .news-table td:nth-child(5) {
            text-align: center;
        }

        .news-thumb-container {
            position: relative;
            width: 50px;
            height: 35px;
            display: inline-block;
        }

        .news-thumb {
            width: 50px;
            height: 35px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }

        .news-thumb-placeholder {
            width: 50px;
            height: 35px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .status-indicator {
            position: absolute;
            top: -4px;
            left: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-indicator.published {
            background: #22c55e;
        }

        .status-indicator.draft {
            background: #eab308;
        }

        .news-title-cell {
            overflow: hidden !important;
            max-width: 100%;
        }

        .news-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            line-height: 1.4;
            display: block;
            max-width: 100%;
        }

        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========================================
           QUICK ACTIONS SIDEBAR
           ======================================== */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .action-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 1.25rem;
        }

        .action-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .quick-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.875rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .quick-btn:last-child {
            margin-bottom: 0;
        }

        .quick-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .quick-btn svg {
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        .quick-btn:hover svg {
            color: var(--primary);
        }

        /* ========================================
           LOGO UPLOAD STYLES
           ======================================== */
        .logo-upload-section {
            margin-bottom: 2rem;
        }

        .logo-upload-wrapper {
            display: flex;
            align-items: stretch;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .logo-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            background: var(--bg-primary);
            transition: var(--transition);
            cursor: pointer;
            min-width: 200px;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .logo-upload-area:hover {
            border-color: var(--primary-light);
            background: var(--info-light);
        }

        .logo-upload-area.drag-over {
            border-color: var(--primary);
            background: var(--info-light);
        }

        .logo-upload-area.has-image {
            border-style: solid;
            border-color: var(--success);
            background: var(--success-light);
        }

        .logo-upload-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 0.5rem;
            color: var(--text-muted);
        }

        .logo-upload-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .logo-upload-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .logo-upload-change {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-upload-change svg {
            width: 24px;
            height: 24px;
            color: var(--success);
        }

        .logo-upload-change-text {
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 500;
        }

        .logo-upload-change-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .logo-preview-container {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex: 1;
        }

        .logo-preview-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-preview {
            max-width: 150px;
            max-height: 60px;
            object-fit: contain;
            border-radius: var(--radius);
        }

        .logo-preview-dark {
            background: var(--bg-sidebar);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            min-width: 150px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-preview-light {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            min-width: 150px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-preview-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-align: center;
        }

        .logo-preview-box img {
            max-width: 135px;
            max-height: 60px;
            object-fit: contain;
        }

        .brand-input-group {
            margin-bottom: 1.25rem;
        }

        .brand-input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .brand-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9375rem;
            transition: var(--transition);
            background: var(--bg-card);
        }

        .brand-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .brand-color-input {
            height: 46px;
            padding: 0.35rem;
            cursor: pointer;
        }

        .brand-color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .brand-color-input::-webkit-color-swatch {
            border: none;
            border-radius: calc(var(--radius) - 2px);
        }

        /* Sidebar logo styles */
        .sidebar-brand-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: var(--radius);
        }

        .sidebar-brand-text-logo {
            max-width: 270px;
            max-height: 75px;
            object-fit: contain;
        }

        .sidebar-brand-logo-full {
            max-width: 270px;
            max-height: 83px;
            object-fit: contain;
        }

        /* Activity Feed */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            gap: 0.75rem;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.published {
            background: var(--success-light);
            color: var(--success);
        }

        .activity-icon.edited {
            background: var(--info-light);
            color: var(--info);
        }

        .activity-icon.deleted {
            background: var(--danger-light);
            color: var(--danger);
        }

        .activity-icon svg {
            width: 14px;
            height: 14px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .activity-text strong {
            font-weight: 600;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 1280px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .admin-layout {
                padding-left: 0;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                width: 100%;
            }

            .page-content {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-header {
                padding: 1rem 1.5rem;
            }

            .header-search {
                display: none;
            }

            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .account-head {
                padding: 1rem 1rem 0.5rem;
            }

            .account-block .stats-grid {
                padding: 0 1rem 1rem;
                grid-template-columns: 1fr;
            }

            .account-meta,
            .account-progress-wrap {
                margin-left: 1rem;
                margin-right: 1rem;
            }

            .account-links {
                width: 100%;
            }

            .account-link {
                width: 100%;
            }

            .data-table {
                font-size: 0.8125rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.875rem 0.5rem;
            }

            /* Responsive News Table */
            .news-title {
                max-width: 150px;
            }

            .media-toolbar-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .media-search-wrap {
                min-width: 0;
            }

            .media-filter-select {
                width: 100%;
            }

            .media-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            padding: 0.5rem;
            margin-right: 0.75rem;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ========================================
           NOTIFICATION MODAL
           ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0.75rem;
            text-align: center;
        }

        .modal-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .modal-icon.success {
            background: var(--success-light);
            color: var(--success);
        }

        .modal-icon.error {
            background: var(--danger-light);
            color: var(--danger);
        }

        .modal-icon.info {
            background: var(--info-light);
            color: var(--info);
        }

        .modal-icon.warning {
            background: var(--warning-light);
            color: #b45309;
        }

        .modal-icon svg {
            width: 28px;
            height: 28px;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .modal-message {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-line;
            word-break: break-word;
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            justify-content: center;
        }

        .modal-footer.confirm-actions {
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .modal-btn {
            padding: 0.625rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 100px;
        }

        .modal-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .modal-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .modal-btn-secondary:hover {
            background: var(--border);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .modal-btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        @media (max-width: 520px) {
            .modal-footer.confirm-actions {
                flex-direction: column-reverse;
                justify-content: stretch;
            }

            .modal-footer.confirm-actions .modal-btn {
                width: 100%;
            }
        }

    </style>
</head>

<body>
    <!-- Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <div id="loginLogoWrapper">
                    <div class="login-logo-icon" id="loginLogoIcon">M</div>
                    <img id="loginLogoImg" class="login-logo-img" src="" alt="" style="display: none;">
                </div>
                <h1 class="login-title" id="loginTitle">Painel Administrativo</h1>
                <p class="login-subtitle" id="loginSubtitle">Entre com suas credenciais</p>
            </div>
            <div class="login-error" id="loginError" style="display: none;">Email ou senha incorretos</div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" class="form-input" placeholder="Sua senha" required>
                </div>
                <button type="submit" class="btn-login">Entrar</button>
            </form>
            <a href="../public/index.html" class="link-site">&larr; Voltar para o site</a>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-container" id="adminContainer">
        <div class="admin-layout">
            <!-- Sidebar Overlay (Mobile) -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-brand" id="sidebarBrand">
                        <!-- Modo icone (sem logo) -->
                        <div id="sidebarIconMode">
                            <div class="brand-icon" id="sidebarIcon">M</div>
                            <div>
                                <div class="brand-text" id="sidebarBrandText">Mirador Online</div>
                                <div class="brand-tagline" id="sidebarTagline">Portal de Noticias</div>
                            </div>
                        </div>
                        <!-- Modo logo (com logo) -->
                        <div id="sidebarLogoMode" style="display: none; flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                            <img id="sidebarLogo" class="sidebar-brand-logo-full" src="" alt="">
                            <div class="brand-tagline" id="sidebarLogoTagline">Portal de Noticias</div>
                        </div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Menu Principal</div>
                        <a href="#" class="nav-item active" onclick="showPage('dashboard', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            Dashboard
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('news', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                            </svg>
                            Criar Notícias
                            <span class="nav-badge" id="newsCountBadge">0</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('instagram', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"/>
                                <circle cx="12" cy="12" r="4" stroke-width="2"/>
                                <circle cx="18" cy="6" r="1" fill="currentColor"/>
                            </svg>
                            Instagram
                            <span class="nav-badge" id="instagramCountBadge">0</span>
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('importNews', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                            </svg>
                            Importar Noticia
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('categories', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                            Categorias
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('media', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Midia
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('storage', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                            </svg>
                            Contas/Armazenamento
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Configuracoes</div>
                        <a href="#" class="nav-item" onclick="showPage('settings', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Configuracoes
                        </a>
                        <a href="#" class="nav-item" onclick="showPage('users', this); return false;">
                            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            Usuarios
                        </a>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">EC</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Editor Chefe</div>
                            <div class="user-role" id="userEmail">admin@mirador.com</div>
                        </div>
                    </div>
                    <button class="btn-logout" onclick="logout()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Sair da conta
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Top Header -->
                <header class="top-header">
                    <div style="display: flex; align-items: center;">
                        <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
                            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <div class="header-search">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" placeholder="Buscar noticias, categorias...">
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <span class="notification-dot"></span>
                        </button>
                        <button class="header-btn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                    </div>
                </header>

                <!-- DASHBOARD PAGE -->
                <div id="dashboardPage" class="page-content">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Visao Geral</h1>
                            <p class="page-subtitle">Acompanhe o desempenho do seu conteudo em tempo real</p>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card primary" onclick="showPage('news', document.querySelectorAll('.nav-item')[1])" style="cursor: pointer;">
                            <div class="stat-header">
                                <div class="stat-icon primary">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                                    </svg>
                                </div>
                                <span class="stat-trend up">+12%</span>
                            </div>
                            <div class="stat-value" id="totalNews">0</div>
                            <div class="stat-label">Noticias Publicadas</div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-header">
                                <div class="stat-icon success">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </div>
                                <span class="stat-trend up">+24%</span>
                            </div>
                            <div class="stat-value" id="totalViews">0</div>
                            <div class="stat-label">Total de Visualizacoes</div>
                        </div>

                        <div class="stat-card warning" onclick="showPage('news', document.querySelectorAll('.nav-item')[1])" style="cursor: pointer;">
                            <div class="stat-header">
                                <div class="stat-icon warning">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </div>
                                <span class="stat-trend down">-5%</span>
                            </div>
                            <div class="stat-value" id="draftNews">0</div>
                            <div class="stat-label">Rascunhos Pendentes</div>
                        </div>

                        <div class="stat-card info">
                            <div class="stat-header">
                                <div class="stat-icon info">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                </div>
                                <span class="stat-trend up">+8%</span>
                            </div>
                            <div class="stat-value" id="activeReaders">0</div>
                            <div class="stat-label">Leitores Ativos (estimativa)</div>
                        </div>
                    </div>

                    <!-- Acoes Rapidas do Dashboard -->
                    <div class="content-grid" style="margin-top: 2rem;">
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Acoes Rapidas</h2>
                            </div>
                            <div style="padding: 1.5rem;">
                                <button class="quick-btn" onclick="showCreateNewsPage()" style="width: 100%; margin-bottom: 0.75rem;">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Escrever nova noticia
                                </button>
                                <button class="quick-btn" onclick="showPage('importNews', document.querySelectorAll('.nav-item')[3])" style="width: 100%; margin-bottom: 0.75rem;">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                    </svg>
                                    Importar noticia por URL
                                </button>
                                <button class="quick-btn" onclick="showPage('storage', document.querySelectorAll('.nav-item')[6])" style="width: 100%;">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                                    </svg>
                                    Ver Contas/Armazenamento
                                </button>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="action-card">
                            <h3 class="action-card-title">Atividade Recente</h3>
                            <div class="activity-list" id="activityList">
                                <div class="activity-item">
                                    <div class="activity-icon published">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-text">Noticia <strong>"Nova obra inaugura"</strong> publicada</div>
                                        <div class="activity-time">Ha 2 horas</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEWS PAGE - Pagina exclusiva de Noticias -->
                <div id="newsPage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Criar Notícias</h1>
                            <p class="page-subtitle">Area padronizada para publicações e criação de notícias</p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <button class="btn btn-tab active" id="tabNewsPublicacoes" onclick="switchNewsTab('publicacoes')" style="background: transparent; border: none; border-bottom: 2px solid var(--primary); padding: 0.75rem 1.25rem; color: var(--primary); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8"/>
                            </svg>
                            Publicações
                        </button>
                        <button class="btn btn-tab" id="tabNewsCriar" onclick="switchNewsTab('criar')" style="background: transparent; border: none; border-bottom: 2px solid transparent; padding: 0.75rem 1.25rem; color: var(--text-muted); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Criar Notícias
                        </button>
                    </div>

                    <div id="newsPublicacoesTab" class="news-tab-content">
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Todas as Noticias do Portal</h2>
                                <div class="section-actions">
                                    <button class="btn btn-secondary btn-sm">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                                        </svg>
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table news-table">
                                    <colgroup>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>Capa</th>
                                            <th>Titulo</th>
                                            <th>Categoria</th>
                                            <th>Data</th>
                                            <th>Acoes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="newsListPage">
                                        <!-- Noticias serao inseridas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="newsCriarTab" class="news-tab-content" style="display: none;">
                        <div class="content-section" style="max-width: 760px; margin: 0 auto;">
                            <div style="padding: 2rem; text-align: center;">
                                <div style="width: 56px; height: 56px; margin: 0 auto 1rem; border-radius: 50%; background: rgba(59,130,246,0.12); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </div>
                                <h2 class="section-title" style="margin-bottom: 0.5rem;">Criar Notícias</h2>
                                <p style="color: var(--text-secondary); margin-bottom: 1.25rem;">Abra o editor para escrever e publicar uma nova noticia do portal.</p>
                                <button class="btn btn-primary" onclick="showCreateNewsPage()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    Abrir editor de notícias
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CATEGORIES PAGE -->
                <div id="categoriesPage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Categorias</h1>
                            <p class="page-subtitle">Gerencie as categorias do seu site</p>
                        </div>
                    </div>

                    <div class="content-grid">
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Categorias Existentes</h2>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div id="categoriesList" style="display: grid; gap: 0.75rem;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Mirador</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: var(--success); border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Regiao</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: var(--danger); border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Brasil</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Policia</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: var(--info); border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Esportes</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <span style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 50%;"></span>
                                            <span style="font-weight: 500;">Politica</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: var(--text-muted);">0 noticias</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="content-section" style="max-width: 400px;">
                            <div class="section-header">
                                <h2 class="section-title">Adicionar Categoria</h2>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Nome da Categoria</label>
                                    <input type="text" class="form-input" placeholder="Ex: Tecnologia" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: var(--radius);">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Cor</label>
                                    <input type="color" value="#2563eb" style="width: 100%; height: 40px; border: 1px solid var(--border); border-radius: var(--radius);">
                                </div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="showModal('Em breve!', 'Gerenciamento de categorias em desenvolvimento.', 'info')">
                                    Adicionar Categoria
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MEDIA PAGE -->
                <div id="mediaPage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Midia</h1>
                            <p class="page-subtitle">Gerencie arquivos no Cloudflare R2 e seus vinculos com o site</p>
                        </div>
                        <button class="btn btn-secondary" onclick="loadMediaLibrary(true)">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582M20 20v-5h-.581M4.582 9A8 8 0 0118 6.34L20 9M4 15l2 2.66A8 8 0 0019.418 15"/>
                            </svg>
                            Atualizar
                        </button>
                    </div>

                    <div class="content-section media-library-section">
                        <div class="media-toolbar">
                            <div class="media-toolbar-controls">
                                <div class="media-search-wrap">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.85-5.15a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                    <input
                                        type="text"
                                        id="mediaSearchInput"
                                        class="form-input"
                                        placeholder="Buscar por chave, titulo, tipo..."
                                        oninput="handleMediaFiltersChange()">
                                </div>
                                <select id="mediaOwnerTypeFilter" class="form-input media-filter-select" onchange="handleMediaFiltersChange()">
                                    <option value="all">Todos os tipos</option>
                                    <option value="noticia">Noticias</option>
                                    <option value="post">Posts</option>
                                    <option value="story">Stories</option>
                                    <option value="logo">Logos</option>
                                    <option value="perfil">Foto de perfil</option>
                                    <option value="banner">Banners</option>
                                    <option value="orphan">Sem vinculo</option>
                                </select>
                                <select id="mediaStatusFilter" class="form-input media-filter-select" onchange="handleMediaFiltersChange()">
                                    <option value="all">Todos os status</option>
                                    <option value="locked">Exclusao bloqueada</option>
                                    <option value="deletable">Pode excluir</option>
                                    <option value="linked">Com vinculo</option>
                                    <option value="orphan">Orfas</option>
                                </select>
                            </div>
                        </div>

                        <div class="media-summary-grid">
                            <div class="media-summary-card">
                                <span class="media-summary-label">Arquivos no R2</span>
                                <strong class="media-summary-value" id="mediaSummaryTotal">0</strong>
                            </div>
                            <div class="media-summary-card">
                                <span class="media-summary-label">Com vinculo</span>
                                <strong class="media-summary-value" id="mediaSummaryLinked">0</strong>
                            </div>
                            <div class="media-summary-card">
                                <span class="media-summary-label">Orfas</span>
                                <strong class="media-summary-value" id="mediaSummaryOrphan">0</strong>
                            </div>
                            <div class="media-summary-card">
                                <span class="media-summary-label">Exclusao bloqueada</span>
                                <strong class="media-summary-value" id="mediaSummaryLocked">0</strong>
                            </div>
                        </div>

                        <p id="mediaLibraryStatus" class="media-status-text">Carregue a biblioteca para listar os arquivos.</p>

                        <div id="mediaLibraryList" class="media-grid">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p>Nenhuma midia carregada.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instagram Page -->
                <div id="instagramPage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Instagram</h1>
                            <p class="page-subtitle">Gerencie o feed e os posts do Instagram</p>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <button class="btn btn-tab active" id="tabPosts" onclick="switchInstagramTab('posts')" style="background: transparent; border: none; border-bottom: 2px solid var(--primary); padding: 0.75rem 1.25rem; color: var(--primary); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8"/>
                            </svg>
                            Posts Publicados
                        </button>
                        <button class="btn btn-tab" id="tabImport" onclick="switchInstagramTab('import')" style="background: transparent; border: none; border-bottom: 2px solid transparent; padding: 0.75rem 1.25rem; color: var(--text-muted); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            Feed
                        </button>
                    </div>

                    <!-- Posts Tab -->
                    <div id="instagramPostsTab" class="instagram-tab-content">
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Posts Publicados no Instagram</h2>
                                <div class="section-actions" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span id="instagramPostsCount" style="font-size: 0.8125rem; color: var(--text-muted);">0 post(s)</span>
                                    <button class="btn btn-secondary btn-sm" onclick="loadInstagramPostsPage()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0A8.003 8.003 0 015.582 15m13.837 0H15"/>
                                        </svg>
                                        Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table news-table">
                                    <colgroup>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>Capa</th>
                                            <th>Titulo</th>
                                            <th>Categoria</th>
                                            <th>Data</th>
                                            <th>Acoes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="instagramPostsList">
                                        <!-- Posts do Instagram serao carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Import News Tab -->
                    <div id="instagramImportTab" class="instagram-tab-content" style="display: none;">
                        <div style="max-width: 700px; margin: 0 auto; padding: 2rem;">
                            <h2 class="section-title" style="margin-bottom: 1.5rem;"> Feed do Instagram</h2>
                            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem;">
                                <!-- Perfil oficial do Instagram (configuração fixa) -->
                                <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #fff5f8 0%, #fff 100%); border-radius: var(--radius); border: 1px solid #f5d3df;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <label style="display: block; font-size: 0.9375rem; font-weight: 600; color: #E4405F; margin: 0;">
                                            Perfil oficial exibido no site
                                        </label>
                                        <button class="btn btn-secondary" type="button" onclick="saveInstagramProfileSettingsAdmin()" style="white-space: nowrap;">Salvar perfil</button>
                                    </div>
                                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                        Configure uma vez o nome e a foto do perfil oficial. Todos os cards do Instagram no site usarão esse mesmo perfil.
                                    </p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <div>
                                            <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.35rem;">Nome exibido</label>
                                            <input type="text" id="instagramDefaultProfileName" oninput="updateInstagramProfilePreviewAdmin()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" placeholder="Mirador e Região Online">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.35rem;">@usuario (sem @)</label>
                                            <input type="text" id="instagramDefaultProfileUsername" oninput="updateInstagramProfilePreviewAdmin()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" placeholder="mirador_e_regiao_online">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.35rem;">Foto do perfil</label>
                                        <div id="instagramDefaultProfileUploadArea" style="width: 100%; background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius); padding: 0.9rem; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('instagramDefaultProfileUpload').click()" ondragover="event.preventDefault(); this.style.borderColor='#E4405F'; this.style.background='#fff5f5';" ondragleave="this.style.borderColor='var(--border)'; this.style.background='var(--bg-primary)';" ondrop="handleInstagramDefaultProfileImageDrop(event)">
                                            <input type="file" id="instagramDefaultProfileUpload" accept="image/*" style="display: none;" onchange="handleInstagramDefaultProfileImageUpload(event)">
                                            <div style="font-size: 0.875rem; font-weight: 500; color: var(--text-primary);">Clique ou arraste a foto aqui</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem;">JPG, PNG, WebP (max. 10MB)</div>
                                        </div>
                                        <input type="hidden" id="instagramDefaultProfileImage">
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.625rem;">
                                        <div id="instagramDefaultProfilePreviewWrap" style="width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border); overflow: hidden; background: var(--bg-secondary); display: none;">
                                            <img id="instagramDefaultProfilePreview" src="" alt="Preview perfil Instagram" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <span id="instagramDefaultProfilePreviewName" style="font-size: 0.8125rem; color: var(--text-muted);">Sem foto configurada</span>
                                        <button id="instagramDefaultProfileRemoveBtn" type="button" class="btn btn-secondary btn-sm" style="display: none;" onclick="removeInstagramDefaultProfileImage()">Remover foto</button>
                                    </div>
                                </div>
                                
                                <!-- Link do Instagram (PRIMEIRO - para extracao automatica) -->
                                <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: var(--radius); border: 1px solid #e5e5e5;">
                                    <label style="display: block; font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.5rem; color: #E4405F;">
                                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z"/>
                                        </svg>
                                        Link do Post no Instagram <span style="color: var(--destructive);">*</span>
                                    </label>
                                    <input type="url" id="instagramNewsUrl" style="width: 100%; padding: 0.875rem; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); font-size: 0.9375rem;" placeholder="https://instagram.com/p/ABC123... ou https://instagram.com/reel/ABC123..." onpaste="extractInstagramNewsData(event)" onchange="extractInstagramNewsData(event)">
                                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                                        <strong>Importante:</strong> Cole o link completo do post do Instagram para extrair automaticamente a legenda, curtidas e comentarios. 
                                        <a href="#" onclick="showModal('Como copiar o link', '1. Abra o post no Instagram\n2. Clique nos 3 pontos (...) no canto superior direito\n3. Selecione \"Copiar link\"\n4. Cole aqui', 'info'); return false;" style="color: var(--primary);">Como copiar o link?</a>
                                    </p>
                                </div>
                                
                                <!-- Upload de Midia -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Midia do Post (Imagem ou Video)</label>
                                    <div id="instagramImageUploadArea" style="width: 100%; background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius); padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('instagramImageUpload').click()" ondragover="event.preventDefault(); this.style.borderColor='#E4405F'; this.style.background='#fff5f5';" ondragleave="this.style.borderColor='var(--border)'; this.style.background='var(--bg-primary)';" ondrop="handleInstagramImageDrop(event)">
                                        <input type="file" id="instagramImageUpload" accept="image/*,video/*" style="display: none;" onchange="handleInstagramImageUpload(event)">
                                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 0.5rem; opacity: 0.5;">
                                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke-width="2"/>
                                            <polyline points="17 8 12 3 7 8" stroke-width="2"/>
                                            <line x1="12" y1="3" x2="12" y2="15" stroke-width="2"/>
                                        </svg>
                                        <p style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);">Clique ou arraste a imagem aqui</p>
                                        <p style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem;">JPG, PNG, WebP, MP4, MOV, WebM (video max. 15MB apos compressao)</p>
                                    </div>
                                    
                                    <!-- Preview da Imagem -->
                                    <div id="instagramImagePreviewContainer" style="display: none; margin-top: 0.75rem; position: relative;">
                                        <img id="instagramNewsImage" style="width: 100%; max-height: 400px; object-fit: contain; background: #f0f0f0; border-radius: var(--radius); border: 1px solid var(--border);">
                                        <video id="instagramNewsVideo" style="display: none; width: 100%; max-height: 400px; object-fit: contain; background: #000; border-radius: var(--radius); border: 1px solid var(--border);" controls playsinline muted></video>
                                        <button type="button" onclick="removeInstagramImage()" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="instagramVideoManualNotice" style="display: none; margin-top: 0.75rem; padding: 0.75rem 0.875rem; border-radius: var(--radius); border: 1px solid #f59e0b; background: #fffbeb; color: #92400e; font-size: 0.8125rem; line-height: 1.4;">
                                        Detectamos que este link e um video (Reel), mas o Instagram nao liberou o arquivo para download automatico. Faça upload manual do video no campo acima para publicar fiel ao post original.
                                    </div>
                                    <input type="hidden" id="instagramNewsImageUrl">
                                    <input type="hidden" id="instagramNewsVideoUrl">
                                    <input type="hidden" id="instagramNewsMediaType" value="image">
                                </div>
                                
                                <!-- Galeria de Fotos/Videos Adicionais -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        Galeria de Fotos/Videos (Opcional)
                                    </label>
                                    <div id="instagramGalleryUploadArea" style="width: 100%; background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius); padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('instagramGalleryUpload').click()" ondragover="event.preventDefault(); this.style.borderColor='#E4405F'; this.style.background='#fff5f5';" ondragleave="this.style.borderColor='var(--border)'; this.style.background='var(--bg-primary)';" ondrop="handleInstagramGalleryDrop(event)">
                                        <input type="file" id="instagramGalleryUpload" accept="image/*,video/*" multiple style="display: none;" onchange="handleInstagramGalleryUpload(event)">
                                        <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 0.5rem; opacity: 0.5;">
                                            <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/>
                                        </svg>
                                        <p style="font-size: 0.875rem; color: var(--text-muted); margin: 0;">
                                            Clique ou arraste fotos/videos aqui<br>
                                            <small>Max: 5 itens, 200KB cada. Imagens serao comprimidas.</small>
                                        </p>
                                    </div>
                                    
                                    <!-- Preview da Galeria -->
                                    <div id="instagramGalleryPreviewContainer" style="display: none; margin-top: 1rem;">
                                        <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.5rem;">Fotos/Videos adicionados:</p>
                                        <div id="instagramGalleryPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;">
                                            <!-- Itens da galeria serao inseridos aqui -->
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden input para armazenar URLs da galeria -->
                                    <input type="hidden" id="instagramGalleryUrls" value="[]">
                                </div>
                                
                                <!-- Legenda do Post -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Legenda / Conteudo</label>
                                    <textarea id="instagramNewsCaption" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical; font-family: inherit;" placeholder="A legenda sera extraida automaticamente ao colar o link do Instagram. Voce tambem pode digitar ou editar aqui..."></textarea>
                                </div>
                                
                                <!-- Loading -->
                                <div id="instagramNewsLoading" style="display: none; text-align: center; padding: 1.5rem;">
                                    <div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: #E4405F; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.75rem;"></div>
                                    <p style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);">Extraindo dados do Instagram...</p>
                                    <p style="font-size: 0.8125rem; color: var(--text-muted);">Buscando legenda, curtidas e comentarios</p>
                                </div>
                                
                                <!-- Preview do Formulario -->
                                <div id="instagramNewsPreview" style="display: none;">
                                    <div style="padding: 1rem; background: var(--success-light); border-radius: var(--radius); margin-bottom: 1.5rem; border-left: 4px solid var(--success);">
                                        <p style="font-size: 0.875rem; color: var(--success); margin: 0;">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                            </svg>
                                            Dados extraidos com sucesso! Verifique e ajuste se necessario.
                                        </p>
                                    </div>
                                    
                                    <!-- Estatisticas do Instagram -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Curtidas</label>
                                            <input type="number" id="instagramLikesCount" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" placeholder="0" min="0">
                                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Quantidade de curtidas no post</p>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Comentarios</label>
                                            <input type="number" id="instagramCommentsCount" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" placeholder="0" min="0">
                                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Quantidade de comentarios</p>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Categoria</label>
                                        <select id="instagramNewsCategory" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
                                            <option value="instagram" selected> Instagram</option>
                                            <option value="mirador">Mirador</option>
                                            <option value="regiao">Regiao</option>
                                            <option value="brasil">Brasil</option>
                                            <option value="policia">Policia</option>
                                            <option value="esportes">Esportes</option>
                                            <option value="politica">Politica</option>
                                            <option value="geral">Geral</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                        <button class="btn btn-secondary" onclick="clearInstagramNewsForm()">Limpar Tudo</button>
                                        <button class="btn btn-primary" onclick="saveInstagramNews()">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            Publicar Post
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Storage Page -->
                <div id="storagePage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Contas/Armazenamento</h1>
                            <p class="page-subtitle">Resumo visual por conta: Render, Cloudflare e Firebase.</p>
                        </div>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="loadStorageInfo()">
                                Atualizar
                            </button>
                        </div>
                    </div>

                    <div class="accounts-layout">
                        <!-- Render -->
                        <section class="content-section account-block account-render">
                            <div class="account-head">
                                <div class="account-brand">
                                    <span class="account-badge">Render</span>
                                    <h2 class="account-title">Hospedagem do painel admin</h2>
                                    <p class="account-description">Status do servidor onde o painel administrativo esta publicado.</p>
                                </div>
                                <div class="account-links">
                                    <a id="renderDashboardLink" class="account-link" href="https://dashboard.render.com" target="_blank" rel="noopener noreferrer">Dashboard Render</a>
                                    <a id="renderServiceLink" class="account-link" href="https://mirador-admin.onrender.com" target="_blank" rel="noopener noreferrer">Abrir Admin</a>
                                </div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card primary">
                                    <div class="stat-header">
                                        <span class="stat-trend">Status</span>
                                    </div>
                                    <div class="stat-value" id="renderStatus">Online</div>
                                    <div class="stat-label">Servidor ativo</div>
                                </div>
                                <div class="stat-card success">
                                    <div class="stat-header">
                                        <span class="stat-trend">Plano</span>
                                    </div>
                                    <div class="stat-value">Free</div>
                                    <div class="stat-label">Hospedagem</div>
                                </div>
                                <div class="stat-card info">
                                    <div class="stat-header">
                                        <span class="stat-trend">Dominio</span>
                                    </div>
                                    <div class="stat-value" style="font-size: 0.875rem;">mirador-admin.onrender.com</div>
                                    <div class="stat-label">Entrada principal</div>
                                </div>
                            </div>
                            <div class="account-meta">
                                <strong>Uso:</strong> App web do painel admin.<br>
                                <strong>Observacao:</strong> Apenas host da aplicacao, sem armazenamento de arquivos.
                            </div>
                        </section>

                        <!-- Cloudflare -->
                        <section class="content-section account-block account-cloudflare">
                            <div class="account-head">
                                <div class="account-brand">
                                    <span class="account-badge">Cloudflare</span>
                                    <h2 class="account-title">R2 + Worker de upload</h2>
                                    <p class="account-description">Storage de midia no Cloudflare R2.</p>
                                </div>
                                <div class="account-links">
                                    <a id="cloudflareDashboardLink" class="account-link" href="https://dash.cloudflare.com" target="_blank" rel="noopener noreferrer">Dashboard Cloudflare</a>
                                    <a id="cloudflarePublicLink" class="account-link" href="https://pub-5b94009c2499437d9f5b2fb46285265a.r2.dev" target="_blank" rel="noopener noreferrer">Abrir Bucket Publico</a>
                                    <a id="cloudflareWorkerLink" class="account-link" href="https://mirador-r2.sitemirador2026.workers.dev/api/status" target="_blank" rel="noopener noreferrer">Status do Worker</a>
                                </div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card primary">
                                    <div class="stat-header">
                                        <span class="stat-trend">Storage</span>
                                    </div>
                                    <div class="stat-value" id="r2StorageSize">--</div>
                                    <div class="stat-label">Armazenamento usado</div>
                                </div>
                                <div class="stat-card success">
                                    <div class="stat-header">
                                        <span class="stat-trend">Arquivos</span>
                                    </div>
                                    <div class="stat-value" id="r2FileCount">--</div>
                                    <div class="stat-label">Total de arquivos</div>
                                </div>
                                <div class="stat-card warning">
                                    <div class="stat-header">
                                        <span class="stat-trend">Custo</span>
                                    </div>
                                    <div class="stat-value" id="r2Cost">R$ 0,00</div>
                                    <div class="stat-label">Estimativa mensal</div>
                                </div>
                                <div class="stat-card info">
                                    <div class="stat-header">
                                        <span class="stat-trend">Free tier</span>
                                    </div>
                                    <div class="stat-value">10 GB</div>
                                    <div class="stat-label">Limite gratuito</div>
                                </div>
                            </div>
                            <div class="account-progress-wrap">
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                    Uso do storage: <strong id="r2StoragePercent">0%</strong>
                                </div>
                                <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                    <div id="r2StorageBar" style="width: 0%; height: 100%; background: var(--primary); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div class="account-meta">
                                <div><strong>Bucket:</strong> <span id="r2BucketName">mirador-regiao-online</span></div>
                                <div><strong>Endpoint:</strong> <span id="r2EndpointHost">8341826f08014d0252c400798d657729.r2.cloudflarestorage.com</span></div>
                                <div><strong>Excedente apos 10 GB:</strong> <span id="r2OverageRate">--</span></div>
                                <div><strong>Funcao:</strong> Midia do site (imagens e videos)</div>
                                <div style="margin-top: 0.75rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="testR2Connection()">Verificar conexao backend</button>
                                </div>
                            </div>
                        </section>

                        <!-- Firebase -->
                        <section id="firebaseStorageSection" class="content-section account-block account-firebase">
                            <div class="account-head">
                                <div class="account-brand">
                                    <span class="account-badge">Firebase</span>
                                    <h2 class="account-title">Auth + Firestore textual</h2>
                                    <p class="account-description">Conta usada para login admin e dados textuais das noticias.</p>
                                </div>
                                <div class="account-links">
                                    <a id="firebaseConsoleDataLink" class="account-link" href="#" target="_blank" rel="noopener noreferrer">Firestore dados</a>
                                    <a id="firebaseConsoleAuthLink" class="account-link" href="#" target="_blank" rel="noopener noreferrer">Usuarios Auth</a>
                                    <a id="firebaseConsoleUsageLink" class="account-link" href="#" target="_blank" rel="noopener noreferrer">Uso Firestore</a>
                                </div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card primary">
                                    <div class="stat-header">
                                        <span class="stat-trend">Firestore</span>
                                    </div>
                                    <div class="stat-value" id="firestoreSize">--</div>
                                    <div class="stat-label">Dados textuais</div>
                                </div>
                                <div class="stat-card success">
                                    <div class="stat-header">
                                        <span class="stat-trend">Noticias</span>
                                    </div>
                                    <div class="stat-value" id="newsCount">--</div>
                                    <div class="stat-label">Publicadas</div>
                                </div>
                                <div class="stat-card warning">
                                    <div class="stat-header">
                                        <span class="stat-trend">Imagens legadas</span>
                                    </div>
                                    <div class="stat-value" id="imagesSize">--</div>
                                    <div class="stat-label">Base64 ou URL antiga</div>
                                </div>
                                <div class="stat-card info">
                                    <div class="stat-header">
                                        <span class="stat-trend">Plano</span>
                                    </div>
                                    <div class="stat-value">Spark</div>
                                    <div class="stat-label">Firestore gratuito</div>
                                </div>
                            </div>
                            <div id="firebaseSummaryAnchor" style="margin: 0 1.5rem 1rem;"></div>
                            <div class="account-meta">
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem; font-weight: 600;">
                                    Detalhes das colecoes (estimativa)
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
                                    <div><strong>News:</strong> <span id="newsCollectionSize">--</span></div>
                                    <div><strong>Stories:</strong> <span id="storiesCollectionSize">--</span></div>
                                    <div><strong>Settings:</strong> <span id="settingsCollectionSize">--</span></div>
                                </div>
                            </div>
                            <div class="account-progress-wrap">
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                    Distribuicao por colecao
                                </div>
                                <div style="display: grid; gap: 0.75rem;">
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8125rem; margin-bottom: 0.35rem;">
                                            <span>News</span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                            <div id="newsProgressBar" style="width: 0%; height: 100%; background: var(--primary); transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8125rem; margin-bottom: 0.35rem;">
                                            <span>Stories</span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                            <div id="storiesProgressBar" style="width: 0%; height: 100%; background: var(--success); transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8125rem; margin-bottom: 0.35rem;">
                                            <span>Settings</span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                            <div id="settingsProgressBar" style="width: 0%; height: 100%; background: var(--warning); transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="account-meta">
                                <div><strong>Projeto:</strong> sitemirador-fb33d</div>
                                <div><strong>Auth:</strong> ativo para login admin</div>
                                <div><strong>Funcao:</strong> textos das noticias e configuracoes do site</div>
                            </div>
                        </section>
                    </div>

                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="page-content" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Configuracoes</h1>
                            <p class="page-subtitle">Personalize a aparencia do seu site de noticias</p>
                        </div>
                    </div>

                    <div class="content-section" style="max-width: 900px;">
                        <div class="section-header">
                            <h2 class="section-title"> Identidade Visual</h2>
                            <div class="section-actions">
                                <button class="btn btn-secondary btn-sm" onclick="resetBrand()">Restaurar Padrao</button>
                                <button class="btn btn-primary btn-sm" onclick="saveBrand()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Salvar Identidade
                                </button>
                            </div>
                        </div>

                        <div style="padding: 2rem;">
                            <!-- Logo Upload -->
                            <div class="logo-upload-section">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--text-primary);">
                                    Logomarca do Site
                                </h3>
                                
                                <div class="logo-upload-wrapper">
                                    <!-- Upload Area -->
                                    <div class="logo-upload-area" id="logoUploadArea" onclick="document.getElementById('logoInput').click()">
                                        <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                        <div id="uploadPlaceholder">
                                            <svg class="logo-upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <div class="logo-upload-text">Clique ou arraste uma imagem aqui</div>
                                            <div class="logo-upload-hint">PNG, JPG ou SVG (max. 2MB)</div>
                                        </div>
                                        <div id="uploadChangePlaceholder" class="logo-upload-change" style="display: none;">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <div class="logo-upload-change-text">Alterar Logo</div>
                                            <div class="logo-upload-change-hint">Clique para trocar</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview Container -->
                                    <div id="logoPreviewContainer" class="logo-preview-container" style="display: none;">
                                        <div class="logo-preview-box">
                                            <div class="logo-preview-dark">
                                                <img id="logoPreviewDark" src="" alt="Logo Preview">
                                            </div>
                                            <div class="logo-preview-label">Fundo Escuro (Sidebar)</div>
                                        </div>
                                        <div class="logo-preview-box">
                                            <div class="logo-preview-light">
                                                <img id="logoPreviewLight" src="" alt="Logo Preview">
                                            </div>
                                            <div class="logo-preview-label">Fundo Claro (Site)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Brand Name Inputs -->
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--text-primary);">
                                    Informacoes da Marca
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem;">
                                    <div class="brand-input-group">
                                        <label for="siteName">Nome do Site</label>
                                        <input type="text" id="siteName" class="brand-input" placeholder="Mirador Online" value="Mirador Online">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="siteTagline">Tagline / Subtitulo</label>
                                        <input type="text" id="siteTagline" class="brand-input" placeholder="Portal de Noticias" value="Portal de Noticias">
                                    </div>
                                </div>
                            </div>

                            <!-- Preview da Marca -->
                            <div style="margin-top: 2rem; padding: 1.5rem; background: var(--bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--border);">
                                <h3 style="font-size: 0.9375rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">
                                     Pre-visualizacao da Marca
                                </h3>
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <!-- Preview Sidebar -->
                                    <div id="brandPreviewContainer" style="padding: 1.25rem; background: var(--bg-sidebar); border-radius: var(--radius); display: flex; align-items: center; gap: 0.875rem;">
                                        <!-- Modo sem logo -->
                                        <div id="brandPreviewIconMode" style="display: flex; align-items: center; gap: 0.875rem;">
                                            <div id="brandPreviewIcon" style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; color: white;">M</div>
                                            <div>
                                                <div id="brandPreviewName" style="font-family: 'Playfair Display', serif; font-size: 1.125rem; font-weight: 700; color: white; letter-spacing: -0.02em;">Mirador Online</div>
                                                <div id="brandPreviewTagline" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.125rem;">Portal de Noticias</div>
                                            </div>
                                        </div>
                                        <!-- Modo com logo -->
                                        <div id="brandPreviewLogoMode" style="display: none; flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                                            <img id="brandPreviewLogo" class="sidebar-brand-logo-full" src="" alt="" style="max-width: 180px; max-height: 55px; object-fit: contain;">
                                            <div id="brandPreviewLogoTagline" style="font-size: 0.75rem; color: var(--text-muted);">Portal de Noticias</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            </div>
                    </div>

                    <!-- CONFIGURAÃ‡ÃƒO DE LINKS DO RODAPE -->
                    <div class="content-section" style="max-width: 900px; margin-top: 2rem;">
                        <div class="section-header">
                            <h2 class="section-title"> Links do Rodape</h2>
                            <div class="section-actions">
                                <button class="btn btn-secondary btn-sm" onclick="resetFooterLinks()">Restaurar Padrao</button>
                                <button class="btn btn-primary btn-sm" onclick="saveFooterLinks()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Salvar Links
                                </button>
                            </div>
                        </div>

                        <div style="padding: 2rem;">
                            <!-- Links de Navegacao -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--text-primary);">
                                    Paginas Institucionais
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem;">
                                    <div class="brand-input-group" style="grid-column: 1 / -1;">
                                        <label for="footerAboutText">Sobre Nos (texto completo para leitura)</label>
                                        <textarea id="footerAboutText" class="brand-input" rows="4" placeholder="Conte aqui a historia do portal, como iniciou e a missao editorial..."></textarea>
                                    </div>
                                    <div class="brand-input-group" style="grid-column: 1 / -1;">
                                        <label for="footerContactText">Contato exibido no rodape (texto)</label>
                                        <input type="text" id="footerContactText" class="brand-input" placeholder="Ex: Redacao Mirador e Regiao Online">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="footerContactPhone">Telefone / WhatsApp exibido no rodape</label>
                                        <input type="text" id="footerContactPhone" class="brand-input" placeholder="(99) 99999-9999">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="footerContactEmail">Gmail de contato</label>
                                        <input type="email" id="footerContactEmail" class="brand-input" placeholder="seuportal@gmail.com">
                                    </div>
                                    <div class="brand-input-group" style="grid-column: 1 / -1;">
                                        <label for="footerPrivacyText">Politica de Privacidade (texto para leitura)</label>
                                        <textarea id="footerPrivacyText" class="brand-input" rows="4" placeholder="Explique como os dados dos usuarios sao tratados no portal..."></textarea>
                                    </div>
                                    <div class="brand-input-group" style="grid-column: 1 / -1; margin-top: -0.25rem;">
                                        <label style="margin-bottom: 0.35rem;">Termos de Uso</label>
                                        <p style="font-size: 0.8125rem; color: var(--text-muted); margin: 0;">
                                            Os termos de uso sao gerados automaticamente pelo sistema e ficam disponiveis para leitura no rodape do site.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Redes Sociais -->
                            <div>
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--text-primary);">
                                    Redes Sociais
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem;">
                                    <div class="brand-input-group">
                                        <label for="footerSocialInstagram">
                                            <svg width="16" height="16" style="vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37zm1.5-4.87h.01M7.5 3h9a4.5 4.5 0 014.5 4.5v9a4.5 4.5 0 01-4.5 4.5h-9A4.5 4.5 0 013 16.5v-9A4.5 4.5 0 017.5 3z"/>
                                            </svg>
                                            Instagram
                                        </label>
                                        <input type="url" id="footerSocialInstagram" class="brand-input" placeholder="https://instagram.com/...">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="footerSocialFacebook">
                                            <svg width="16" height="16" style="vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/>
                                            </svg>
                                            Facebook
                                        </label>
                                        <input type="url" id="footerSocialFacebook" class="brand-input" placeholder="https://facebook.com/...">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="footerSocialTwitter">
                                            <svg width="16" height="16" style="vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"/>
                                            </svg>
                                            Twitter / X
                                        </label>
                                        <input type="url" id="footerSocialTwitter" class="brand-input" placeholder="https://twitter.com/...">
                                    </div>
                                    <div class="brand-input-group">
                                        <label for="footerSocialYoutube">
                                            <svg width="16" height="16" style="vertical-align: middle; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78 0 003.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 001.94-2 29 29 0 00.46-5.33 29 29 0 00-.46-5.33z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 15.02l5.75-3.27-5.75-3.27v6.54z"/>
                                            </svg>
                                            YouTube
                                        </label>
                                        <input type="url" id="footerSocialYoutube" class="brand-input" placeholder="https://youtube.com/...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERSONALIZAÃ‡ÃƒO DE CORES -->
                    <style>
                        .color-settings-grid {
                            display: grid;
                            grid-template-columns: 1fr 380px;
                            gap: 1.5rem;
                        }
                        @media (max-width: 1200px) {
                            .color-settings-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                        .color-picker-card {
                            background: var(--bg-card);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                            padding: 1.5rem;
                        }
                        .color-group {
                            margin-bottom: 1.5rem;
                        }
                        .color-group:last-child {
                            margin-bottom: 0;
                        }
                        .color-group-title {
                            font-size: 0.75rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                            color: var(--text-muted);
                            margin-bottom: 0.75rem;
                            padding-bottom: 0.5rem;
                            border-bottom: 1px solid var(--border-light);
                        }
                        .color-items {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            gap: 0.75rem;
                        }
                        .color-item {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                            padding: 0.5rem;
                            border-radius: var(--radius);
                            transition: background 0.2s;
                        }
                        .color-item:hover {
                            background: var(--bg-primary);
                        }
                        .color-item input[type="color"] {
                            width: 36px;
                            height: 36px;
                            border: 2px solid var(--border);
                            border-radius: var(--radius);
                            cursor: pointer;
                            padding: 0;
                            background: none;
                        }
                        .color-item input[type="color"]::-webkit-color-swatch-wrapper {
                            padding: 0;
                        }
                        .color-item input[type="color"]::-webkit-color-swatch {
                            border: none;
                            border-radius: 4px;
                        }
                        .color-item-info {
                            flex: 1;
                            min-width: 0;
                        }
                        .color-item-label {
                            font-size: 0.8125rem;
                            font-weight: 500;
                            color: var(--text-primary);
                            margin-bottom: 0.125rem;
                        }
                        .color-item-value {
                            font-size: 0.6875rem;
                            font-family: monospace;
                            color: var(--text-muted);
                            text-transform: uppercase;
                        }
                        .preview-card {
                            background: var(--bg-card);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                            overflow: hidden;
                            position: sticky;
                            top: 90px;
                        }
                        .preview-header {
                            padding: 1rem 1.25rem;
                            background: var(--bg-primary);
                            border-bottom: 1px solid var(--border);
                        }
                        .preview-title {
                            font-size: 0.875rem;
                            font-weight: 600;
                            color: var(--text-primary);
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }
                        .preview-content {
                            padding: 0;
                        }
                        .site-mockup {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        }
                        .mockup-header {
                            padding: 1rem 1.25rem;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            border-bottom: 1px solid var(--border);
                        }
                        .mockup-logo {
                            font-weight: 700;
                            font-size: 1.125rem;
                        }
                        .mockup-nav {
                            display: flex;
                            gap: 1rem;
                            font-size: 0.8125rem;
                        }
                        .mockup-nav span {
                            cursor: pointer;
                        }
                        .mockup-body {
                            padding: 1.25rem;
                        }
                        .mockup-section-title {
                            font-size: 1.25rem;
                            font-weight: 700;
                            margin-bottom: 1rem;
                        }
                        .mockup-card {
                            padding: 1rem;
                            border-radius: var(--radius);
                            margin-bottom: 0.75rem;
                        }
                        .mockup-card-title {
                            font-weight: 600;
                            margin-bottom: 0.375rem;
                            font-size: 0.9375rem;
                        }
                        .mockup-card-text {
                            font-size: 0.8125rem;
                            line-height: 1.5;
                        }
                        .mockup-button {
                            display: inline-block;
                            padding: 0.5rem 1rem;
                            border-radius: var(--radius);
                            font-size: 0.8125rem;
                            font-weight: 500;
                            margin-top: 0.5rem;
                        }
                    </style>

                    <div class="content-section" style="max-width: 1200px; margin-top: 1.5rem;">
                        <div class="section-header">
                            <h2 class="section-title"> Personalizacao de Cores</h2>
                            <div class="section-actions">
                                <button class="btn btn-secondary btn-sm" onclick="resetColors()">Restaurar Padrao</button>
                                <button class="btn btn-primary btn-sm" onclick="saveColors()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Salvar Alteracoes
                                </button>
                            </div>
                        </div>

                        <div style="padding: 1.5rem;">
                            <div class="color-settings-grid">
                                <!-- LADO ESQUERDO: Seletores de Cor -->
                                <div class="color-picker-card">
                                    <!-- Cores Principais -->
                                    <div class="color-group">
                                        <div class="color-group-title">Cores Principais</div>
                                        <div class="color-items">
                                            <div class="color-item">
                                                <input type="color" id="colorPrimary" value="#2563eb">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Primaria</div>
                                                    <div class="color-item-value" id="colorPrimaryValue">#2563EB</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorSecondary" value="#64748b">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Secundaria</div>
                                                    <div class="color-item-value" id="colorSecondaryValue">#64748B</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorAccent" value="#f8fafc">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Destaque</div>
                                                    <div class="color-item-value" id="colorAccentValue">#F8FAFC</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cores de Fundo -->
                                    <div class="color-group">
                                        <div class="color-group-title">Cores de Fundo</div>
                                        <div class="color-items">
                                            <div class="color-item">
                                                <input type="color" id="colorBackground" value="#ffffff">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Pagina</div>
                                                    <div class="color-item-value" id="colorBackgroundValue">#FFFFFF</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorMuted" value="#f1f5f9">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Cards</div>
                                                    <div class="color-item-value" id="colorMutedValue">#F1F5F9</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorHeader" value="#ffffff">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Cabecalho</div>
                                                    <div class="color-item-value" id="colorHeaderValue">#FFFFFF</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorHeaderText" value="#0f172a">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Texto do Cabecalho</div>
                                                    <div class="color-item-value" id="colorHeaderTextValue">#0F172A</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cores de Texto -->
                                    <div class="color-group">
                                        <div class="color-group-title">Cores de Texto</div>
                                        <div class="color-items">
                                            <div class="color-item">
                                                <input type="color" id="colorForeground" value="#0f172a">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Principal</div>
                                                    <div class="color-item-value" id="colorForegroundValue">#0F172A</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorMutedForeground" value="#64748b">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Secundario</div>
                                                    <div class="color-item-value" id="colorMutedForegroundValue">#64748B</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cor dos Cards -->
                                    <div class="color-group">
                                        <div class="color-group-title">Cards de Noticias</div>
                                        <div class="color-items">
                                            <div class="color-item">
                                                <input type="color" id="colorCard" value="#ffffff">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Fundo do Card</div>
                                                    <div class="color-item-value" id="colorCardValue">#FFFFFF</div>
                                                </div>
                                            </div>
                                            <div class="color-item">
                                                <input type="color" id="colorFooterText" value="#64748b">
                                                <div class="color-item-info">
                                                    <div class="color-item-label">Texto do Rodape</div>
                                                    <div class="color-item-value" id="colorFooterTextValue">#64748B</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="color-group">
                                        <div class="color-group-title">Subcabecalho (barra acima do cabecalho)</div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                                            <div class="brand-input-group" style="margin-bottom: 0;">
                                                <label for="topStripTitleText">Nome principal no subcabecalho</label>
                                                <input type="text" id="topStripTitleText" class="brand-input" placeholder="Mirador e Regiao Online" value="Mirador e Regiao Online">
                                            </div>
                                            <div class="brand-input-group" style="margin-bottom: 0;">
                                                <label for="topStripSubtitleText">Texto secundario no subcabecalho</label>
                                                <input type="text" id="topStripSubtitleText" class="brand-input" placeholder="Portal de Noticias" value="Portal de Noticias">
                                            </div>
                                            <div class="brand-input-group" style="margin-bottom: 0;">
                                                <label for="topStripBgColor">Cor da barra do subcabecalho</label>
                                                <input type="color" id="topStripBgColor" class="brand-input brand-color-input" value="#2a0f33">
                                            </div>
                                            <div class="brand-input-group" style="margin-bottom: 0;">
                                                <label for="topStripTextColor">Cor do texto do subcabecalho</label>
                                                <input type="color" id="topStripTextColor" class="brand-input brand-color-input" value="#ffffff">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- LADO DIREITO: Preview em Tempo Real -->
                                <div class="preview-card">
                                    <div class="preview-header">
                                        <div class="preview-title">
                                             Preview ao vivo
                                        </div>
                                    </div>
                                    <div class="preview-content">
                                        <div class="site-mockup" id="livePreview">
                                            <div class="mockup-header" id="previewHeader">
                                                <div class="mockup-logo" id="previewLogo">Mirador Online</div>
                                                <div class="mockup-nav" id="previewNav">
                                                    <span>Inicio</span>
                                                    <span>Noticias</span>
                                                    <span>Sobre</span>
                                                </div>
                                            </div>
                                            <div class="mockup-body" id="previewBody">
                                                <div class="mockup-section-title" id="previewTitle">Destaques</div>
                                                <div class="mockup-card" id="previewCard">
                                                    <div class="mockup-card-title" id="previewCardTitle">Titulo da Noticia</div>
                                                    <div class="mockup-card-text" id="previewCardText">Este e um exemplo de como o texto ficara no site com as cores selecionadas.</div>
                                                    <div class="mockup-button" id="previewButton">Ler mais</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            </div>
                    </div>

                    <!-- CONFIGURAÃ‡ÃƒO DE LAYOUT DOS CARDS -->
                    <style>
                        .layout-input-group {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            margin-bottom: 1.5rem;
                        }
                        .layout-input-group label {
                            font-weight: 500;
                            color: var(--text-primary);
                            min-width: 200px;
                        }
                        .layout-input-wrapper {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }
                        .layout-input {
                            width: 80px;
                            padding: 0.5rem 0.75rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            font-size: 1rem;
                            text-align: center;
                        }
                        .layout-input:focus {
                            outline: none;
                            border-color: var(--primary);
                        }
                        .layout-unit {
                            color: var(--text-muted);
                            font-size: 0.875rem;
                        }
                        .layout-preview-grid {
                            display: grid;
                            gap: 0.75rem;
                            margin-top: 1.5rem;
                            padding: 1.5rem;
                            background: var(--bg-primary);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                        }
                        .layout-preview-card {
                            background: var(--bg-tertiary);
                            border-radius: var(--radius);
                            height: 80px;
                        }

                        .banner-settings-grid {
                            display: grid;
                            grid-template-columns: repeat(2, minmax(0, 1fr));
                            gap: 1rem;
                        }

                        .top-banner-controls {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            gap: 1rem;
                            margin-bottom: 1rem;
                            flex-wrap: wrap;
                        }

                        .layout-select {
                            min-width: 110px;
                            padding: 0.5rem 0.75rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--bg-card);
                            color: var(--text-primary);
                            font-size: 0.875rem;
                        }

                        .top-banners-mobile-controls {
                            gap: 0.5rem;
                            flex-wrap: wrap;
                        }

                        .banner-slot-card {
                            border: 1px solid var(--border);
                            border-radius: var(--radius-lg);
                            background: var(--bg-primary);
                            padding: 1rem;
                            display: grid;
                            gap: 0.875rem;
                        }

                        .banner-slot-head {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            gap: 0.75rem;
                        }

                        .banner-slot-title {
                            font-size: 0.9375rem;
                            font-weight: 700;
                            color: var(--text-primary);
                        }

                        .banner-slot-dim {
                            font-size: 0.75rem;
                            color: var(--text-muted);
                            font-weight: 500;
                        }

                        .banner-slot-head-actions {
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                        }

                        .banner-remove-slot-btn {
                            border: 1px solid #fecaca;
                            color: #dc2626;
                            background: #fff1f2;
                            border-radius: 999px;
                            padding: 0.18rem 0.55rem;
                            font-size: 0.72rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: var(--transition);
                        }

                        .banner-remove-slot-btn:hover {
                            background: #ffe4e6;
                            border-color: #fca5a5;
                        }

                        .banner-field {
                            display: grid;
                            gap: 0.4rem;
                        }

                        .banner-field label {
                            font-size: 0.8125rem;
                            font-weight: 600;
                            color: var(--text-secondary);
                        }

                        .banner-field input,
                        .banner-field select {
                            width: 100%;
                            padding: 0.6rem 0.75rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--bg-card);
                            color: var(--text-primary);
                            font-size: 0.875rem;
                        }

                        .banner-upload-dropzone {
                            border: 2px dashed var(--border);
                            border-radius: var(--radius);
                            background: var(--bg-card);
                            padding: 0.9rem;
                            text-align: center;
                            cursor: pointer;
                            transition: var(--transition);
                        }

                        .banner-upload-dropzone:hover {
                            border-color: var(--primary-light);
                            background: var(--info-light);
                        }

                        .banner-upload-dropzone p {
                            margin: 0;
                            font-size: 0.8125rem;
                            color: var(--text-secondary);
                        }

                        .banner-upload-dropzone small {
                            display: block;
                            margin-top: 0.25rem;
                            color: var(--text-muted);
                            font-size: 0.75rem;
                        }

                        .banner-upload-status {
                            font-size: 0.75rem;
                            color: var(--text-muted);
                            min-height: 1rem;
                        }

                        .banner-preview-box {
                            width: 100%;
                            aspect-ratio: 1080 / 200;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            overflow: hidden;
                            background: #e5e7eb;
                            position: relative;
                        }

                        .banner-preview-box img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            display: block;
                        }

                        .banner-preview-empty {
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.75rem;
                            color: var(--text-muted);
                            background: repeating-linear-gradient(
                                -45deg,
                                #eef2f7 0,
                                #eef2f7 10px,
                                #f7f9fc 10px,
                                #f7f9fc 20px
                            );
                        }

                        .banner-media-list {
                            display: grid;
                            gap: 0.5rem;
                            max-height: 180px;
                            overflow-y: auto;
                        }

                        .banner-media-item {
                            display: grid;
                            grid-template-columns: 40px 1fr auto;
                            align-items: center;
                            gap: 0.5rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            background: var(--bg-card);
                            padding: 0.4rem;
                        }

                        .banner-media-thumb {
                            width: 40px;
                            height: 40px;
                            border-radius: 6px;
                            overflow: hidden;
                            border: 1px solid var(--border);
                            background: #e2e8f0;
                        }

                        .banner-media-thumb img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            display: block;
                        }

                        .banner-media-name {
                            font-size: 0.75rem;
                            color: var(--text-secondary);
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }

                        .banner-media-actions {
                            display: flex;
                            gap: 0.25rem;
                        }

                        .banner-mini-btn {
                            width: 28px;
                            height: 28px;
                            border-radius: 6px;
                            border: 1px solid var(--border);
                            background: var(--bg-card);
                            color: var(--text-secondary);
                            cursor: pointer;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.875rem;
                            transition: var(--transition);
                        }

                        .banner-mini-btn:hover {
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                        }

                        .banner-mini-btn.danger {
                            border-color: #fecaca;
                            color: #dc2626;
                        }

                        .banner-mini-btn.danger:hover {
                            background: #fee2e2;
                            border-color: #fca5a5;
                        }

                        .banner-slots-empty {
                            border: 1px dashed var(--border);
                            border-radius: var(--radius-lg);
                            background: var(--bg-card);
                            color: var(--text-muted);
                            font-size: 0.875rem;
                            text-align: center;
                            padding: 1.25rem;
                        }

                        @media (max-width: 1100px) {
                            .banner-settings-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>

                    <div class="content-section" style="max-width: 600px; margin-top: 1.5rem;">
                        <div class="section-header">
                            <h2 class="section-title"> Layout dos Cards</h2>
                            <div class="section-actions">
                                <button class="btn btn-primary btn-sm" onclick="saveLayout()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Salvar Layout
                                </button>
                            </div>
                        </div>

                        <div style="padding: 1.5rem;">
                            <div class="layout-input-group">
                                <label for="cardsPerRow">Cards por linha:</label>
                                <div class="layout-input-wrapper">
                                    <input type="number" id="cardsPerRow" class="layout-input" value="3" min="1" max="6" onchange="updateLayoutPreview()">
                                    <span class="layout-unit">cards</span>
                                </div>
                            </div>

                            <div class="layout-input-group">
                                <label for="instagramPostsVisible">Posts visiveis do Instagram:</label>
                                <div class="layout-input-wrapper">
                                    <input type="number" id="instagramPostsVisible" class="layout-input" value="4" min="1" max="12" onchange="updateLayoutPreview()">
                                    <span class="layout-unit">posts</span>
                                </div>
                            </div>

                            <div id="layoutPreviewGrid" class="layout-preview-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="layout-preview-card"></div>
                                <div class="layout-preview-card"></div>
                                <div class="layout-preview-card"></div>
                            </div>
                        </div>
                    </div>

                    <div class="content-section" style="max-width: 1100px; margin-top: 1.5rem;">
                        <div class="section-header">
                            <h2 class="section-title"> Banners entre Cabecalho e Instagram</h2>
                            <div class="section-actions">
                                <button class="btn btn-secondary btn-sm" onclick="resetTopBannersSettings()">Limpar Banners</button>
                                <button class="btn btn-primary btn-sm" onclick="saveTopBannersSettings()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Salvar Banners
                                </button>
                            </div>
                        </div>

                        <div style="padding: 1.5rem;">
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Esta area controla os banners exibidos no site entre o cabecalho e a secao Instagram (proporcao 1080 x 200).
                            </p>

                            <div class="top-banner-controls">
                                <div class="layout-input-group" style="margin-bottom: 0;">
                                    <label for="topBannersDisplayCount">Quantidade exibida no site:</label>
                                    <div class="layout-input-wrapper">
                                        <input type="number" id="topBannersDisplayCount" class="layout-input" value="2" min="1" max="20" onchange="handleTopBannersDisplayCountChange()">
                                        <span class="layout-unit">banners</span>
                                    </div>
                                </div>
                                <div class="layout-input-group" style="margin-bottom: 0;">
                                    <label for="topBannersMobileTransition">Celular (banner unico):</label>
                                    <div class="layout-input-wrapper top-banners-mobile-controls">
                                        <select id="topBannersMobileTransition" class="layout-select" onchange="handleTopBannersMobileSettingsChange()">
                                            <option value="fade">Fade</option>
                                            <option value="slide">Slide</option>
                                            <option value="zoom">Zoom</option>
                                        </select>
                                        <input type="number" id="topBannersMobileInterval" class="layout-input" value="3" min="1" max="30" onchange="handleTopBannersMobileSettingsChange()">
                                        <span class="layout-unit">segundos</span>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addTopBannerSlot()">
                                    + Adicionar banner
                                </button>
                            </div>

                            <div class="banner-settings-grid" id="topBannersSlotsContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- IMPORTAR NOTÃCIA PAGE -->
                <div id="importNewsPage" class="page-content" style="display: none;">
                    <style>
                        .import-container {
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        .import-url-box {
                            background: var(--bg-card);
                            border: 2px dashed var(--border);
                            border-radius: var(--radius-lg);
                            padding: 2rem;
                            text-align: center;
                            transition: var(--transition);
                        }
                        .import-url-box:focus-within {
                            border-color: var(--primary-light);
                            background: var(--info-light);
                        }
                        .import-url-icon {
                            width: 64px;
                            height: 64px;
                            margin: 0 auto 1rem;
                            color: var(--primary);
                        }
                        .import-url-input {
                            width: 100%;
                            max-width: 500px;
                            padding: 0.875rem 1rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            font-size: 1rem;
                            margin: 1rem 0;
                            transition: var(--transition);
                        }
                        .import-url-input:focus {
                            outline: none;
                            border-color: var(--primary-light);
                            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                        }
                        .import-preview-card {
                            background: var(--bg-card);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                            overflow: hidden;
                            margin-top: 2rem;
                        }
                        .import-preview-header {
                            padding: 1rem 1.5rem;
                            border-bottom: 1px solid var(--border);
                            background: var(--bg-primary);
                        }
                        .import-preview-title {
                            font-size: 1rem;
                            font-weight: 600;
                            color: var(--text-primary);
                        }
                        .import-preview-body {
                            padding: 1.5rem;
                        }
                        .import-preview-image {
                            width: 100%;
                            height: 200px;
                            object-fit: cover;
                            border-radius: var(--radius);
                            margin-bottom: 1rem;
                        }
                        .import-preview-text {
                            font-size: 0.9375rem;
                            color: var(--text-secondary);
                            line-height: 1.6;
                        }
                        .import-source-badge {
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            padding: 0.375rem 0.75rem;
                            background: var(--bg-secondary);
                            border-radius: var(--radius);
                            font-size: 0.8125rem;
                            color: var(--text-secondary);
                        }
                        .import-source-badge img {
                            width: 16px;
                            height: 16px;
                            border-radius: 3px;
                        }
                        .import-loading {
                            display: none;
                            text-align: center;
                            padding: 2rem;
                        }
                        .import-loading.active {
                            display: block;
                        }
                        .import-spinner {
                            width: 40px;
                            height: 40px;
                            border: 3px solid var(--border);
                            border-top-color: var(--primary);
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 1rem;
                        }
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    </style>

                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Importar Noticia</h1>
                            <p class="page-subtitle">Area padronizada para importar noticias e ver publicacoes importadas</p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <button class="btn btn-tab active" id="tabImportNewsPublicacoes" onclick="switchImportNewsTab('publicacoes')" style="background: transparent; border: none; border-bottom: 2px solid var(--primary); padding: 0.75rem 1.25rem; color: var(--primary); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8"/>
                            </svg>
                            Publicações
                        </button>
                        <button class="btn btn-tab" id="tabImportNewsImportar" onclick="switchImportNewsTab('importar')" style="background: transparent; border: none; border-bottom: 2px solid transparent; padding: 0.75rem 1.25rem; color: var(--text-muted); font-weight: 500;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            Importar Notícias
                        </button>
                    </div>

                    <div id="importNewsPublicacoesTab" class="import-news-tab-content">
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Notícias Importadas por URL</h2>
                                <div class="section-actions" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span id="importedNewsCount" style="font-size: 0.8125rem; color: var(--text-muted);">0 noticia(s)</span>
                                    <button class="btn btn-secondary btn-sm" onclick="loadImportedNewsPage()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0A8.003 8.003 0 015.582 15m13.837 0H15"/>
                                        </svg>
                                        Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table news-table">
                                    <colgroup>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                        <col>
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>Capa</th>
                                            <th>Titulo</th>
                                            <th>Categoria</th>
                                            <th>Data</th>
                                            <th>Acoes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="importedNewsList">
                                        <!-- Noticias importadas por URL serao carregadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="importNewsImportarTab" class="import-news-tab-content" style="display: none;">
                        <div class="import-container">
                            <div class="import-url-box">
                                <svg class="import-url-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Cole o link da noticia</h3>
                                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">Suporta: G1, Globo, UOL, Estadao, Folha e outros sites de noticias</p>
                                <input type="url" id="importUrlInput" class="import-url-input" placeholder="https://g1.globo.com/..." onpaste="handleImportUrlPaste(event)">
                                <div style="display: flex; gap: 0.75rem; justify-content: center;">
                                    <button class="btn btn-secondary" onclick="clearImportUrl()">
                                        Limpar
                                    </button>
                                    <button class="btn btn-primary" onclick="fetchNewsFromUrl()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                        </svg>
                                        Importar Noticia
                                    </button>
                                </div>
                            </div>

                            <div class="import-loading" id="importLoading">
                                <div class="import-spinner"></div>
                                <p style="color: var(--text-secondary);">Buscando informacoes da noticia...</p>
                            </div>

                            <div id="importPreview" class="import-preview-card" style="display: none;">
                                <div class="import-preview-header">
                                    <div class="import-preview-title">Pre-visualizacao</div>
                                    <span id="editHint" style="font-size: 0.75rem; color: var(--primary); display: none;">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                        </svg>
                                        Clique no titulo ou descricao para editar
                                    </span>
                                </div>
                                <div class="import-preview-body">
                                    <img id="importPreviewImage" class="import-preview-image" src="" alt="">
                                    <h2 id="importPreviewTitle" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); border: 1px solid transparent; padding: 4px; border-radius: 4px; transition: all 0.2s;"></h2>
                                    <p id="importPreviewExcerpt" class="import-preview-text" style="margin-bottom: 1rem; border: 1px solid transparent; padding: 4px; border-radius: 4px; transition: all 0.2s;"></p>
                                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                        <span id="importPreviewSource" class="import-source-badge">
                                            <img id="importPreviewSourceLogo" src="" alt="">
                                            <span id="importPreviewSourceName"></span>
                                        </span>
                                        <span style="font-size: 0.8125rem; color: var(--text-muted);">Detectado em: <span id="importPreviewDate"></span></span>
                                    </div>
                                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                                        <label class="form-label" style="margin-bottom: 0.5rem;">Categoria</label>
                                        <select id="importNewsCategory" class="form-select" style="margin-bottom: 1rem;">
                                            <option value="">Selecione uma categoria...</option>
                                            <option value="mirador">Mirador</option>
                                            <option value="regiao">Regiao</option>
                                            <option value="brasil">Brasil</option>
                                            <option value="policia">Policia</option>
                                            <option value="esportes">Esportes</option>
                                            <option value="politica">Politica</option>
                                            <option value="geral">Geral</option>
                                        </select>
                                        <div style="display: flex; gap: 0.75rem;">
                                            <button class="btn btn-secondary" onclick="cancelImport()">
                                                Cancelar
                                            </button>
                                            <button class="btn btn-primary" onclick="saveImportedNews()">
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Salvar Noticia
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CRIAR/EDITAR NOTÃCIA PAGE -->
                <div id="createNewsPage" class="page-content" style="display: none;">
                    <style>
                        .news-editor-container {
                            max-width: 1200px;
                        }
                        .news-editor-layout {
                            display: grid;
                            grid-template-columns: 1fr 320px;
                            gap: 1.5rem;
                        }
                        @media (max-width: 1024px) {
                            .news-editor-layout {
                                grid-template-columns: 1fr;
                            }
                        }
                        .editor-main {
                            background: var(--bg-card);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                            padding: 1.5rem;
                        }
                        .editor-sidebar {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }
                        .editor-sidebar-card {
                            background: var(--bg-card);
                            border-radius: var(--radius-lg);
                            border: 1px solid var(--border);
                            padding: 1rem;
                        }
                        .editor-sidebar-title {
                            font-size: 0.875rem;
                            font-weight: 600;
                            margin-bottom: 0.75rem;
                            color: var(--text-primary);
                        }
                        .form-group {
                            margin-bottom: 1.25rem;
                        }
                        .form-group:last-child {
                            margin-bottom: 0;
                        }
                        .form-label {
                            display: block;
                            font-size: 0.8125rem;
                            font-weight: 500;
                            color: var(--text-secondary);
                            margin-bottom: 0.375rem;
                        }
                        .form-input, .form-select, .form-textarea {
                            width: 100%;
                            padding: 0.625rem 0.875rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            font-size: 0.9375rem;
                            background: var(--bg-card);
                            color: var(--text-primary);
                            transition: var(--transition);
                        }
                        .form-input:focus, .form-select:focus, .form-textarea:focus {
                            outline: none;
                            border-color: var(--primary-light);
                            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                        }
                        .form-textarea {
                            resize: vertical;
                            min-height: 100px;
                        }
                        .rich-text-editor {
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            overflow: hidden;
                        }
                        .editor-toolbar {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.25rem;
                            padding: 0.5rem;
                            background: var(--bg-primary);
                            border-bottom: 1px solid var(--border);
                        }
                        .editor-toolbar button {
                            padding: 0.375rem 0.625rem;
                            background: transparent;
                            border: 1px solid transparent;
                            border-radius: var(--radius-sm);
                            cursor: pointer;
                            font-size: 0.875rem;
                            color: var(--text-secondary);
                            transition: all 0.2s;
                        }
                        .editor-toolbar button:hover {
                            background: var(--bg-secondary);
                            border-color: var(--border);
                            color: var(--text-primary);
                        }
                        .editor-content {
                            min-height: 400px;
                            padding: 1rem;
                            outline: none;
                            line-height: 1.8;
                        }
                        .editor-content:focus {
                            background: var(--bg-primary);
                        }
                        .editor-content p {
                            margin-bottom: 1rem;
                        }
                        .editor-content h2 {
                            font-size: 1.5rem;
                            font-weight: 600;
                            margin: 1.5rem 0 1rem;
                        }
                        .editor-content h3 {
                            font-size: 1.25rem;
                            font-weight: 600;
                            margin: 1.25rem 0 0.75rem;
                        }
                        .editor-content blockquote {
                            border-left: 4px solid var(--primary);
                            padding-left: 1rem;
                            margin: 1rem 0;
                            font-style: italic;
                            color: var(--text-secondary);
                        }
                        .editor-content ul, .editor-content ol {
                            margin: 1rem 0;
                            padding-left: 2rem;
                        }
                        .editor-content li {
                            margin-bottom: 0.5rem;
                        }
                        .featured-image-upload {
                            border: 2px dashed var(--border);
                            border-radius: var(--radius);
                            padding: 1.5rem;
                            text-align: center;
                            cursor: pointer;
                            transition: var(--transition);
                            background: var(--bg-primary);
                        }
                        .featured-image-upload:hover {
                            border-color: var(--primary-light);
                            background: var(--info-light);
                        }
                        .featured-image-preview {
                            max-width: 100%;
                            max-height: 200px;
                            border-radius: var(--radius);
                            margin-top: 0.5rem;
                        }
                        .status-radio {
                            display: flex;
                            gap: 0.75rem;
                        }
                        .status-radio label {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            padding: 0.5rem 0.75rem;
                            border: 1px solid var(--border);
                            border-radius: var(--radius);
                            cursor: pointer;
                            font-size: 0.875rem;
                            transition: var(--transition);
                        }
                        .status-radio input[type="radio"] {
                            display: none;
                        }
                        .status-radio input[type="radio"]:checked + span {
                            color: var(--primary);
                            font-weight: 500;
                        }
                        .status-radio label:has(input:checked) {
                            border-color: var(--primary);
                            background: var(--info-light);
                        }
                        .btn-full {
                            width: 100%;
                            justify-content: center;
                        }
                    </style>

                    <div class="news-editor-container">
                        <div class="page-header" style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="showPage('news', document.querySelectorAll('.nav-item')[1])">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    Voltar
                                </button>
                                <div>
                                    <h1 class="page-title" id="editorPageTitle">Nova Noticia</h1>
                                    <p class="page-subtitle">Escreva e publique sua noticia</p>
                                </div>
                            </div>
                        </div>

                        <div class="news-editor-layout">
                            <!-- MAIN EDITOR -->
                            <div class="editor-main">
                                <div class="form-group">
                                    <label class="form-label">Titulo da Noticia *</label>
                                    <input type="text" id="newsTitle" class="form-input" placeholder="Digite o titulo da noticia..." oninput="generateSlug()">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">URL Amigavel (Slug)</label>
                                    <input type="text" id="newsSlug" class="form-input" placeholder="url-da-noticia" style="font-family: monospace; font-size: 0.875rem;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Conteudo *</label>
                                    <div class="rich-text-editor">
                                        <div class="editor-toolbar">
                                            <button type="button" onclick="formatText('bold')" title="Negrito"><b>B</b></button>
                                            <button type="button" onclick="formatText('italic')" title="Italico"><i>I</i></button>
                                            <button type="button" onclick="formatText('underline')" title="Sublinhado"><u>U</u></button>
                                            <span style="width: 1px; height: 20px; background: var(--border); margin: 0 0.25rem;"></span>
                                            <button type="button" onclick="formatText('justifyLeft')" title="Alinhar Esquerda">Esq</button>
                                            <button type="button" onclick="formatText('justifyCenter')" title="Centralizar">Centro</button>
                                            <button type="button" onclick="formatText('justifyRight')" title="Alinhar Direita">Dir</button>
                                            <span style="width: 1px; height: 20px; background: var(--border); margin: 0 0.25rem;"></span>
                                            <button type="button" onclick="formatText('insertUnorderedList')" title="Lista">* Lista</button>
                                            <button type="button" onclick="formatText('insertOrderedList')" title="Lista Numerada">1. Lista</button>
                                            <span style="width: 1px; height: 20px; background: var(--border); margin: 0 0.25rem;"></span>
                                            <button type="button" onclick="formatText('formatBlock', 'H2')" title="Titulo">Titulo</button>
                                            <button type="button" onclick="formatText('formatBlock', 'H3')" title="Subtitulo">Sub</button>
                                            <button type="button" onclick="formatText('removeFormat')" title="Limpar Formatacao">x</button>
                                        </div>
                                        <div id="editorContent" class="editor-content" contenteditable="true" placeholder="Comece a escrever sua noticia aqui..."></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Resumo/Excerpt</label>
                                    <textarea id="newsExcerpt" class="form-textarea" placeholder="Um breve resumo da noticia (aparece na listagem)..." maxlength="300"></textarea>
                                    <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        <span id="excerptCount">0</span>/300 caracteres
                                    </div>
                                </div>
                            </div>

                            <!-- SIDEBAR -->
                            <div class="editor-sidebar">
                                <!-- Publicar -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Publicar</div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <div class="status-radio">
                                            <label>
                                                <input type="radio" name="newsStatus" value="published" checked>
                                                <span>Publicado</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="newsStatus" value="draft">
                                                <span>Rascunho</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Data de Publicacao</label>
                                        <input type="datetime-local" id="newsDate" class="form-input">
                                    </div>

                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary btn-full" onclick="saveNewsDraft()">
                                            Salvar Rascunho
                                        </button>
                                    </div>
                                    <button class="btn btn-primary btn-full" onclick="publishNews()" style="margin-top: 0.5rem;">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Publicar
                                    </button>
                                </div>

                                <!-- Categoria -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Categoria</div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <select id="newsCategory" class="form-select">
                                            <option value="">Selecione uma categoria...</option>
                                            <option value="mirador">Mirador</option>
                                            <option value="regiao">Regiao</option>
                                            <option value="brasil">Brasil</option>
                                            <option value="policia">Policia</option>
                                            <option value="esportes">Esportes</option>
                                            <option value="politica">Politica</option>
                                            <option value="geral">Geral</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Imagem Destacada -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Imagem Destacada</div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <div class="featured-image-upload" onclick="document.getElementById('newsImageInput').click()">
                                            <input type="file" id="newsImageInput" accept="image/*" style="display: none;" onchange="handleNewsImageUpload(event)">
                                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 0.5rem; color: var(--text-muted);">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Clique para adicionar imagem</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">PNG, JPG (max. 2MB)</div>
                                        </div>
                                        <img id="newsImagePreview" class="featured-image-preview" style="display: none;">
                                        <button type="button" id="removeImageBtn" class="btn btn-ghost btn-sm" style="display: none; margin-top: 0.5rem; width: 100%;" onclick="removeNewsImage()">
                                            Remover Imagem
                                        </button>
                                    </div>
                                </div>

                                <!-- Fonte Externa -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Fonte Externa</div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <input type="url" id="newsExternalUrl" class="form-input" placeholder="Cole a URL da noticia (G1, etc.)" oninput="handleExternalUrlInput()">
                                        <div id="newsExternalDomainHint" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);"></div>
                                    </div>
                                </div>

                                <!-- Autor -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Autor</div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <input type="text" id="newsAuthor" class="form-input" placeholder="Nome do autor" value="Redacao">
                                    </div>
                                </div>

                                <!-- Tags -->
                                <div class="editor-sidebar-card">
                                    <div class="editor-sidebar-title"> Tags</div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <input type="text" id="newsTags" class="form-input" placeholder="Separe as tags por virgula...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="modal-title" id="modalTitle">Sucesso!</h3>
                <p class="modal-message" id="modalMessage">Operacao realizada com sucesso.</p>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="modal-btn" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Configuracao do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBI1AcATNjWC08aMYZMKxVcqV37DwmixVI",
            authDomain: "sitemirador-fb33d.firebaseapp.com",
            projectId: "sitemirador-fb33d",
            storageBucket: "sitemirador-fb33d.firebasestorage.app",
            messagingSenderId: "341361537788",
            appId: "1:341361537788:web:d0948a0e25e7b89e419d79",
            measurementId: "G-VVJ25KQCKD"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Inicializar R2 Client
        document.addEventListener('DOMContentLoaded', function() {
            initR2Client();
            setupSidebarScrollLock();
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAdmin();
            } catch (error) {
                console.error('Erro no login:', error);
                errorElement.textContent = 'Email ou senha incorretos';
                errorElement.style.display = 'block';
            }
        });

        // Logout
        async function logout() {
            if (confirm('Deseja realmente sair?')) {
                await auth.signOut();
                location.reload();
            }
        }

        // Mostrar admin
        function showAdmin() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            updateUserInfo();
            loadDashboard();
            
            // Restaurar pagina salva ou ir para dashboard
            restoreLastPage();
        }

        // Restaurar ultima pagina visitada
        function restoreLastPage() {
            const savedPage = localStorage.getItem('adminCurrentPage');
            const pageMap = {
                'dashboard': { id: 'dashboardPage', index: 0 },
                'news': { id: 'newsPage', index: 1 },
                'instagram': { id: 'instagramPage', index: 2 },
                'importNews': { id: 'importNewsPage', index: 3 },
                'categories': { id: 'categoriesPage', index: 4 },
                'media': { id: 'mediaPage', index: 5 },
                'storage': { id: 'storagePage', index: 6 },
                'settings': { id: 'settingsPage', index: 7 },
                'users': { id: 'dashboardPage', index: 8 }
            };

            if (savedPage && pageMap[savedPage] && savedPage !== 'dashboard') {
                // Encontrar o elemento do nav correspondente
                const navItems = document.querySelectorAll('.nav-item');
                const pageInfo = pageMap[savedPage];
                
                if (navItems[pageInfo.index]) {
                    showPage(savedPage, navItems[pageInfo.index]);
                    return;
                }
            }
            
            // Padrao: carregar dashboard
            loadDashboard();
        }

        // Atualizar informacoes do usuario logado
        function updateUserInfo() {
            const user = auth.currentUser;
            if (user) {
                const email = user.email;
                const name = user.displayName || 'Editor Chefe';
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = initials || 'EC';
            }
        }

        // Toggle Sidebar Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function setupSidebarScrollLock() {
            const sidebar = document.getElementById('sidebar');
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (!sidebar || !sidebarNav || sidebar.dataset.scrollLockReady === '1') return;

            sidebar.dataset.scrollLockReady = '1';

            sidebar.addEventListener('wheel', function(event) {
                const hasScrollableNav = sidebarNav.scrollHeight > sidebarNav.clientHeight + 1;

                if (!hasScrollableNav) {
                    event.preventDefault();
                    return;
                }

                const deltaY = event.deltaY || 0;
                const isScrollingDown = deltaY > 0;
                const isScrollingUp = deltaY < 0;
                const atTop = sidebarNav.scrollTop <= 0;
                const atBottom = Math.ceil(sidebarNav.scrollTop + sidebarNav.clientHeight) >= sidebarNav.scrollHeight;
                const targetInsideNav = sidebarNav.contains(event.target);

                if (!targetInsideNav) {
                    sidebarNav.scrollTop += deltaY;
                    event.preventDefault();
                    return;
                }

                if ((isScrollingUp && atTop) || (isScrollingDown && atBottom)) {
                    event.preventDefault();
                }
            }, { passive: false });
        }

        // Navegacao entre paginas
        function showPage(pageName, element) {
            // Salvar pagina atual no localStorage
            localStorage.setItem('adminCurrentPage', pageName);

            // Esconder todas as paginas
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });

            // Remover active de todos os nav-items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Mostrar pagina selecionada
            const pageMap = {
                'dashboard': 'dashboardPage',
                'settings': 'settingsPage',
                'news': 'newsPage',
                'importNews': 'importNewsPage',
                'categories': 'categoriesPage',
                'media': 'mediaPage',
                'instagram': 'instagramPage',
                'storage': 'storagePage',
                'users': 'dashboardPage'
            };
            
            // Carregar dados especificos da pagina
            if (pageName === 'instagram') {
                loadInstagramAdmin();
            }

            if (pageName === 'news') {
                switchNewsTab('publicacoes');
            }

            if (pageName === 'importNews') {
                switchImportNewsTab('publicacoes');
            }
            
            if (pageName === 'storage') {
                // Pequeno delay para garantir que o DOM esta pronto
                setTimeout(() => loadStorageInfo(), 100);
            }

            if (pageName === 'media') {
                // Pequeno delay para garantir que o DOM esta pronto
                setTimeout(() => loadMediaLibrary(), 100);
            }

            const pageId = pageMap[pageName];
            if (pageId) {
                document.getElementById(pageId).style.display = 'block';
            }

            // Adicionar active no nav-item correspondente
            if (element) {
                element.classList.add('active');
            }

            // Fechar sidebar no mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }

            // Carregar dados se necessario
            if (pageName === 'dashboard') {
                loadDashboard();
            } else if (pageName === 'settings') {
                loadColors();
            }
        }

        // Carregar Dashboard
        function toNumberSafe(value) {
            if (typeof value === 'number' && Number.isFinite(value)) return value;
            if (typeof value !== 'string') return 0;

            const trimmed = value.trim();
            if (!trimmed) return 0;

            const compactMatch = trimmed.match(/^([\d.,]+)\s*([kKmMbB]|mil|mi)?$/i);
            if (compactMatch) {
                const rawNumber = compactMatch[1].replace(/\./g, '').replace(',', '.');
                const parsedCompact = Number(rawNumber);
                if (Number.isFinite(parsedCompact)) {
                    const suffix = (compactMatch[2] || '').toLowerCase();
                    const multiplier =
                        suffix === 'k' || suffix === 'mil' ? 1_000 :
                        suffix === 'm' || suffix === 'mi' ? 1_000_000 :
                        suffix === 'b' ? 1_000_000_000 :
                        1;
                    return parsedCompact * multiplier;
                }
            }

            const normalized = trimmed.replace(/[^\d,-]/g, '').replace(/\./g, '').replace(',', '.');
            const parsed = Number(normalized);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function getNewsViewsValue(newsItem = {}) {
            const candidates = [
                newsItem.views,
                newsItem.viewCount,
                newsItem.viewsCount,
                newsItem.visualizacoes,
                newsItem['visualizações'],
                newsItem.totalVisualizacoes,
                newsItem.totalViews,
                newsItem.metrics?.views,
                newsItem.metrics?.totalViews,
                newsItem.instagramLikes,
                newsItem.socialViews,
                newsItem.reach,
                newsItem.likes
            ];

            for (const candidate of candidates) {
                const num = toNumberSafe(candidate);
                if (num > 0) return num;
            }

            return toNumberSafe(newsItem.views);
        }

        function isPublishedNews(newsItem = {}) {
            const status = String(newsItem.status || 'published').toLowerCase();
            return status !== 'draft' && status !== 'rascunho';
        }

        function isInstagramNewsItem(newsItem = {}) {
            const source = String(newsItem.source || '').toLowerCase();
            const category = String(newsItem.category || '').toLowerCase();
            const categoryName = String(newsItem.categoryName || '').toLowerCase();
            const instagramUrl = String(newsItem.instagramUrl || newsItem.sourceUrl || '').toLowerCase();

            return source.includes('instagram')
                || category === 'instagram'
                || categoryName.includes('instagram')
                || instagramUrl.includes('instagram.com/');
        }

        function isRegularNewsItem(newsItem = {}) {
            return !isInstagramNewsItem(newsItem);
        }

        function isImportedUrlNewsItem(newsItem = {}) {
            if (isInstagramNewsItem(newsItem)) return false;

            const source = String(newsItem.source || '').toLowerCase();
            const importMethod = String(newsItem.importMethod || newsItem.importType || '').toLowerCase();

            return newsItem.isImported === true
                || importMethod === 'url'
                || source.includes('import');
        }

        function updateNewsCountBadge(value = 0) {
            const badge = document.getElementById('newsCountBadge');
            if (badge) badge.innerText = String(Math.max(0, Number(value) || 0));
        }

        function updateInstagramCountBadge(value = 0) {
            const badge = document.getElementById('instagramCountBadge');
            if (badge) badge.innerText = String(Math.max(0, Number(value) || 0));
        }

        function formatCompactNumber(value) {
            const num = toNumberSafe(value);
            return new Intl.NumberFormat('pt-BR', {
                notation: 'compact',
                maximumFractionDigits: 1
            }).format(num);
        }

        async function loadDashboard() {
            try {
                const snapshot = await db.collection('news').orderBy('date', 'desc').get();
                const news = [];
                snapshot.forEach(doc => {
                    news.push({ id: doc.id, ...doc.data() });
                });
                
                // Armazenar em cache para uso na pagina de storage
                cachedNewsData = news;

                // Atualizar Estatisticas
                const regularNews = news.filter(isRegularNewsItem);
                const publishedNews = regularNews.filter(isPublishedNews);
                const publishedInstagramPosts = news.filter(item => isInstagramNewsItem(item) && isPublishedNews(item));
                document.getElementById('totalNews').innerText = publishedNews.length;

                // Calcular visualizacoes
                const totalViews = news.reduce((acc, curr) => acc + getNewsViewsValue(curr), 0);
                document.getElementById('totalViews').innerText = totalViews.toLocaleString('pt-BR');

                // Leitores ativos (estimativa baseada nas visualizacoes recentes)
                const activeReaders = Math.max(0, Math.round(totalViews * 0.08));
                const activeReadersEl = document.getElementById('activeReaders');
                if (activeReadersEl) activeReadersEl.innerText = formatCompactNumber(activeReaders);

                // Rascunhos (simulado por enquanto)
                document.getElementById('draftNews').innerText = "0";

                // Rascunhos
                const drafts = regularNews.filter(n => String(n.status || '').toLowerCase() === 'draft').length;
                document.getElementById('draftNews').innerText = drafts;

                // Atualizar badge no menu
                updateNewsCountBadge(publishedNews.length);
                updateInstagramCountBadge(publishedInstagramPosts.length);

            } catch (error) {
                console.error("Erro ao carregar dashboard:", error);
            }
        }

        // Variavel global para cliente R2 (novo - via backend)
        let r2Client = null;

        // Inicializar cliente R2
        function initR2Client() {
            r2Client = new R2Client();
            console.log('[R2] Cliente inicializado');
        }

        function isInlineImageDataUrl(value) {
            return typeof value === 'string' && value.trim().startsWith('data:image/');
        }

        function getConfiguredR2Hosts() {
            const hosts = new Set(['pub-5b94009c2499437d9f5b2fb46285265a.r2.dev']);
            try {
                if (typeof R2_CONFIG !== 'undefined' && R2_CONFIG.publicUrl) {
                    hosts.add(new URL(R2_CONFIG.publicUrl).hostname.toLowerCase());
                }
            } catch (_error) {}
            return hosts;
        }

        function extractR2KeyFromUrl(value) {
            if (typeof value !== 'string') return '';
            const url = value.trim();
            if (!url || url.startsWith('data:')) return '';

            try {
                const parsed = new URL(url);
                const host = parsed.hostname.toLowerCase();
                const configuredHosts = getConfiguredR2Hosts();
                const isR2Host = host.endsWith('.r2.dev') || configuredHosts.has(host);
                if (!isR2Host) return '';

                return decodeURIComponent(parsed.pathname.replace(/^\/+/, ''));
            } catch (_error) {
                return '';
            }
        }

        function collectR2KeysFromNewsData(newsData = {}) {
            const urls = [];
            if (newsData && typeof newsData.image === 'string') urls.push(newsData.image);
            if (newsData && typeof newsData.instagramVideoUrl === 'string') urls.push(newsData.instagramVideoUrl);

            if (newsData && Array.isArray(newsData.gallery)) {
                newsData.gallery.forEach(item => {
                    if (item && typeof item.url === 'string') {
                        urls.push(item.url);
                    }
                });
            }

            return Array.from(new Set(urls.map(extractR2KeyFromUrl).filter(Boolean)));
        }

        function collectR2KeysFromStoryData(storyData = {}) {
            const key = extractR2KeyFromUrl(storyData && typeof storyData.image === 'string' ? storyData.image : '');
            return key ? [key] : [];
        }

        async function deleteR2MediaKeys(keys = []) {
            const uniqueKeys = Array.from(new Set((keys || []).filter(Boolean)));
            if (uniqueKeys.length === 0) return { deleted: 0, failed: [] };

            if (!r2Client) initR2Client();

            const results = await Promise.allSettled(
                uniqueKeys.map(key => r2Client.deleteFile(key))
            );

            const failed = [];
            let deleted = 0;

            results.forEach((result, index) => {
                if (result.status === 'fulfilled') {
                    deleted += 1;
                } else {
                    failed.push({
                        key: uniqueKeys[index],
                        error: result.reason?.message || 'Falha ao remover arquivo do R2'
                    });
                }
            });

            if (failed.length > 0) {
                console.warn('[Admin] Falhas ao remover midias do R2:', failed);
            }

            return { deleted, failed };
        }

        // Testar conexao R2
        async function testR2Connection() {
            try {
                console.log('[Test] Testando conexao...');
                
                const isConnected = await r2Client.testConnection();
                
                if (isConnected) {
                    alert('Backend conectado com sucesso.\n\nO servidor esta funcionando.');
                    await loadR2StorageInfo();
                } else {
                    alert('Backend nao respondeu.\n\nVerifique se o servidor esta rodando.');
                }
            } catch (error) {
                console.error('[Test] Erro:', error);
                alert(`Erro:\n\n${error.message}`);
            }
        }

        // Carregar informacoes do R2
        async function loadR2StorageInfo() {
            try {
                document.getElementById('r2StorageSize').innerText = 'Carregando...';
                document.getElementById('r2FileCount').innerText = '--';

                if (typeof R2_CONFIG !== 'undefined') {
                    const bucketEl = document.getElementById('r2BucketName');
                    if (bucketEl && R2_CONFIG.bucketName) {
                        bucketEl.innerText = R2_CONFIG.bucketName;
                    }

                    const endpointEl = document.getElementById('r2EndpointHost');
                    if (endpointEl && R2_CONFIG.endpoint) {
                        try {
                            endpointEl.innerText = new URL(R2_CONFIG.endpoint).host;
                        } catch (_err) {
                            endpointEl.innerText = R2_CONFIG.endpoint.replace(/^https?:\/\//, '');
                        }
                    }
                }
                
                const usage = await r2Client.getStorageUsage();
                const usageGB = usage.total / (1024 * 1024 * 1024);
                const percent = Math.min((usageGB / 10) * 100, 100); // 10GB free tier
                
                // Calcular custo
                const cost = calculateR2Cost(usageGB);
                
                // Atualizar UI
                document.getElementById('r2StorageSize').innerText = usage.formatted;
                document.getElementById('r2FileCount').innerText = usage.files.toString();
                document.getElementById('r2StoragePercent').innerText = percent.toFixed(1) + '%';
                document.getElementById('r2StorageBar').style.width = percent + '%';
                document.getElementById('r2Cost').innerText = formatCurrency(cost.total.brl);

                const overageEl = document.getElementById('r2OverageRate');
                if (overageEl) {
                    const usdPerGb = Number((typeof R2_PRICING !== 'undefined' && R2_PRICING.storagePerGB) || 0.015);
                    const brlPerGb = Number((typeof EXCHANGE_RATE !== 'undefined' ? EXCHANGE_RATE : 5.0)) * usdPerGb;
                    overageEl.innerText = `US$ ${usdPerGb.toFixed(3)}/GB (~${formatCurrency(brlPerGb)}/GB)`;
                }
                
                // Mudar cor se estiver perto do limite
                const bar = document.getElementById('r2StorageBar');
                if (percent > 80) {
                    bar.style.background = '#ef4444';
                } else if (percent > 50) {
                    bar.style.background = '#f59e0b';
                } else {
                    bar.style.background = 'var(--primary)';
                }
                
            } catch (error) {
                console.error('[R2] Erro ao carregar info:', error);
                document.getElementById('r2StorageSize').innerText = 'Erro';
                document.getElementById('r2FileCount').innerText = '--';
                const overageEl = document.getElementById('r2OverageRate');
                if (overageEl) overageEl.innerText = '--';
            }
        }

        // Biblioteca de Midia (R2 + vinculos Firestore)
        let mediaLibraryData = [];
        let mediaLibraryLoading = false;
        let mediaLibraryWarnings = [];
        let mediaLibraryLastSync = null;

        function escapeHtml(value = '') {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function normalizeSearchText(value = '') {
            return String(value || '')
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();
        }

        function parseDateInput(value) {
            if (!value) return null;
            if (value instanceof Date) return Number.isNaN(value.getTime()) ? null : value;

            if (typeof value === 'string' || typeof value === 'number') {
                const parsed = new Date(value);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            }

            if (value && typeof value.toDate === 'function') {
                try {
                    const parsed = value.toDate();
                    return parsed instanceof Date && !Number.isNaN(parsed.getTime()) ? parsed : null;
                } catch (_error) {
                    return null;
                }
            }

            if (value && typeof value.seconds === 'number') {
                const parsed = new Date(value.seconds * 1000);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            }

            return null;
        }

        function formatDateOnly(value) {
            const date = parseDateInput(value);
            return date ? date.toLocaleDateString('pt-BR') : 'Sem data';
        }

        function formatDateTime(value) {
            const date = parseDateInput(value);
            if (!date) return 'Sem data';
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getInitialsFromText(value = '', fallback = '--') {
            const words = String(value || '')
                .trim()
                .split(/\s+/)
                .filter(Boolean);
            if (!words.length) return fallback;

            const first = (words[0] || '').charAt(0);
            const second = words.length > 1
                ? (words[1] || '').charAt(0)
                : ((words[0] || '').charAt(1) || '');
            const initials = `${first}${second}`.toUpperCase();
            return initials || fallback;
        }

        function getMediaKindFromKey(key = '') {
            const ext = String(key).split('.').pop().toLowerCase();
            const imageExt = new Set(['jpg', 'jpeg', 'png', 'webp', 'gif', 'bmp', 'svg', 'avif']);
            const videoExt = new Set(['mp4', 'mov', 'webm', 'm4v', 'avi', 'mkv', 'mpeg']);

            if (imageExt.has(ext)) return 'image';
            if (videoExt.has(ext)) return 'video';
            return 'file';
        }

        function getMediaKindLabel(kind = '') {
            const labels = {
                image: 'Imagem',
                video: 'Video',
                file: 'Arquivo'
            };
            return labels[kind] || 'Arquivo';
        }

        function getMediaOwnerTypeLabel(type = '') {
            const labels = {
                noticia: 'Noticia',
                post: 'Post',
                story: 'Story',
                logo: 'Logo',
                perfil: 'Perfil',
                banner: 'Banner'
            };
            return labels[type] || 'Midia';
        }

        function resolveNewsOwnerType(newsData = {}) {
            const source = String(newsData.source || '').toLowerCase();
            const category = String(newsData.category || '').toLowerCase();
            if (source.includes('instagram') || category === 'instagram' || newsData.isImported === true) {
                return 'post';
            }
            return 'noticia';
        }

        function buildR2PublicUrlFromKey(key = '') {
            if (!key) return '';
            const baseUrl = (typeof getR2PublicUrl === 'function' ? getR2PublicUrl() : DEFAULT_CLOUDFLARE_PUBLIC_URL) || DEFAULT_CLOUDFLARE_PUBLIC_URL;
            const safeBase = String(baseUrl).replace(/\/+$/, '');
            const safeKey = String(key)
                .split('/')
                .map(part => encodeURIComponent(part))
                .join('/');
            return `${safeBase}/${safeKey}`;
        }

        function addOwnerToIndex(ownerIndex, key, owner) {
            if (!key) return;
            const current = ownerIndex.get(key) || [];
            current.push(owner);
            ownerIndex.set(key, current);
        }

        function dedupeMediaOwners(owners = []) {
            const seen = new Set();
            const result = [];
            owners.forEach(owner => {
                const signature = [
                    owner.ownerType || '',
                    owner.collection || '',
                    owner.docId || '',
                    owner.reference || '',
                    owner.locked ? '1' : '0'
                ].join('|');

                if (seen.has(signature)) return;
                seen.add(signature);
                result.push(owner);
            });
            return result;
        }

        function collectR2KeysFromNewsForLibrary(newsData = {}) {
            const keys = new Set(collectR2KeysFromNewsData(newsData));
            const profileKeys = [
                newsData.instagramProfileImage,
                newsData.profileImage,
                newsData.authorImage
            ]
                .map(extractR2KeyFromUrl)
                .filter(Boolean);

            profileKeys.forEach(key => keys.add(key));
            return Array.from(keys);
        }

        function collectInstagramProfileCandidates(settingsData = {}) {
            const nested = settingsData && typeof settingsData.instagramProfile === 'object'
                ? settingsData.instagramProfile
                : {};

            const candidates = [
                settingsData.instagramProfileImage,
                settingsData.instagramProfilePhoto,
                settingsData.instagramAvatar,
                settingsData.profileImage,
                settingsData.profile_image,
                settingsData.profilePhoto,
                settingsData.profile_photo,
                settingsData.avatar,
                settingsData.avatarUrl,
                settingsData.avatar_url,
                settingsData.photo,
                settingsData.photoUrl,
                settingsData.image,
                nested.profileImage,
                nested.profilePhoto,
                nested.avatar
            ];

            return candidates.filter(value => typeof value === 'string' && value.trim());
        }

        function collectTopBannerMediaCandidates(slotData = {}) {
            const source = slotData && typeof slotData === 'object' ? slotData : {};
            const mediaItems = Array.isArray(source.media)
                ? source.media
                : Array.isArray(source.images)
                    ? source.images
                    : Array.isArray(source.urls)
                        ? source.urls
                        : [];

            const urls = mediaItems
                .map(item => {
                    if (typeof item === 'string') return item;
                    if (item && typeof item.url === 'string') return item.url;
                    return '';
                })
                .filter(Boolean);

            if (urls.length === 0 && typeof source.url === 'string' && source.url.trim()) {
                urls.push(source.url);
            }
            if (urls.length === 0 && typeof source.gifUrl === 'string' && source.gifUrl.trim()) {
                urls.push(source.gifUrl);
            }

            return urls;
        }

        async function buildMediaLibraryOwnerIndex() {
            const ownerIndex = new Map();
            const warnings = [];

            const addOwnerFromUrl = (url, owner) => {
                const key = extractR2KeyFromUrl(url);
                if (!key) return;
                addOwnerToIndex(ownerIndex, key, owner);
            };

            const readCollectionWithFallback = async (collectionName, fallbackData = [], label = collectionName, options = {}) => {
                const silent = Boolean(options.silent);
                try {
                    const snapshot = await db.collection(collectionName).get();
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.warn(`[Admin] Falha ao carregar colecao "${collectionName}" para biblioteca de midia:`, error);
                    if (!silent) {
                        warnings.push(`Sem permissao em ${label}.`);
                    }
                    return Array.isArray(fallbackData) ? fallbackData : [];
                }
            };

            const newsDocs = await readCollectionWithFallback('news', cachedNewsData, 'noticias/posts');
            const storiesDocs = await readCollectionWithFallback('stories', cachedStoriesData, 'stories ativos');
            const archivedStoriesDocs = await readCollectionWithFallback('storiesArchive', [], 'stories arquivados', { silent: true });
            const settingsDocs = await readCollectionWithFallback('settings', cachedSettingsData, 'configuracoes');

            newsDocs.forEach(news => {
                const ownerType = resolveNewsOwnerType(news);
                const title = String(news.title || (ownerType === 'post' ? 'Post Instagram' : 'Noticia')).trim();
                const isLocked = isPublishedNews(news);
                const publicationDate = parseDateInput(news.date || news.createdAt || news.updatedAt);
                const baseOwner = {
                    ownerType,
                    collection: 'news',
                    docId: news.id || '',
                    title: title || (ownerType === 'post' ? 'Post Instagram' : 'Noticia'),
                    initials: getInitialsFromText(title || ownerType, ownerType === 'post' ? 'PT' : 'NT'),
                    date: publicationDate,
                    locked: isLocked,
                    reference: `news/${news.id || ''}`
                };

                const contentKeys = collectR2KeysFromNewsData(news);
                contentKeys.forEach(key => addOwnerToIndex(ownerIndex, key, baseOwner));

                const profileKeys = collectR2KeysFromNewsForLibrary(news).filter(key => !contentKeys.includes(key));
                if (profileKeys.length > 0) {
                    const profileOwner = {
                        ...baseOwner,
                        ownerType: 'perfil',
                        title: `Perfil Instagram - ${baseOwner.title}`,
                        initials: getInitialsFromText(baseOwner.title, 'PF')
                    };
                    profileKeys.forEach(key => addOwnerToIndex(ownerIndex, key, profileOwner));
                }
            });

            storiesDocs.forEach(story => {
                const title = String(story.title || 'Story').trim() || 'Story';
                const owner = {
                    ownerType: 'story',
                    collection: 'stories',
                    docId: story.id || '',
                    title,
                    initials: getInitialsFromText(title, 'ST'),
                    date: parseDateInput(story.date || story.createdAt || story.updatedAt),
                    locked: true,
                    reference: `stories/${story.id || ''}`
                };

                collectR2KeysFromStoryData(story).forEach(key => addOwnerToIndex(ownerIndex, key, owner));
            });

            archivedStoriesDocs.forEach(story => {
                const title = String(story.title || 'Story arquivado').trim() || 'Story arquivado';
                const owner = {
                    ownerType: 'story',
                    collection: 'storiesArchive',
                    docId: story.id || '',
                    title,
                    initials: getInitialsFromText(title, 'ST'),
                    date: parseDateInput(story.archivedAt || story.date || story.updatedAt),
                    locked: false,
                    reference: `storiesArchive/${story.id || ''}`
                };

                collectR2KeysFromStoryData(story).forEach(key => addOwnerToIndex(ownerIndex, key, owner));
            });

            const settingsById = new Map();
            settingsDocs.forEach(docData => {
                if (docData && docData.id) {
                    settingsById.set(docData.id, docData);
                }
            });

            const brandSettings = settingsById.get('brand') || {};
            const layoutSettings = settingsById.get('layout') || {};
            const instagramProfileSettings = settingsById.get('instagramProfile') || {};

            const brandLogoKey = extractR2KeyFromUrl(brandSettings.logo || '');
            if (brandLogoKey) {
                addOwnerToIndex(ownerIndex, brandLogoKey, {
                    ownerType: 'logo',
                    collection: 'settings',
                    docId: 'brand',
                    title: String(brandSettings.siteName || 'Logo do site'),
                    initials: getInitialsFromText(brandSettings.siteName || 'Logo', 'LG'),
                    date: parseDateInput(brandSettings.updatedAt),
                    locked: true,
                    reference: 'settings/brand/logo'
                });
            }

            const profileSources = [
                { docId: 'instagramProfile', data: instagramProfileSettings },
                { docId: 'layout', data: layoutSettings },
                { docId: 'brand', data: brandSettings }
            ];

            profileSources.forEach(source => {
                const profileUrls = collectInstagramProfileCandidates(source.data);
                profileUrls.forEach(url => {
                    addOwnerFromUrl(url, {
                        ownerType: 'perfil',
                        collection: 'settings',
                        docId: source.docId,
                        title: 'Perfil Instagram oficial',
                        initials: 'PF',
                        date: parseDateInput(source.data?.updatedAt || source.data?.instagramProfileUpdatedAt),
                        locked: true,
                        reference: `settings/${source.docId}/instagramProfile`
                    });
                });
            });

            const topBannerSettings = layoutSettings && typeof layoutSettings.topBanners === 'object'
                ? layoutSettings.topBanners
                : {};
            const normalizedTopBanners = normalizeTopBannersSettingsAdmin(topBannerSettings);
            const topBannerItems = Array.isArray(normalizedTopBanners.items)
                ? normalizedTopBanners.items
                : [];
            const visibleCount = Math.max(
                1,
                Math.min(
                    20,
                    Number(normalizedTopBanners.displayCount) || topBannerItems.length || 2
                )
            );

            const topBannerItemsWithMedia = topBannerItems
                .map((slotData, slotIndex) => ({
                    slotData,
                    slotIndex,
                    slotUrls: collectTopBannerMediaCandidates(slotData)
                }))
                .filter(entry => entry.slotUrls.length > 0);

            topBannerItemsWithMedia.forEach((entry, mediaIndex) => {
                const isVisibleOnSite = mediaIndex < visibleCount;
                const title = isVisibleOnSite
                    ? `Banner topo ${entry.slotIndex + 1}`
                    : `Banner topo ${entry.slotIndex + 1} (reserva)`;
                const initials = `B${entry.slotIndex + 1}`;

                entry.slotUrls.forEach(url => {
                    addOwnerFromUrl(url, {
                        ownerType: 'banner',
                        collection: 'settings',
                        docId: 'layout',
                        title,
                        initials,
                        date: parseDateInput(entry.slotData.updatedAt || topBannerSettings.updatedAt || layoutSettings.updatedAt),
                        locked: true,
                        reference: `settings/layout/topBanners/items/${entry.slotIndex}`
                    });
                });
            });

            ownerIndex.forEach((owners, key) => {
                const deduped = dedupeMediaOwners(owners).sort((a, b) => {
                    const lockedDiff = Number(b.locked) - Number(a.locked);
                    if (lockedDiff !== 0) return lockedDiff;

                    const dateA = parseDateInput(a.date);
                    const dateB = parseDateInput(b.date);
                    const timeA = dateA ? dateA.getTime() : 0;
                    const timeB = dateB ? dateB.getTime() : 0;
                    return timeB - timeA;
                });

                ownerIndex.set(key, deduped);
            });

            return { ownerIndex, warnings };
        }

        function updateMediaLibrarySummary() {
            const total = mediaLibraryData.length;
            const linked = mediaLibraryData.filter(item => item.hasOwner).length;
            const orphan = mediaLibraryData.filter(item => !item.hasOwner).length;
            const locked = mediaLibraryData.filter(item => item.locked).length;

            const setCounter = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = Number(value).toLocaleString('pt-BR');
            };

            setCounter('mediaSummaryTotal', total);
            setCounter('mediaSummaryLinked', linked);
            setCounter('mediaSummaryOrphan', orphan);
            setCounter('mediaSummaryLocked', locked);
        }

        function updateMediaLibraryStatusMessage(filteredCount = null) {
            const statusEl = document.getElementById('mediaLibraryStatus');
            if (!statusEl) return;

            if (!mediaLibraryLastSync) {
                statusEl.textContent = 'Carregue a biblioteca para listar os arquivos.';
                return;
            }

            const total = mediaLibraryData.length;
            const shown = Number.isFinite(filteredCount) ? filteredCount : total;
            const syncTime = mediaLibraryLastSync.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const messages = [
                `Mostrando ${shown} de ${total} arquivo(s)`,
                `Atualizado as ${syncTime}`
            ];

            if (mediaLibraryWarnings.length > 0) {
                messages.push(`Aviso: ${mediaLibraryWarnings.join(' ')}`);
            }

            statusEl.textContent = `${messages.join(' | ')}.`;
        }

        function getFilteredMediaLibraryItems() {
            const ownerTypeFilter = (document.getElementById('mediaOwnerTypeFilter')?.value || 'all').toLowerCase();
            const statusFilter = (document.getElementById('mediaStatusFilter')?.value || 'all').toLowerCase();
            const searchTerm = normalizeSearchText(document.getElementById('mediaSearchInput')?.value || '');

            return mediaLibraryData.filter(item => {
                if (ownerTypeFilter === 'orphan' && item.hasOwner) return false;
                if (ownerTypeFilter !== 'all' && ownerTypeFilter !== 'orphan') {
                    const hasOwnerType = item.owners.some(owner => owner.ownerType === ownerTypeFilter);
                    if (!hasOwnerType) return false;
                }

                if (statusFilter === 'locked' && !item.locked) return false;
                if (statusFilter === 'deletable' && item.locked) return false;
                if (statusFilter === 'linked' && !item.hasOwner) return false;
                if (statusFilter === 'orphan' && item.hasOwner) return false;

                if (!searchTerm) return true;

                const ownerText = item.owners.map(owner => [
                    owner.title,
                    owner.initials,
                    getMediaOwnerTypeLabel(owner.ownerType),
                    owner.reference
                ].join(' ')).join(' ');

                const searchable = normalizeSearchText([
                    item.key,
                    item.mainOwner?.title || '',
                    ownerText
                ].join(' '));

                return searchable.includes(searchTerm);
            });
        }

        function getMediaOwnerChipLabel(owner = {}) {
            const ownerTypeLabel = getMediaOwnerTypeLabel(owner.ownerType);
            const dateLabel = formatDateOnly(owner.date);
            const initials = owner.initials || '--';
            return `${ownerTypeLabel} ${dateLabel} ${initials}`;
        }

        function renderMediaPreview(item) {
            const safeUrl = escapeHtml(item.url || '');
            const kind = item.mediaKind;

            if (kind === 'image') {
                return `<img src="${safeUrl}" alt="Preview de midia" loading="lazy">`;
            }

            if (kind === 'video') {
                return `<video src="${safeUrl}" preload="metadata" playsinline muted></video>`;
            }

            const extension = escapeHtml(String(item.key).split('.').pop().toUpperCase() || 'ARQ');
            return `<div class="media-preview-placeholder">${extension}</div>`;
        }

        function renderMediaLibrary() {
            const listContainer = document.getElementById('mediaLibraryList');
            if (!listContainer) return;

            const filteredItems = getFilteredMediaLibraryItems();
            updateMediaLibraryStatusMessage(filteredItems.length);

            if (!filteredItems.length) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p>Nenhuma midia encontrada com os filtros atuais.</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredItems.map(item => {
                const kindLabel = getMediaKindLabel(item.mediaKind);
                const ownerChips = item.owners.length
                    ? `${item.owners.slice(0, 2).map(owner => `
                        <span class="media-owner-chip ${owner.locked ? 'locked' : ''}" title="${escapeHtml(owner.title || '')}">
                            ${escapeHtml(getMediaOwnerChipLabel(owner))}
                        </span>
                    `).join('')}
                    ${item.owners.length > 2 ? `<span class="media-owner-chip">+${item.owners.length - 2}</span>` : ''}`
                    : '<span class="media-owner-chip orphan">Sem vinculo</span>';

                const ownerDescription = item.mainOwner
                    ? `${getMediaOwnerTypeLabel(item.mainOwner.ownerType)} - ${item.mainOwner.title || 'Sem titulo'}`
                    : 'Sem publicacao ativa vinculada';

                const deleteButton = item.locked
                    ? `<button class="btn btn-secondary btn-sm media-delete-btn" disabled title="Midia vinculada a conteudo ativo.">Excluir bloqueado</button>`
                    : `<button class="btn btn-primary btn-sm media-delete-btn" onclick="deleteMediaLibraryItem(decodeURIComponent('${encodeURIComponent(item.key)}'))">Excluir</button>`;

                return `
                    <article class="media-card">
                        <div class="media-preview-wrap">
                            ${renderMediaPreview(item)}
                            <span class="media-kind-badge">${escapeHtml(kindLabel)}</span>
                            <span class="media-size-badge">${escapeHtml(formatBytes(item.size || 0))}</span>
                        </div>
                        <div class="media-card-body">
                            <div class="media-key" title="${escapeHtml(item.key)}">${escapeHtml(item.key)}</div>
                            <div class="media-owner-chip-wrap">${ownerChips}</div>
                            <div class="media-owner-line">${escapeHtml(ownerDescription)}</div>
                            <div class="media-meta-row">
                                <span>${escapeHtml(formatDateTime(item.lastModified))}</span>
                                <span>${item.locked ? 'Protegido' : 'Liberado'}</span>
                            </div>
                            <div class="media-actions">
                                ${deleteButton}
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function handleMediaFiltersChange() {
            renderMediaLibrary();
        }

        async function loadMediaLibrary(forceReload = false) {
            const listContainer = document.getElementById('mediaLibraryList');
            const statusEl = document.getElementById('mediaLibraryStatus');
            if (!listContainer) return;

            const hasFreshCache = !forceReload &&
                mediaLibraryData.length > 0 &&
                mediaLibraryLastSync &&
                (Date.now() - mediaLibraryLastSync.getTime()) < 15000;

            if (hasFreshCache) {
                renderMediaLibrary();
                return;
            }

            if (mediaLibraryLoading) return;
            mediaLibraryLoading = true;

            if (statusEl) statusEl.textContent = 'Carregando midias do R2...';
            listContainer.innerHTML = `
                <div class="empty-state">
                    <p>Carregando biblioteca de midia...</p>
                </div>
            `;

            try {
                if (!r2Client) initR2Client();

                const [filesResponse, ownerInfo] = await Promise.all([
                    r2Client.listFiles(),
                    buildMediaLibraryOwnerIndex()
                ]);

                const files = Array.isArray(filesResponse?.files) ? filesResponse.files : [];
                const ownerIndex = ownerInfo?.ownerIndex instanceof Map ? ownerInfo.ownerIndex : new Map();

                mediaLibraryWarnings = Array.isArray(ownerInfo?.warnings) ? ownerInfo.warnings : [];
                mediaLibraryLastSync = new Date();

                mediaLibraryData = files
                    .map(file => {
                        const key = String(file.key || '').trim();
                        const owners = ownerIndex.get(key) || [];
                        const locked = owners.some(owner => owner.locked);
                        const mainOwner = owners.find(owner => owner.locked) || owners[0] || null;
                        const fileUrl = typeof file.url === 'string' && file.url.trim()
                            ? file.url
                            : buildR2PublicUrlFromKey(key);

                        return {
                            key,
                            url: fileUrl,
                            size: Number(file.size) || 0,
                            lastModified: parseDateInput(file.lastModified),
                            mediaKind: getMediaKindFromKey(key),
                            owners,
                            mainOwner,
                            hasOwner: owners.length > 0,
                            locked
                        };
                    })
                    .sort((a, b) => {
                        const timeA = a.lastModified ? a.lastModified.getTime() : 0;
                        const timeB = b.lastModified ? b.lastModified.getTime() : 0;
                        if (timeA !== timeB) return timeB - timeA;
                        return a.key.localeCompare(b.key);
                    });

                updateMediaLibrarySummary();
                renderMediaLibrary();
            } catch (error) {
                console.error('[Admin] Erro ao carregar biblioteca de midia:', error);
                if (statusEl) {
                    statusEl.textContent = 'Erro ao carregar midias do R2.';
                }
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Nao foi possivel carregar a biblioteca de midia.</p>
                    </div>
                `;
            } finally {
                mediaLibraryLoading = false;
            }
        }

        async function deleteMediaLibraryItem(key) {
            const item = mediaLibraryData.find(media => media.key === key);
            if (!item) {
                showModal('Atencao', 'Arquivo nao encontrado na lista atual.', 'info');
                return;
            }

            if (item.locked) {
                showModal('Exclusao bloqueada', 'Esta midia esta vinculada a conteudo ativo no site e nao pode ser removida.', 'info');
                return;
            }

            const confirmed = await showConfirmModal({
                title: 'Excluir midia do R2?',
                message: `Esta acao e permanente e nao pode ser desfeita.\n\nArquivo:\n${key}`,
                confirmText: 'Sim, excluir',
                cancelText: 'Cancelar'
            });
            if (!confirmed) return;

            try {
                if (!r2Client) initR2Client();
                await r2Client.deleteFile(key);

                mediaLibraryData = mediaLibraryData.filter(media => media.key !== key);
                updateMediaLibrarySummary();
                renderMediaLibrary();
                loadR2StorageInfo();
                showModal('Sucesso!', 'Midia excluida do Cloudflare R2.', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao excluir midia manualmente:', error);
                showModal('Erro!', 'Nao foi possivel excluir a midia selecionada.', 'error');
            }
        }

        // Variaveis globais para cache de dados
        let cachedNewsData = [];
        let cachedStoriesData = [];
        let cachedSettingsData = [];

        // Carregar informacoes de armazenamento
        async function loadStorageInfo() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.innerText = value;
            };

            const setHTML = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = value;
            };

            const setWidth = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.style.width = value;
            };

            refreshStorageAccountLinks();

            // Mostrar loading
            setText('firestoreSize', '...');
            setText('newsCount', '...');
            setText('imagesSize', '...');

            const deniedCollections = [];

            const loadCollectionData = async (collectionName, fallbackData = []) => {
                try {
                    const snapshot = await db.collection(collectionName).get();
                    const docs = [];
                    snapshot.forEach(doc => {
                        docs.push({ id: doc.id, ...doc.data() });
                    });
                    return docs;
                } catch (error) {
                    deniedCollections.push(collectionName);
                    console.warn(
                        `[Admin] Sem permissao na colecao "${collectionName}". Usando cache/estimativa.`,
                        error?.message || error
                    );
                    return Array.isArray(fallbackData) ? fallbackData : [];
                }
            };

            try {
                const newsData = await loadCollectionData('news', cachedNewsData);
                const storiesData = await loadCollectionData('stories', cachedStoriesData);
                const settingsData = await loadCollectionData('settings', cachedSettingsData);

                cachedNewsData = newsData;
                cachedStoriesData = storiesData;
                cachedSettingsData = settingsData;

                // Calcular tamanhos
                let newsSize = 0;
                let imagesSize = 0;
                let imagesCount = 0;

                newsData.forEach(data => {
                    const docSize = JSON.stringify(data || {}).length;
                    newsSize += docSize;

                    if (data && data.image) {
                        imagesSize += String(data.image).length;
                        imagesCount++;
                    }

                    if (data && data.gallery && Array.isArray(data.gallery)) {
                        data.gallery.forEach(item => {
                            if (item && item.url) {
                                imagesSize += String(item.url).length;
                                imagesCount++;
                            }
                        });
                    }
                });

                let storiesSize = 0;
                storiesData.forEach(data => {
                    storiesSize += JSON.stringify(data || {}).length;
                });

                let settingsSize = 0;
                settingsData.forEach(data => {
                    settingsSize += JSON.stringify(data || {}).length;
                });

                const regularNewsData = newsData.filter(isRegularNewsItem);
                const instagramPostsData = newsData.filter(isInstagramNewsItem);
                const publishedNewsCount = regularNewsData.filter(isPublishedNews).length;
                const totalSize = newsSize + storiesSize + settingsSize;

                // Calcular uso do plano gratuito (1GB = 1.073.741.824 bytes)
                const freePlanLimit = 1073741824;
                const usedPercent = ((totalSize / freePlanLimit) * 100).toFixed(2);
                const availableSpace = Math.max(freePlanLimit - totalSize, 0);

                // Atualizar cards principais
                setHTML('firestoreSize',
                    `${formatBytes(totalSize)}<br><small style="font-size: 0.75rem; color: var(--text-muted);">${usedPercent}% de 1GB</small>`);
                setHTML('newsCount',
                    `${publishedNewsCount.toString()}<br><small style="font-size: 0.75rem; color: var(--text-muted);">${regularNewsData.length} noticias + ${instagramPostsData.length} Instagram</small>`);
                setHTML('imagesSize',
                    `${formatBytes(imagesSize)}<br><small style="font-size: 0.75rem; color: var(--text-muted);">${imagesCount} imagens</small>`);

                // Atualizar detalhes
                setText('newsCollectionSize', `${formatBytes(newsSize)} (${newsData.length} docs)`);
                setText('storiesCollectionSize', `${formatBytes(storiesSize)} (${storiesData.length} docs)`);
                setText('settingsCollectionSize', `${formatBytes(settingsSize)} (${settingsData.length} docs)`);

                // Atualizar barras de progresso
                setWidth('newsProgressBar', `${Math.min((newsSize / freePlanLimit) * 100, 100)}%`);
                setWidth('storiesProgressBar', `${Math.min((storiesSize / freePlanLimit) * 100, 100)}%`);
                setWidth('settingsProgressBar', `${Math.min((settingsSize / freePlanLimit) * 100, 100)}%`);

                // Atualizar informacoes adicionais
                updateStorageInfo(totalSize, availableSpace, imagesSize);

                // Mensagens de permissao
                if (deniedCollections.length === 0) {
                    clearStorageError();
                } else {
                    const allDenied =
                        deniedCollections.length === 3 &&
                        newsData.length === 0 &&
                        storiesData.length === 0 &&
                        settingsData.length === 0;

                    if (allDenied) {
                        showStorageError(
                            'Sem permissao para ler colecoes no Firestore. Verifique as regras e o login admin.'
                        );
                    } else {
                        clearStorageError();
                        console.warn(
                            `[Admin] Colecoes sem permissao: ${deniedCollections.join(', ')}. Exibindo dados disponiveis.`
                        );
                    }
                }

                console.log('[Admin] Storage info loaded:', {
                    news: formatBytes(newsSize),
                    stories: formatBytes(storiesSize),
                    settings: formatBytes(settingsSize),
                    images: formatBytes(imagesSize),
                    total: formatBytes(totalSize),
                    used: `${usedPercent}%`,
                    available: formatBytes(availableSpace)
                });
            } catch (error) {
                console.error('[Admin] Erro ao carregar storage:', error);
                setHTML('firestoreSize', 'Erro<br><small style="font-size: 0.75rem;">Falha de leitura</small>');
                setText('newsCount', '--');
                setText('imagesSize', '--');
                showStorageError('Erro ao processar os dados de armazenamento.');
            }

            // Tambem carregar info do R2
            await loadR2StorageInfo();
        }

        // Atualizar informacoes de armazenamento na UI
        function updateStorageInfo(used, available, imagesSize) {
            const infoSection = document.getElementById('firebaseStorageSection');
            if (!infoSection) return;
            
            // Remover secao anterior se existir
            const existingInfo = document.getElementById('storageUsageInfo');
            if (existingInfo) existingInfo.remove();
            
            // Criar nova secao de informacoes
            const infoDiv = document.createElement('div');
            infoDiv.id = 'storageUsageInfo';
            infoDiv.style.cssText = 'padding: 1.25rem; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border-radius: var(--radius); border: 1px solid var(--border);';
            
            const usedPercent = ((used / 1073741824) * 100).toFixed(2);
            const statusColor = usedPercent > 80 ? '#ef4444' : usedPercent > 50 ? '#f59e0b' : '#10b981';
            
            infoDiv.innerHTML = `
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">
                    Resumo do plano Spark (Firestore)
                </h3>
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                        <span>Espaco utilizado</span>
                        <span style="font-weight: 600;">${formatBytes(used)} de 1GB</span>
                    </div>
                    <div style="background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, ${statusColor} 0%, ${statusColor}dd 100%); height: 100%; width: ${Math.min(usedPercent, 100)}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                        <span>${usedPercent}% usado</span>
                        <span>${formatBytes(available)} disponivel</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: var(--radius);">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${formatBytes(imagesSize)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Imagens legadas (base64/url antiga)</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: var(--radius);">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">~${Math.floor(available / 500000)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Posts aprox. disponiveis*</div>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem; margin-bottom: 0;">
                    *Estimativa de tamanho medio: 500KB por post com imagem
                </p>
            `;
            
            const summaryAnchor = document.getElementById('firebaseSummaryAnchor');
            if (summaryAnchor) {
                summaryAnchor.innerHTML = '';
                summaryAnchor.appendChild(infoDiv);
            } else {
                infoSection.insertBefore(infoDiv, infoSection.firstChild);
            }
        }

        // Contas e links do painel de armazenamento
        const FIREBASE_PROJECT_ID = 'sitemirador-fb33d';
        const RENDER_DASHBOARD_URL = 'https://dashboard.render.com';
        const RENDER_SERVICE_URL = 'https://mirador-admin.onrender.com';
        const CLOUDFLARE_DASHBOARD_URL = 'https://dash.cloudflare.com';
        const DEFAULT_CLOUDFLARE_PUBLIC_URL = 'https://pub-5b94009c2499437d9f5b2fb46285265a.r2.dev';
        const DEFAULT_CLOUDFLARE_WORKER_URL = 'https://mirador-r2.sitemirador2026.workers.dev';

        function buildFirebaseConsoleUrl(path) {
            return `https://console.firebase.google.com/project/${FIREBASE_PROJECT_ID}/${path}`;
        }

        function getR2PublicUrl() {
            if (typeof R2_CONFIG !== 'undefined' && R2_CONFIG.publicUrl) {
                return R2_CONFIG.publicUrl;
            }
            return DEFAULT_CLOUDFLARE_PUBLIC_URL;
        }

        function getWorkerBaseUrl() {
            if (r2Client && r2Client.baseUrl) {
                return r2Client.baseUrl;
            }
            return DEFAULT_CLOUDFLARE_WORKER_URL;
        }

        function refreshStorageAccountLinks() {
            const workerStatusUrl = `${getWorkerBaseUrl().replace(/\/$/, '')}/api/status`;
            const linkMap = {
                renderDashboardLink: RENDER_DASHBOARD_URL,
                renderServiceLink: RENDER_SERVICE_URL,
                cloudflareDashboardLink: CLOUDFLARE_DASHBOARD_URL,
                cloudflarePublicLink: getR2PublicUrl(),
                cloudflareWorkerLink: workerStatusUrl,
                firebaseConsoleDataLink: buildFirebaseConsoleUrl('firestore/data'),
                firebaseConsoleAuthLink: buildFirebaseConsoleUrl('authentication/users'),
                firebaseConsoleUsageLink: buildFirebaseConsoleUrl('firestore/usage')
            };

            Object.entries(linkMap).forEach(([id, url]) => {
                const el = document.getElementById(id);
                if (el && url) {
                    el.href = url;
                }
            });
        }

        function clearStorageError() {
            const existingError = document.getElementById('storagePermissionError');
            if (existingError) existingError.remove();
        }

        function showStorageError(customMessage) {
            const infoSection = document.getElementById('firebaseStorageSection');
            if (!infoSection) return;

            clearStorageError();
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'storagePermissionError';
            errorDiv.style.cssText = 'padding: 1rem; background: var(--danger-light); border-radius: var(--radius); margin: 0 1.5rem 1rem; border: 1px solid var(--danger);';
            errorDiv.innerHTML = `
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--danger);">
                    Erro de permissao
                </h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                    ${customMessage || 'Nao foi possivel acessar os dados do Firestore devido a permissoes de seguranca.'}
                </p>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                    Confira os dados no console oficial:
                </p>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <a href="${buildFirebaseConsoleUrl('firestore/data')}" target="_blank" class="btn btn-primary btn-sm" style="text-decoration: none;">
                        Firestore dados
                    </a>
                    <a href="${buildFirebaseConsoleUrl('firestore/usage')}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                        Uso Firestore
                    </a>
                </div>
            `;
            
            infoSection.insertBefore(errorDiv, infoSection.firstChild);
        }

        // Formatar bytes para exibicao
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Variaveis para paginacao
        let allNewsData = [];
        let currentNewsPage = 1;
        const newsPerPage = 10;
        let allInstagramPostsData = [];
        let currentInstagramPostsPage = 1;
        const instagramPostsPerPage = 10;
        let allImportedNewsData = [];
        let currentImportedNewsPage = 1;
        const importedNewsPerPage = 10;

        // Carregar pagina de Noticias com paginacao
        async function loadNewsPage() {
            try {
                const snapshot = await db.collection('news').orderBy('date', 'desc').get();
                const loadedNews = [];
                snapshot.forEach(doc => {
                    loadedNews.push({ id: doc.id, ...doc.data() });
                });

                allNewsData = loadedNews.filter(isRegularNewsItem);
                const publishedNewsCount = allNewsData.filter(isPublishedNews).length;
                const publishedInstagramPostsCount = loadedNews.filter(item => isInstagramNewsItem(item) && isPublishedNews(item)).length;
                updateNewsCountBadge(publishedNewsCount);
                updateInstagramCountBadge(publishedInstagramPostsCount);

                // Resetar para primeira pagina
                currentNewsPage = 1;
                renderNewsTable();

            } catch (error) {
                console.error("Erro ao carregar noticias:", error);
                const newsList = document.getElementById('newsListPage');
                if (newsList) {
                    newsList.innerHTML = `
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    <p>Erro ao carregar noticias</p>
                                </div>
                            </td>
                        </tr>`;
                }
            }
        }

        // Deletar noticia
        // Renderizar tabela de noticias com paginacao
        function renderNewsTable() {
            const newsList = document.getElementById('newsListPage');
            if (!newsList) return;
            
            newsList.innerHTML = '';

            if (allNewsData.length === 0) {
                newsList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <p>Nenhuma noticia encontrada</p>
                                <button class="btn btn-primary btn-sm" style="margin-top: 1rem;" onclick="showCreateNewsPage()">
                                    Criar primeira noticia
                                </button>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            // Calcular quantas noticias mostrar
            const endIndex = currentNewsPage * newsPerPage;
            const newsToShow = allNewsData.slice(0, endIndex);

            newsToShow.forEach(n => {
                const date = new Date(n.date).toLocaleDateString('pt-BR');
                const indicatorClass = n.status === 'draft' ? 'draft' : 'published';
                const indicatorTitle = n.status === 'draft' ? 'Rascunho' : 'Publicado';
                const viewsCount = getNewsViewsValue(n);
                
                const escapedTitle = (n.title || '').replace(/"/g, '&quot;');
                
                const imageHtml = n.image 
                    ? `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <img src="${n.image}" class="news-thumb" alt="">
                       </div>`
                    : `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <div class="news-thumb-placeholder"></div>
                       </div>`;

                const html = `
                    <tr>
                        <td>${imageHtml}</td>
                        <td class="news-title-cell">
                            <div class="news-title" title="${escapedTitle}">${n.title}</div>
                            <div class="news-meta">Por ${n.author || 'Admin'} &bull; ${viewsCount.toLocaleString('pt-BR')} visualizacoes</div>
                        </td>
                        <td><span class="category-badge">${n.categoryName || n.category || 'Geral'}</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="actions-cell">
                                <button class="action-btn" onclick="showCreateNewsPage('${n.id}')" title="Editar">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteNews('${n.id}')" title="Excluir">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                newsList.innerHTML += html;
            });

            // Adicionar linha do botao "Ver mais" se houver mais noticias
            if (endIndex < allNewsData.length) {
                const remaining = allNewsData.length - endIndex;
                const loadMoreRow = `
                    <tr id="loadMoreRow">
                        <td colspan="5" style="padding: 1.5rem; text-align: center;">
                            <button class="btn btn-secondary" onclick="loadMoreNews()">
                                <svg width="16" height="16" style="margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                Ver mais ${Math.min(remaining, newsPerPage)} noticias
                                <span style="margin-left: 0.5rem; color: var(--text-muted);">(${remaining} restantes)</span>
                            </button>
                        </td>
                    </tr>
                `;
                newsList.innerHTML += loadMoreRow;
            }
        }

        // Carregar mais noticias
        function loadMoreNews() {
            currentNewsPage++;
            renderNewsTable();
        }

        async function loadImportedNewsPage() {
            const importedList = document.getElementById('importedNewsList');
            const importedCount = document.getElementById('importedNewsCount');
            if (!importedList) return;

            try {
                const snapshot = await db.collection('news').orderBy('date', 'desc').get();
                const loadedNews = [];
                snapshot.forEach(doc => {
                    loadedNews.push({ id: doc.id, ...doc.data() });
                });

                allImportedNewsData = loadedNews.filter(isImportedUrlNewsItem);
                currentImportedNewsPage = 1;

                if (importedCount) {
                    importedCount.innerText = `${allImportedNewsData.length} noticia(s)`;
                }

                renderImportedNewsTable();
            } catch (error) {
                console.error('Erro ao carregar noticias importadas:', error);
                if (importedCount) importedCount.innerText = '0 noticia(s)';
                importedList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <p>Erro ao carregar noticias importadas</p>
                            </div>
                        </td>
                    </tr>`;
            }
        }

        function formatAdminDateOnly(value) {
            if (!value) return '--';

            try {
                if (typeof value.toDate === 'function') {
                    return value.toDate().toLocaleDateString('pt-BR');
                }

                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return '--';
                return parsed.toLocaleDateString('pt-BR');
            } catch (_error) {
                return '--';
            }
        }

        function renderImportedNewsTable() {
            const importedList = document.getElementById('importedNewsList');
            if (!importedList) return;

            importedList.innerHTML = '';

            if (allImportedNewsData.length === 0) {
                importedList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <p>Nenhuma noticia importada por URL</p>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            const endIndex = currentImportedNewsPage * importedNewsPerPage;
            const newsToShow = allImportedNewsData.slice(0, endIndex);

            newsToShow.forEach(newsItem => {
                const date = formatAdminDateOnly(newsItem.date || newsItem.createdAt);
                const indicatorClass = newsItem.status === 'draft' ? 'draft' : 'published';
                const indicatorTitle = newsItem.status === 'draft' ? 'Rascunho' : 'Publicado';
                const viewsCount = getNewsViewsValue(newsItem);
                const sourceUrl = String(newsItem.externalUrl || newsItem.sourceUrl || '').trim();
                const sourceDomain = String(newsItem.sourceDomain || '').trim();
                const safeSourceUrl = sourceUrl
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '&quot;');
                const escapedTitle = String(newsItem.title || 'Noticia importada').replace(/"/g, '&quot;');

                const imageHtml = newsItem.image
                    ? `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <img src="${newsItem.image}" class="news-thumb" alt="">
                       </div>`
                    : `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <div class="news-thumb-placeholder"></div>
                       </div>`;

                const openSourceAction = sourceUrl
                    ? `<button class="action-btn" onclick="window.open('${safeSourceUrl}', '_blank')" title="Abrir fonte original">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7m0 0v7m0-7L10 14"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h5M5 5v14h14v-5"/>
                        </svg>
                       </button>`
                    : '';

                importedList.innerHTML += `
                    <tr>
                        <td>${imageHtml}</td>
                        <td class="news-title-cell">
                            <div class="news-title" title="${escapedTitle}">${newsItem.title || 'Noticia importada'}</div>
                            <div class="news-meta">
                                ${sourceDomain || 'Site externo'} &bull; ${viewsCount.toLocaleString('pt-BR')} visualizacoes
                            </div>
                        </td>
                        <td><span class="category-badge">${newsItem.categoryName || newsItem.category || 'Geral'}</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="actions-cell">
                                ${openSourceAction}
                                <button class="action-btn" onclick="showCreateNewsPage('${newsItem.id}')" title="Editar">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteNews('${newsItem.id}')" title="Excluir">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            if (endIndex < allImportedNewsData.length) {
                const remaining = allImportedNewsData.length - endIndex;
                importedList.innerHTML += `
                    <tr id="loadMoreImportedNewsRow">
                        <td colspan="5" style="padding: 1.5rem; text-align: center;">
                            <button class="btn btn-secondary" onclick="loadMoreImportedNews()">
                                <svg width="16" height="16" style="margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                Ver mais ${Math.min(remaining, importedNewsPerPage)} noticias
                                <span style="margin-left: 0.5rem; color: var(--text-muted);">(${remaining} restantes)</span>
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function loadMoreImportedNews() {
            currentImportedNewsPage++;
            renderImportedNewsTable();
        }

        async function loadInstagramPostsPage() {
            const postsList = document.getElementById('instagramPostsList');
            const postsCount = document.getElementById('instagramPostsCount');
            if (!postsList) return;

            try {
                const snapshot = await db.collection('news').orderBy('date', 'desc').get();
                const loadedNews = [];
                snapshot.forEach(doc => {
                    loadedNews.push({ id: doc.id, ...doc.data() });
                });

                allInstagramPostsData = loadedNews.filter(isInstagramNewsItem);
                currentInstagramPostsPage = 1;
                updateInstagramCountBadge(allInstagramPostsData.filter(isPublishedNews).length);

                if (postsCount) {
                    postsCount.innerText = `${allInstagramPostsData.length} post(s)`;
                }

                renderInstagramPostsTable();
            } catch (error) {
                console.error('Erro ao carregar posts do Instagram:', error);
                updateInstagramCountBadge(0);
                postsList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <p>Erro ao carregar posts do Instagram</p>
                            </div>
                        </td>
                    </tr>`;
            }
        }

        function renderInstagramPostsTable() {
            const postsList = document.getElementById('instagramPostsList');
            if (!postsList) return;

            postsList.innerHTML = '';

            if (allInstagramPostsData.length === 0) {
                postsList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <p>Nenhum post do Instagram publicado</p>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            const endIndex = currentInstagramPostsPage * instagramPostsPerPage;
            const postsToShow = allInstagramPostsData.slice(0, endIndex);

            postsToShow.forEach(post => {
                const date = post.date ? new Date(post.date).toLocaleDateString('pt-BR') : '--';
                const indicatorClass = post.status === 'draft' ? 'draft' : 'published';
                const indicatorTitle = post.status === 'draft' ? 'Rascunho' : 'Publicado';
                const sourceUrl = String(post.instagramUrl || post.sourceUrl || '').trim();
                const safeSourceUrl = sourceUrl
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '&quot;');
                const escapedTitle = String(post.title || 'Post do Instagram').replace(/"/g, '&quot;');
                const likes = toNumberSafe(post.instagramLikes || 0);
                const comments = toNumberSafe(post.instagramComments || 0);

                const imageHtml = post.image
                    ? `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <img src="${post.image}" class="news-thumb" alt="">
                       </div>`
                    : `<div class="news-thumb-container" title="${indicatorTitle}">
                         <span class="status-indicator ${indicatorClass}"></span>
                         <div class="news-thumb-placeholder"></div>
                       </div>`;

                const openSourceAction = sourceUrl
                    ? `<button class="action-btn" onclick="window.open('${safeSourceUrl}', '_blank')" title="Abrir no Instagram">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7m0 0v7m0-7L10 14"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h5M5 5v14h14v-5"/>
                        </svg>
                       </button>`
                    : '';

                const html = `
                    <tr>
                        <td>${imageHtml}</td>
                        <td class="news-title-cell">
                            <div class="news-title" title="${escapedTitle}">${post.title || 'Post do Instagram'}</div>
                            <div class="news-meta">
                                ${(post.instagramDisplayName || post.author || 'Instagram')} &bull; ${likes.toLocaleString('pt-BR')} curtidas &bull; ${comments.toLocaleString('pt-BR')} comentarios
                            </div>
                        </td>
                        <td><span class="category-badge">Instagram</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="actions-cell">
                                ${openSourceAction}
                                <button class="action-btn delete" onclick="deleteNews('${post.id}')" title="Excluir">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                postsList.innerHTML += html;
            });

            if (endIndex < allInstagramPostsData.length) {
                const remaining = allInstagramPostsData.length - endIndex;
                const loadMoreRow = `
                    <tr id="loadMoreInstagramPostsRow">
                        <td colspan="5" style="padding: 1.5rem; text-align: center;">
                            <button class="btn btn-secondary" onclick="loadMoreInstagramPosts()">
                                <svg width="16" height="16" style="margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                Ver mais ${Math.min(remaining, instagramPostsPerPage)} posts
                                <span style="margin-left: 0.5rem; color: var(--text-muted);">(${remaining} restantes)</span>
                            </button>
                        </td>
                    </tr>
                `;
                postsList.innerHTML += loadMoreRow;
            }
        }

        function loadMoreInstagramPosts() {
            currentInstagramPostsPage++;
            renderInstagramPostsTable();
        }

        async function deleteNews(id) {
            if (!confirm('Tem certeza que deseja excluir esta noticia?')) return;

            try {
                const docRef = db.collection('news').doc(id);
                const docSnapshot = await docRef.get();
                const r2Keys = docSnapshot.exists ? collectR2KeysFromNewsData(docSnapshot.data() || {}) : [];

                await docRef.delete();
                const cleanup = await deleteR2MediaKeys(r2Keys);

                if (cleanup.failed.length > 0) {
                    showModal(
                        'Sucesso com aviso',
                        `Noticia excluida, mas ${cleanup.failed.length} arquivo(s) de midia nao foram removidos do R2.`,
                        'info'
                    );
                } else {
                    showModal('Sucesso!', 'Noticia excluida com sucesso!', 'success');
                }
                loadDashboard();
                loadNewsPage();
                loadInstagramPostsPage();
                loadImportedNewsPage();
            } catch (error) {
                console.error('Erro ao excluir noticia:', error);
                showModal('Erro!', 'Nao foi possivel excluir a noticia.', 'error');
            }
        }

        // Carregar cores salvas
        function loadColors() {
            const savedColors = localStorage.getItem('siteColors');
            if (savedColors) {
                const colors = JSON.parse(savedColors);
                Object.keys(colors).forEach(key => {
                    const colorInput = document.getElementById(`color${key}`);
                    if (colorInput) {
                        colorInput.value = colors[key];
                    }
                });
                updatePreview();
            }
            
            // Carregar layout
            loadLayout();
        }

        // Atualizar preview em tempo real
        function updatePreview() {
            const primary = document.getElementById('colorPrimary').value;
            const secondary = document.getElementById('colorSecondary').value;
            const accent = document.getElementById('colorAccent').value;
            const background = document.getElementById('colorBackground').value;
            const muted = document.getElementById('colorMuted').value;
            const foreground = document.getElementById('colorForeground').value;
            const mutedForeground = document.getElementById('colorMutedForeground').value;
            const header = document.getElementById('colorHeader').value;
            const headerText = document.getElementById('colorHeaderText').value;
            const card = document.getElementById('colorCard').value;
            const footerText = document.getElementById('colorFooterText').value;

            // Atualizar valores dos textos
            document.getElementById('colorPrimaryValue').textContent = primary.toUpperCase();
            document.getElementById('colorSecondaryValue').textContent = secondary.toUpperCase();
            document.getElementById('colorAccentValue').textContent = accent.toUpperCase();
            document.getElementById('colorBackgroundValue').textContent = background.toUpperCase();
            document.getElementById('colorCardValue').textContent = card.toUpperCase();
            document.getElementById('colorFooterTextValue').textContent = footerText.toUpperCase();
            document.getElementById('colorMutedValue').textContent = muted.toUpperCase();
            document.getElementById('colorForegroundValue').textContent = foreground.toUpperCase();
            document.getElementById('colorMutedForegroundValue').textContent = mutedForeground.toUpperCase();
            document.getElementById('colorHeaderValue').textContent = header.toUpperCase();
            document.getElementById('colorHeaderTextValue').textContent = headerText.toUpperCase();

            // Preview ao vivo
            const previewHeader = document.getElementById('previewHeader');
            const previewLogo = document.getElementById('previewLogo');
            const previewNav = document.getElementById('previewNav');
            const previewBody = document.getElementById('previewBody');
            const previewTitle = document.getElementById('previewTitle');
            const previewCard = document.getElementById('previewCard');
            const previewCardTitle = document.getElementById('previewCardTitle');
            const previewCardText = document.getElementById('previewCardText');
            const previewButton = document.getElementById('previewButton');

            if (previewHeader) previewHeader.style.background = header;
            if (previewHeader) previewHeader.style.borderColor = accent;
            if (previewLogo) previewLogo.style.color = headerText;
            if (previewNav) previewNav.style.color = headerText;
            if (previewNav) previewNav.style.color = secondary;
            if (previewBody) previewBody.style.background = background;
            if (previewTitle) previewTitle.style.color = foreground;
            if (previewCard) previewCard.style.background = muted;
            if (previewCardTitle) previewCardTitle.style.color = foreground;
            if (previewCardText) previewCardText.style.color = mutedForeground;
            if (previewButton) {
                previewButton.style.background = primary;
                previewButton.style.color = '#ffffff';
            }
        }

        // Salvar cores no Firebase
        async function saveColors() {
            const colors = {
                Primary: document.getElementById('colorPrimary').value,
                Secondary: document.getElementById('colorSecondary').value,
                Accent: document.getElementById('colorAccent').value,
                Background: document.getElementById('colorBackground').value,
                Muted: document.getElementById('colorMuted').value,
                Foreground: document.getElementById('colorForeground').value,
                MutedForeground: document.getElementById('colorMutedForeground').value,
                Header: document.getElementById('colorHeader').value,
                HeaderText: document.getElementById('colorHeaderText').value,
                Card: document.getElementById('colorCard').value,
                FooterText: document.getElementById('colorFooterText').value
            };
            const topStripSettings = {
                topStripTitleText: (document.getElementById('topStripTitleText')?.value || '').trim(),
                topStripSubtitleText: (document.getElementById('topStripSubtitleText')?.value || '').trim(),
                topStripBgColor: normalizeHexColorAdmin(document.getElementById('topStripBgColor')?.value) || '#2A0F33',
                topStripTextColor: normalizeHexColorAdmin(document.getElementById('topStripTextColor')?.value) || '#FFFFFF'
            };

            console.log('[Admin] Salvando cores:', colors);

            try {
                // Salvar no Firebase Firestore
                await db.collection('settings').doc('colors').set(colors);
                await db.collection('settings').doc('brand').set({
                    ...topStripSettings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('[Admin] Cores salvas no Firebase com sucesso!');
                
                // Tambem salvar no localStorage para o admin
                localStorage.setItem('siteColors', JSON.stringify(colors));
                let localBrand = {};
                try {
                    localBrand = JSON.parse(localStorage.getItem('siteBrand') || '{}');
                } catch (_e) {
                    localBrand = {};
                }
                const mergedLocalBrand = {
                    ...localBrand,
                    ...topStripSettings
                };
                localStorage.setItem('siteBrand', JSON.stringify(mergedLocalBrand));
                localStorage.setItem('publicSiteBrand', JSON.stringify(mergedLocalBrand));
                applyBrandToAdmin(mergedLocalBrand);
                
                showModal('Sucesso!', 'Cores salvas com sucesso!\n\nAs alteracoes foram aplicadas ao site publico.', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao salvar cores:', error);
                console.error('[Admin] Codigo do erro:', error.code);
                console.error('[Admin] Mensagem:', error.message);
                showModal('Erro!', 'Nao foi possivel salvar as cores.\n\nVerifique o console para mais detalhes.', 'error');
            }
        }

        // ========================================
        // CONFIGURAÃ‡ÃƒO DE LAYOUT
        // ========================================
        
        function updateLayoutPreview() {
            const cardsPerRow = parseInt(document.getElementById('cardsPerRow').value) || 3;
            const instagramPostsVisible = parseInt(document.getElementById('instagramPostsVisible')?.value) || 4;
            const previewGrid = document.getElementById('layoutPreviewGrid');
            
            // Limitar entre 1 e 6
            const validCards = Math.max(1, Math.min(6, cardsPerRow));
            const validInstagramPosts = Math.max(1, Math.min(12, instagramPostsVisible));
            const instagramInput = document.getElementById('instagramPostsVisible');
            if (instagramInput) instagramInput.value = validInstagramPosts;
            
            // Atualizar grid do preview
            previewGrid.style.gridTemplateColumns = `repeat(${validCards}, 1fr)`;
            
            // Atualizar numero de cards no preview
            previewGrid.innerHTML = '';
            for (let i = 0; i < validCards; i++) {
                previewGrid.innerHTML += '<div class="layout-preview-card"></div>';
            }
        }

        async function saveLayout() {
            const cardsPerRow = parseInt(document.getElementById('cardsPerRow').value) || 3;
            const instagramPostsVisible = parseInt(document.getElementById('instagramPostsVisible')?.value) || 4;
            const validCards = Math.max(1, Math.min(6, cardsPerRow));
            const validInstagramPosts = Math.max(1, Math.min(12, instagramPostsVisible));
            let savedLayout = {};
            try {
                savedLayout = JSON.parse(localStorage.getItem('siteLayout') || '{}');
            } catch (_e) {
                savedLayout = {};
            }
            
            const layoutConfig = {
                ...savedLayout,
                cardsPerRow: validCards,
                instagramPostsVisible: validInstagramPosts,
                updatedAt: new Date().toISOString()
            };
            
            try {
                await db.collection('settings').doc('layout').set({
                    cardsPerRow: validCards,
                    instagramPostsVisible: validInstagramPosts,
                    updatedAt: layoutConfig.updatedAt
                }, { merge: true });
                localStorage.setItem('siteLayout', JSON.stringify(layoutConfig));
                localStorage.setItem('publicSiteLayout', JSON.stringify(layoutConfig));
                showModal('Sucesso!', 'Layout salvo com sucesso!', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao salvar layout:', error);
                showModal('Erro!', 'Nao foi possivel salvar o layout.', 'error');
            }
        }

        async function loadLayout() {
            let layoutData = {};
            try {
                const doc = await db.collection('settings').doc('layout').get();
                if (doc.exists) {
                    layoutData = doc.data() || {};
                    const cardsPerRow = layoutData.cardsPerRow || 3;
                    const instagramPostsVisible = layoutData.instagramPostsVisible || 4;
                    document.getElementById('cardsPerRow').value = cardsPerRow;
                    const instagramInput = document.getElementById('instagramPostsVisible');
                    if (instagramInput) instagramInput.value = instagramPostsVisible;
                    updateLayoutPreview();
                } else {
                    const instagramInput = document.getElementById('instagramPostsVisible');
                    if (instagramInput) instagramInput.value = 4;
                }
            } catch (error) {
                console.log('[Admin] Erro ao carregar layout:', error);
                try {
                    layoutData = JSON.parse(localStorage.getItem('siteLayout') || '{}');
                } catch (_e) {
                    layoutData = {};
                }
            }
            applyTopBannersFromLayoutData(layoutData);
        }

        // ========================================
        // TOP BANNERS (SITE PUBLICO)
        // ========================================

        const TOP_BANNER_TRANSITIONS_ADMIN = ['fade', 'slide', 'zoom'];
        const TOP_BANNERS_DEFAULT_DISPLAY_ADMIN = 2;
        const TOP_BANNERS_MAX_DISPLAY_ADMIN = 20;
        const TOP_BANNERS_MOBILE_DEFAULTS_ADMIN = {
            transition: 'fade',
            intervalSeconds: 3
        };
        const TOP_BANNER_DEFAULT_SLOT_ADMIN = {
            mode: 'photos',
            transition: 'fade',
            intervalSeconds: 5,
            media: []
        };
        let topBannersSettingsAdmin = normalizeTopBannersSettingsAdmin({});

        function normalizeTopBannerMediaAdmin(entry) {
            if (typeof entry === 'string') {
                const url = entry.trim();
                return url ? { url, key: '', name: '', type: '' } : null;
            }
            if (!entry || typeof entry !== 'object') return null;
            const url = typeof entry.url === 'string' ? entry.url.trim() : '';
            if (!url) return null;
            return {
                url,
                key: typeof entry.key === 'string' ? entry.key : '',
                name: typeof entry.name === 'string' ? entry.name : '',
                type: typeof entry.type === 'string' ? entry.type : ''
            };
        }

        function normalizeTopBannerSlotAdmin(slot = {}) {
            const rawMode = String(slot.mode || TOP_BANNER_DEFAULT_SLOT_ADMIN.mode).toLowerCase();
            const mode = rawMode === 'gif' ? 'gif' : 'photos';
            const rawTransition = String(slot.transition || TOP_BANNER_DEFAULT_SLOT_ADMIN.transition).toLowerCase();
            const transition = TOP_BANNER_TRANSITIONS_ADMIN.includes(rawTransition)
                ? rawTransition
                : TOP_BANNER_DEFAULT_SLOT_ADMIN.transition;

            const rawInterval = Number(slot.intervalSeconds);
            const intervalSeconds = Math.max(
                1,
                Math.min(30, Number.isFinite(rawInterval) ? rawInterval : TOP_BANNER_DEFAULT_SLOT_ADMIN.intervalSeconds)
            );

            const sourceMedia = Array.isArray(slot.media)
                ? slot.media
                : Array.isArray(slot.images)
                    ? slot.images
                    : Array.isArray(slot.urls)
                        ? slot.urls
                        : [];

            const media = sourceMedia
                .map(normalizeTopBannerMediaAdmin)
                .filter(Boolean);

            if (media.length === 0) {
                const fallback = normalizeTopBannerMediaAdmin(slot.url || slot.gifUrl || '');
                if (fallback) media.push(fallback);
            }

            return {
                mode,
                transition,
                intervalSeconds,
                media: mode === 'gif' ? media.slice(0, 1) : media
            };
        }

        function normalizeTopBannersMobileSettingsAdmin(settings = {}) {
            const source = settings && typeof settings === 'object' ? settings : {};
            const rawTransition = String(source.transition || TOP_BANNERS_MOBILE_DEFAULTS_ADMIN.transition).toLowerCase();
            const transition = TOP_BANNER_TRANSITIONS_ADMIN.includes(rawTransition)
                ? rawTransition
                : TOP_BANNERS_MOBILE_DEFAULTS_ADMIN.transition;

            const rawInterval = Number(source.intervalSeconds);
            const intervalSeconds = Math.max(
                1,
                Math.min(30, Number.isFinite(rawInterval) ? rawInterval : TOP_BANNERS_MOBILE_DEFAULTS_ADMIN.intervalSeconds)
            );

            return {
                transition,
                intervalSeconds
            };
        }

        function normalizeTopBannersSettingsAdmin(settings = {}) {
            const source = settings && typeof settings === 'object' ? settings : {};
            const slotsArray = Array.isArray(source.slots) ? source.slots : [];
            const legacyItems = [
                source.slot1 || source.banner1 || source.left || null,
                source.slot2 || source.banner2 || source.right || null
            ].filter(Boolean);

            const sourceItems = Array.isArray(source.items)
                ? source.items
                : slotsArray.length > 0
                    ? slotsArray
                    : legacyItems;

            const items = sourceItems
                .map(normalizeTopBannerSlotAdmin)
                .filter(item => item && typeof item === 'object')
                .slice(0, TOP_BANNERS_MAX_DISPLAY_ADMIN);

            const rawDisplayCount = Number(source.displayCount);
            const fallbackDisplayCount = items.length > 0 ? items.length : TOP_BANNERS_DEFAULT_DISPLAY_ADMIN;
            const displayCount = Math.max(
                1,
                Math.min(
                    TOP_BANNERS_MAX_DISPLAY_ADMIN,
                    Number.isFinite(rawDisplayCount) ? Math.round(rawDisplayCount) : fallbackDisplayCount
                )
            );

            const nextItems = items.length > 0 ? [...items] : [];
            while (nextItems.length < Math.min(displayCount, TOP_BANNERS_MAX_DISPLAY_ADMIN)) {
                nextItems.push(normalizeTopBannerSlotAdmin({}));
            }
            if (nextItems.length === 0) {
                nextItems.push(normalizeTopBannerSlotAdmin({}));
            }

            return {
                displayCount,
                items: nextItems,
                mobile: normalizeTopBannersMobileSettingsAdmin(source.mobile || source.mobileCarousel || {})
            };
        }

        function getTopBannerPrefixAdmin(slotIndex) {
            return `topBannerSlot${slotIndex}`;
        }

        function normalizeTopBannerSlotIndexAdmin(slotIndex) {
            const parsed = Number(slotIndex);
            if (!Number.isFinite(parsed)) return -1;
            return Math.max(0, Math.floor(parsed));
        }

        function getTopBannerSlotAdmin(slotIndex) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return normalizeTopBannerSlotAdmin({});
            const slots = Array.isArray(topBannersSettingsAdmin.items) ? topBannersSettingsAdmin.items : [];
            return slots[normalizedIndex] || normalizeTopBannerSlotAdmin({});
        }

        function setTopBannersDisplayCountInputAdmin() {
            const input = document.getElementById('topBannersDisplayCount');
            if (!input) return;
            input.value = String(topBannersSettingsAdmin.displayCount || TOP_BANNERS_DEFAULT_DISPLAY_ADMIN);
        }

        function setTopBannersMobileInputsAdmin() {
            const transitionInput = document.getElementById('topBannersMobileTransition');
            const intervalInput = document.getElementById('topBannersMobileInterval');
            const mobile = normalizeTopBannersMobileSettingsAdmin(topBannersSettingsAdmin.mobile || {});

            if (transitionInput) transitionInput.value = mobile.transition;
            if (intervalInput) intervalInput.value = String(mobile.intervalSeconds);
        }

        function ensureTopBannerSlotsForDisplayAdmin() {
            const slots = Array.isArray(topBannersSettingsAdmin.items) ? topBannersSettingsAdmin.items : [];
            const target = Math.max(
                1,
                Math.min(
                    TOP_BANNERS_MAX_DISPLAY_ADMIN,
                    Number(topBannersSettingsAdmin.displayCount) || TOP_BANNERS_DEFAULT_DISPLAY_ADMIN
                )
            );

            while (slots.length < target && slots.length < TOP_BANNERS_MAX_DISPLAY_ADMIN) {
                slots.push(normalizeTopBannerSlotAdmin({}));
            }
            if (slots.length === 0) slots.push(normalizeTopBannerSlotAdmin({}));

            topBannersSettingsAdmin.items = slots.slice(0, TOP_BANNERS_MAX_DISPLAY_ADMIN);
            topBannersSettingsAdmin.displayCount = target;
        }

        function setTopBannerUploadStatusAdmin(slotIndex, message) {
            const prefix = getTopBannerPrefixAdmin(slotIndex);
            const statusEl = document.getElementById(`${prefix}UploadStatus`);
            if (statusEl) statusEl.textContent = message || '';
        }

        function updateTopBannerUploadModeAdmin(slotIndex) {
            const prefix = getTopBannerPrefixAdmin(slotIndex);
            const slot = getTopBannerSlotAdmin(slotIndex);
            const input = document.getElementById(`${prefix}Upload`);
            const hint = document.getElementById(`${prefix}UploadHint`);

            if (!input || !hint) return;

            if (slot.mode === 'gif') {
                input.multiple = false;
                hint.textContent = 'Em GIF: envie apenas 1 arquivo .gif';
            } else {
                input.multiple = true;
                hint.textContent = 'Em Fotos: pode enviar varias imagens';
            }
        }

        function renderTopBannerPreviewAdmin(slotIndex) {
            const prefix = getTopBannerPrefixAdmin(slotIndex);
            const previewEl = document.getElementById(`${prefix}Preview`);
            if (!previewEl) return;

            const slot = getTopBannerSlotAdmin(slotIndex);
            const media = Array.isArray(slot.media) ? slot.media : [];

            if (media.length === 0) {
                previewEl.innerHTML = '<div class="banner-preview-empty">Sem midia</div>';
                return;
            }

            const first = media[0];
            const countBadge = slot.mode === 'photos' && media.length > 1
                ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(15, 23, 42, 0.75); color: #fff; font-size: 0.6875rem; padding: 0.2rem 0.45rem; border-radius: 999px;">${media.length} fotos</div>`
                : '';

            previewEl.innerHTML = `
                <img src="${escapeHtml(first.url)}" alt="Preview banner" loading="lazy">
                ${countBadge}
            `;
        }

        function renderTopBannerMediaListAdmin(slotIndex) {
            const prefix = getTopBannerPrefixAdmin(slotIndex);
            const listEl = document.getElementById(`${prefix}MediaList`);
            if (!listEl) return;

            const slot = getTopBannerSlotAdmin(slotIndex);
            const media = Array.isArray(slot.media) ? slot.media : [];

            if (media.length === 0) {
                listEl.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-muted);">Nenhum arquivo enviado.</div>';
                return;
            }

            listEl.innerHTML = media.map((item, index) => {
                const name = item.name || item.key || `arquivo-${index + 1}`;
                const showOrderButtons = slot.mode === 'photos' && media.length > 1;
                return `
                    <div class="banner-media-item">
                        <div class="banner-media-thumb">
                            <img src="${escapeHtml(item.url)}" alt="${escapeHtml(name)}" loading="lazy">
                        </div>
                        <div class="banner-media-name" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
                        <div class="banner-media-actions">
                            ${showOrderButtons ? `<button type="button" class="banner-mini-btn" title="Mover para cima" onclick="moveTopBannerMedia(${slotIndex}, ${index}, -1)">↑</button>` : ''}
                            ${showOrderButtons ? `<button type="button" class="banner-mini-btn" title="Mover para baixo" onclick="moveTopBannerMedia(${slotIndex}, ${index}, 1)">↓</button>` : ''}
                            <button type="button" class="banner-mini-btn danger" title="Remover" onclick="removeTopBannerMedia(${slotIndex}, ${index})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buildTopBannerSlotCardMarkup(slot, slotIndex, totalSlots) {
            const prefix = getTopBannerPrefixAdmin(slotIndex);
            const removeButton = totalSlots > 1
                ? `<button type="button" class="banner-remove-slot-btn" onclick="removeTopBannerSlot(${slotIndex})">Remover</button>`
                : '';

            return `
                <article class="banner-slot-card">
                    <div class="banner-slot-head">
                        <div>
                            <div class="banner-slot-title">Banner ${slotIndex + 1}</div>
                            <span class="banner-slot-dim">Ordem ${slotIndex + 1}</span>
                        </div>
                        <div class="banner-slot-head-actions">
                            ${removeButton}
                        </div>
                    </div>

                    <div class="banner-field">
                        <label for="${prefix}Mode">Formato</label>
                        <select id="${prefix}Mode" onchange="handleTopBannerModeChange(${slotIndex})">
                            <option value="photos"${slot.mode === 'photos' ? ' selected' : ''}>Fotos (1 ou mais)</option>
                            <option value="gif"${slot.mode === 'gif' ? ' selected' : ''}>GIF (apenas 1 arquivo)</option>
                        </select>
                    </div>

                    <div class="banner-field">
                        <label for="${prefix}Transition">Transicao</label>
                        <select id="${prefix}Transition" onchange="handleTopBannerFieldChange(${slotIndex})">
                            <option value="fade"${slot.transition === 'fade' ? ' selected' : ''}>Fade</option>
                            <option value="slide"${slot.transition === 'slide' ? ' selected' : ''}>Slide</option>
                            <option value="zoom"${slot.transition === 'zoom' ? ' selected' : ''}>Zoom</option>
                        </select>
                    </div>

                    <div class="banner-field">
                        <label for="${prefix}Interval">Tempo entre transicoes (segundos)</label>
                        <input type="number" id="${prefix}Interval" min="1" max="30" value="${slot.intervalSeconds}" onchange="handleTopBannerFieldChange(${slotIndex})">
                    </div>

                    <div class="banner-field">
                        <label>Upload de midias</label>
                        <div class="banner-upload-dropzone" onclick="document.getElementById('${prefix}Upload').click()">
                            <input type="file" id="${prefix}Upload" accept="image/*" multiple style="display: none;" onchange="handleTopBannerUpload(${slotIndex}, event)">
                            <p>Clique para enviar arquivos</p>
                            <small id="${prefix}UploadHint">Em Fotos: pode enviar varias imagens</small>
                        </div>
                        <div id="${prefix}UploadStatus" class="banner-upload-status"></div>
                    </div>

                    <div class="banner-preview-box" id="${prefix}Preview"></div>
                    <div class="banner-media-list" id="${prefix}MediaList"></div>
                </article>
            `;
        }

        function renderTopBannersAdmin() {
            ensureTopBannerSlotsForDisplayAdmin();
            setTopBannersDisplayCountInputAdmin();
            setTopBannersMobileInputsAdmin();

            const container = document.getElementById('topBannersSlotsContainer');
            if (!container) return;

            const slots = Array.isArray(topBannersSettingsAdmin.items) ? topBannersSettingsAdmin.items : [];
            if (slots.length === 0) {
                container.innerHTML = '<div class="banner-slots-empty">Nenhum banner configurado.</div>';
                return;
            }

            container.innerHTML = slots
                .map((slot, index) => buildTopBannerSlotCardMarkup(slot, index, slots.length))
                .join('');

            slots.forEach((_slot, index) => {
                updateTopBannerUploadModeAdmin(index);
                renderTopBannerPreviewAdmin(index);
                renderTopBannerMediaListAdmin(index);
                setTopBannerUploadStatusAdmin(index, '');
            });
        }

        function updateTopBannerSlotAdmin(slotIndex, slotData) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;
            const slots = Array.isArray(topBannersSettingsAdmin.items) ? [...topBannersSettingsAdmin.items] : [];
            if (!slots[normalizedIndex]) return;
            slots[normalizedIndex] = normalizeTopBannerSlotAdmin(slotData);
            topBannersSettingsAdmin.items = slots;
        }

        function handleTopBannersDisplayCountChange() {
            const input = document.getElementById('topBannersDisplayCount');
            const nextValue = Number(input?.value);
            const clamped = Math.max(
                1,
                Math.min(
                    TOP_BANNERS_MAX_DISPLAY_ADMIN,
                    Number.isFinite(nextValue) ? Math.round(nextValue) : TOP_BANNERS_DEFAULT_DISPLAY_ADMIN
                )
            );
            topBannersSettingsAdmin.displayCount = clamped;
            ensureTopBannerSlotsForDisplayAdmin();
            renderTopBannersAdmin();
        }

        function handleTopBannersMobileSettingsChange() {
            const transitionInput = document.getElementById('topBannersMobileTransition');
            const intervalInput = document.getElementById('topBannersMobileInterval');
            const rawTransition = transitionInput ? transitionInput.value : TOP_BANNERS_MOBILE_DEFAULTS_ADMIN.transition;
            const rawInterval = intervalInput ? Number(intervalInput.value) : TOP_BANNERS_MOBILE_DEFAULTS_ADMIN.intervalSeconds;

            topBannersSettingsAdmin.mobile = normalizeTopBannersMobileSettingsAdmin({
                transition: rawTransition,
                intervalSeconds: rawInterval
            });

            if (intervalInput) {
                intervalInput.value = String(topBannersSettingsAdmin.mobile.intervalSeconds);
            }
        }

        function addTopBannerSlot() {
            const slots = Array.isArray(topBannersSettingsAdmin.items) ? [...topBannersSettingsAdmin.items] : [];
            if (slots.length >= TOP_BANNERS_MAX_DISPLAY_ADMIN) {
                showModal('Limite atingido', `Voce pode configurar no maximo ${TOP_BANNERS_MAX_DISPLAY_ADMIN} banners.`, 'info');
                return;
            }

            slots.push(normalizeTopBannerSlotAdmin({}));
            topBannersSettingsAdmin.items = slots;
            if (topBannersSettingsAdmin.displayCount < slots.length) {
                topBannersSettingsAdmin.displayCount = slots.length;
            }
            renderTopBannersAdmin();
        }

        function removeTopBannerSlot(slotIndex) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;
            if (!confirm(`Deseja remover o banner ${normalizedIndex + 1}?`)) return;

            const slots = Array.isArray(topBannersSettingsAdmin.items) ? [...topBannersSettingsAdmin.items] : [];
            if (!slots[normalizedIndex]) return;
            slots.splice(normalizedIndex, 1);

            if (slots.length === 0) {
                slots.push(normalizeTopBannerSlotAdmin({}));
            }

            topBannersSettingsAdmin.items = slots;
            topBannersSettingsAdmin.displayCount = Math.max(1, Math.min(topBannersSettingsAdmin.displayCount, slots.length));
            renderTopBannersAdmin();
        }

        function handleTopBannerFieldChange(slotIndex) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;

            const prefix = getTopBannerPrefixAdmin(normalizedIndex);
            const slot = getTopBannerSlotAdmin(normalizedIndex);

            const transitionInput = document.getElementById(`${prefix}Transition`);
            const intervalInput = document.getElementById(`${prefix}Interval`);

            const transition = transitionInput ? String(transitionInput.value || 'fade').toLowerCase() : slot.transition;
            const intervalValue = intervalInput ? Number(intervalInput.value) : slot.intervalSeconds;

            slot.transition = TOP_BANNER_TRANSITIONS_ADMIN.includes(transition) ? transition : 'fade';
            slot.intervalSeconds = Math.max(1, Math.min(30, Number.isFinite(intervalValue) ? intervalValue : 5));
            if (intervalInput) intervalInput.value = slot.intervalSeconds;

            updateTopBannerSlotAdmin(normalizedIndex, slot);
            renderTopBannerPreviewAdmin(normalizedIndex);
        }

        function handleTopBannerModeChange(slotIndex) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;

            const prefix = getTopBannerPrefixAdmin(normalizedIndex);
            const modeInput = document.getElementById(`${prefix}Mode`);
            const nextMode = modeInput && modeInput.value === 'gif' ? 'gif' : 'photos';
            const slot = getTopBannerSlotAdmin(normalizedIndex);
            slot.mode = nextMode;

            if (slot.mode === 'gif' && slot.media.length > 1) {
                slot.media = slot.media.slice(0, 1);
                showModal('Aviso', 'No formato GIF apenas um arquivo pode ficar no banner.', 'info');
            }

            updateTopBannerSlotAdmin(normalizedIndex, slot);
            renderTopBannersAdmin();
        }

        async function handleTopBannerUpload(slotIndex, event) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;

            const prefix = getTopBannerPrefixAdmin(normalizedIndex);
            const input = document.getElementById(`${prefix}Upload`);
            const slot = getTopBannerSlotAdmin(normalizedIndex);
            const files = Array.from(event?.target?.files || []);
            if (!files.length) return;

            if (!r2Client) initR2Client();

            const uploadFiles = slot.mode === 'gif' ? [files[0]] : files.slice(0, 20);
            const uploaded = [];

            try {
                for (let i = 0; i < uploadFiles.length; i += 1) {
                    const file = uploadFiles[i];
                    if (!file.type || !file.type.startsWith('image/')) {
                        continue;
                    }
                    const isGifFile = file.type === 'image/gif' || /\.gif$/i.test(file.name || '');

                    if (slot.mode === 'gif') {
                        if (!isGifFile) {
                            showModal('Erro', 'No formato GIF envie apenas arquivo .gif.', 'error');
                            continue;
                        }
                    } else if (isGifFile) {
                        showModal('Aviso', 'No formato Fotos envie imagens comuns (JPG, PNG, WebP, AVIF).', 'info');
                        continue;
                    }

                    setTopBannerUploadStatusAdmin(normalizedIndex, `Enviando ${i + 1}/${uploadFiles.length}...`);
                    const result = await r2Client.uploadFile(file, 'banners');
                    uploaded.push({
                        url: result?.url || '',
                        key: result?.key || '',
                        name: file.name || result?.key || 'arquivo',
                        type: file.type || result?.type || ''
                    });
                }

                if (uploaded.length === 0) {
                    setTopBannerUploadStatusAdmin(normalizedIndex, '');
                    if (input) input.value = '';
                    return;
                }

                if (slot.mode === 'gif') {
                    slot.media = [uploaded[0]];
                } else {
                    slot.media = [...slot.media, ...uploaded];
                }

                updateTopBannerSlotAdmin(normalizedIndex, slot);
                renderTopBannersAdmin();
                setTopBannerUploadStatusAdmin(normalizedIndex, `${uploaded.length} arquivo(s) enviado(s).`);
            } catch (error) {
                console.error('[Admin] Erro no upload de banner:', error);
                showModal('Erro', 'Nao foi possivel enviar a midia do banner.', 'error');
                setTopBannerUploadStatusAdmin(normalizedIndex, '');
            } finally {
                if (input) input.value = '';
            }
        }

        function moveTopBannerMedia(slotIndex, index, direction) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;
            const slot = getTopBannerSlotAdmin(normalizedIndex);
            const media = [...slot.media];
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= media.length) return;
            const [item] = media.splice(index, 1);
            media.splice(targetIndex, 0, item);
            slot.media = media;
            updateTopBannerSlotAdmin(normalizedIndex, slot);
            renderTopBannersAdmin();
        }

        function removeTopBannerMedia(slotIndex, index) {
            const normalizedIndex = normalizeTopBannerSlotIndexAdmin(slotIndex);
            if (normalizedIndex < 0) return;
            const slot = getTopBannerSlotAdmin(normalizedIndex);
            slot.media = slot.media.filter((_, itemIndex) => itemIndex !== index);
            updateTopBannerSlotAdmin(normalizedIndex, slot);
            renderTopBannersAdmin();
        }

        function syncTopBannerFieldsFromDomAdmin() {
            const slots = Array.isArray(topBannersSettingsAdmin.items) ? [...topBannersSettingsAdmin.items] : [];
            const normalizedSlots = slots.map((slot, index) => {
                const prefix = getTopBannerPrefixAdmin(index);
                const modeInput = document.getElementById(`${prefix}Mode`);
                const transitionInput = document.getElementById(`${prefix}Transition`);
                const intervalInput = document.getElementById(`${prefix}Interval`);

                const rawSlot = {
                    ...slot,
                    mode: modeInput && modeInput.value === 'gif' ? 'gif' : (slot.mode || 'photos'),
                    transition: transitionInput ? transitionInput.value : slot.transition,
                    intervalSeconds: intervalInput ? Number(intervalInput.value) : slot.intervalSeconds,
                    media: Array.isArray(slot.media) ? slot.media : []
                };
                return normalizeTopBannerSlotAdmin(rawSlot);
            });
            topBannersSettingsAdmin.items = normalizedSlots;
        }

        function buildTopBannersPayloadAdmin() {
            syncTopBannerFieldsFromDomAdmin();
            handleTopBannersMobileSettingsChange();
            const normalizedItems = (topBannersSettingsAdmin.items || [])
                .map(normalizeTopBannerSlotAdmin)
                .slice(0, TOP_BANNERS_MAX_DISPLAY_ADMIN);

            const displayCount = Math.max(
                1,
                Math.min(
                    TOP_BANNERS_MAX_DISPLAY_ADMIN,
                    Number(topBannersSettingsAdmin.displayCount) || TOP_BANNERS_DEFAULT_DISPLAY_ADMIN
                )
            );

            return {
                displayCount,
                items: normalizedItems,
                mobile: normalizeTopBannersMobileSettingsAdmin(topBannersSettingsAdmin.mobile || {}),
                slots: normalizedItems,
                slot1: normalizedItems[0] || normalizeTopBannerSlotAdmin({}),
                slot2: normalizedItems[1] || normalizeTopBannerSlotAdmin({}),
                updatedAt: new Date().toISOString()
            };
        }

        function applyTopBannersFromLayoutData(layoutData = {}) {
            const source = layoutData && typeof layoutData === 'object' ? layoutData.topBanners || {} : {};
            topBannersSettingsAdmin = normalizeTopBannersSettingsAdmin(source);
            renderTopBannersAdmin();
        }

        async function saveTopBannersSettings() {
            const payload = buildTopBannersPayloadAdmin();

            try {
                await db.collection('settings').doc('layout').set({
                    topBanners: payload,
                    updatedAt: payload.updatedAt
                }, { merge: true });

                let savedLayout = {};
                try {
                    savedLayout = JSON.parse(localStorage.getItem('siteLayout') || '{}');
                } catch (_e) {
                    savedLayout = {};
                }
                const nextLayout = {
                    ...savedLayout,
                    topBanners: payload,
                    updatedAt: payload.updatedAt
                };
                localStorage.setItem('siteLayout', JSON.stringify(nextLayout));
                localStorage.setItem('publicSiteLayout', JSON.stringify(nextLayout));

                topBannersSettingsAdmin = normalizeTopBannersSettingsAdmin(payload);
                renderTopBannersAdmin();
                showModal('Sucesso!', 'Banners salvos com sucesso!', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao salvar banners:', error);
                showModal('Erro!', 'Nao foi possivel salvar os banners.', 'error');
            }
        }

        function resetTopBannersSettings() {
            if (!confirm('Deseja limpar todos os banners?')) return;
            topBannersSettingsAdmin = normalizeTopBannersSettingsAdmin({});
            renderTopBannersAdmin();
        }

        // ========================================
        // LOGO E IDENTIDADE VISUAL
        // ========================================
        
        let currentLogo = null;

        // Inicializar configuracoes de marca ao carregar
        // DOMContentLoaded unificado
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar configuracoes de marca
            try {
                var savedBrand = localStorage.getItem('siteBrand');
                if (savedBrand) {
                    var settings = JSON.parse(savedBrand);
                    applyBrandToLogin(settings);
                }
            } catch(e) {
                console.log('Error loading brand settings:', e);
            }
            
            // Configurar upload de logo na pagina de configuracoes
            if (document.getElementById('logoUploadArea')) {
                loadBrandSettings();
                loadFooterLinks();
                setupLogoDragAndDrop();
            }
            
            // Configurar inputs de cor
            const colorInputs = [
                'Primary', 'Secondary', 'Accent', 'Background',
                'Muted', 'Foreground', 'MutedForeground', 'Header', 'HeaderText', 'Card', 'FooterText'
            ];
            colorInputs.forEach(name => {
                const colorInput = document.getElementById(`color${name}`);
                if (colorInput) {
                    colorInput.addEventListener('input', function () {
                        updatePreview();
                    });
                }
            });
        });

        // Configurar drag and drop para logo
        function setupLogoDragAndDrop() {
            const uploadArea = document.getElementById('logoUploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('drag-over');
                }, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleLogoFile(files[0]);
            }
        }

        // Processar upload de logo
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleLogoFile(file);
            }
        }

        async function handleLogoFile(file) {
            // Validar tipo de arquivo
            const validTypes = ['image/jpeg', 'image/png', 'image/svg+xml', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showModal('Formato invalido!', 'Use PNG, JPG, SVG ou WebP.', 'error');
                return;
            }

            // Validar tamanho (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showModal('Arquivo muito grande!', 'O tamanho maximo permitido e 2MB.', 'error');
                return;
            }

            const uploadArea = document.getElementById('logoUploadArea');
            const originalPointerEvents = uploadArea ? uploadArea.style.pointerEvents : '';
            if (uploadArea) uploadArea.style.pointerEvents = 'none';

            try {
                if (!r2Client) {
                    initR2Client();
                }

                const result = await r2Client.uploadFile(file, 'brand');
                const uploadedUrl = (result?.url || '').trim();
                if (!uploadedUrl) {
                    throw new Error('URL da logo nao retornada pelo R2');
                }

                currentLogo = uploadedUrl;
                updateLogoPreview(currentLogo);
                updateBrandPreview();
            } catch (error) {
                console.error('[Admin] Erro ao enviar logo para o R2:', error);
                showModal('Erro!', 'Nao foi possivel enviar a logo para o R2.', 'error');
            } finally {
                if (uploadArea) uploadArea.style.pointerEvents = originalPointerEvents;
                const logoInput = document.getElementById('logoInput');
                if (logoInput) logoInput.value = '';
            }
        }

        // Atualizar preview da logo
        function updateLogoPreview(logoData) {
            const uploadArea = document.getElementById('logoUploadArea');
            const placeholder = document.getElementById('uploadPlaceholder');
            const changePlaceholder = document.getElementById('uploadChangePlaceholder');
            const previewContainer = document.getElementById('logoPreviewContainer');
            const previewDark = document.getElementById('logoPreviewDark');
            const previewLight = document.getElementById('logoPreviewLight');

            uploadArea.classList.add('has-image');
            placeholder.style.display = 'none';
            changePlaceholder.style.display = 'flex';
            previewContainer.style.display = 'flex';

            previewDark.src = logoData;
            previewLight.src = logoData;
        }

        // Remover logo (via duplo clique ou tecla delete)
        function removeLogo() {
            currentLogo = null;
            
            const uploadArea = document.getElementById('logoUploadArea');
            const placeholder = document.getElementById('uploadPlaceholder');
            const changePlaceholder = document.getElementById('uploadChangePlaceholder');
            const previewContainer = document.getElementById('logoPreviewContainer');
            const logoInput = document.getElementById('logoInput');

            uploadArea.classList.remove('has-image');
            placeholder.style.display = 'block';
            changePlaceholder.style.display = 'none';
            previewContainer.style.display = 'none';
            logoInput.value = '';

            updateBrandPreview();
        }

        function normalizeHexColorAdmin(value) {
            const raw = String(value || '').trim();
            const match = raw.match(/^#([a-fA-F0-9]{3}|[a-fA-F0-9]{6})$/);
            if (!match) return '';
            const normalized = match[1].length === 3
                ? match[1].split('').map(ch => ch + ch).join('')
                : match[1];
            return `#${normalized.toUpperCase()}`;
        }

        function applySubheaderBrandDefaultsAdmin(settings = {}) {
            const siteNameValue = (document.getElementById('siteName')?.value || '').trim();
            const siteTaglineValue = (document.getElementById('siteTagline')?.value || '').trim();
            const titleInput = document.getElementById('topStripTitleText');
            const subtitleInput = document.getElementById('topStripSubtitleText');
            const bgColorInput = document.getElementById('topStripBgColor');
            const textColorInput = document.getElementById('topStripTextColor');

            const topStripTitle = String(settings.topStripTitleText || '').trim() || siteNameValue || 'Mirador e Regiao Online';
            const topStripSubtitle = String(settings.topStripSubtitleText || '').trim() || siteTaglineValue || 'Portal de Noticias';
            const topStripBgColor = normalizeHexColorAdmin(settings.topStripBgColor) || '#2A0F33';
            const topStripTextColor = normalizeHexColorAdmin(settings.topStripTextColor) || '#FFFFFF';

            if (titleInput) titleInput.value = topStripTitle;
            if (subtitleInput) subtitleInput.value = topStripSubtitle;
            if (bgColorInput) bgColorInput.value = topStripBgColor;
            if (textColorInput) textColorInput.value = topStripTextColor;
        }

        // Atualizar preview da marca em tempo real
        document.getElementById('siteName')?.addEventListener('input', updateBrandPreview);
        document.getElementById('siteTagline')?.addEventListener('input', updateBrandPreview);

        function updateBrandPreview() {
            const siteName = document.getElementById('siteName').value || 'Mirador Online';
            const siteTagline = document.getElementById('siteTagline').value || 'Portal de Noticias';
            
            const previewIconMode = document.getElementById('brandPreviewIconMode');
            const previewLogoMode = document.getElementById('brandPreviewLogoMode');
            const previewIcon = document.getElementById('brandPreviewIcon');
            const previewLogo = document.getElementById('brandPreviewLogo');
            const previewLogoTagline = document.getElementById('brandPreviewLogoTagline');

            if (currentLogo) {
                // Modo com logo
                if (previewIconMode) previewIconMode.style.display = 'none';
                if (previewLogoMode) {
                    previewLogoMode.style.display = 'flex';
                    previewLogo.src = currentLogo;
                    previewLogo.alt = siteName;
                }
                if (previewLogoTagline) previewLogoTagline.textContent = siteTagline;
            } else {
                // Modo sem logo
                if (previewIconMode) previewIconMode.style.display = 'flex';
                if (previewLogoMode) previewLogoMode.style.display = 'none';
                
                const previewName = document.getElementById('brandPreviewName');
                const previewTagline = document.getElementById('brandPreviewTagline');
                if (previewName) previewName.textContent = siteName;
                if (previewTagline) previewTagline.textContent = siteTagline;
                if (previewIcon) previewIcon.textContent = siteName.charAt(0).toUpperCase();
            }
        }

        // Salvar configuracoes de marca no Firebase
        async function saveBrand() {
            let finalLogo = currentLogo;
            if (isInlineImageDataUrl(finalLogo)) {
                try {
                    if (!r2Client) initR2Client();
                    const logoFile = await dataUrlToFile(finalLogo, `brand-logo-${Date.now()}.jpg`);
                    const uploadResult = await r2Client.uploadFile(logoFile, 'brand');
                    finalLogo = (uploadResult?.url || '').trim();
                    currentLogo = finalLogo || null;
                    if (finalLogo) {
                        updateLogoPreview(finalLogo);
                    }
                } catch (uploadError) {
                    console.error('[Admin] Erro ao migrar logo inline para R2:', uploadError);
                    showModal('Erro!', 'Nao foi possivel enviar a logo para o R2.', 'error');
                    return;
                }
            }

            const topStripBgColor = normalizeHexColorAdmin(document.getElementById('topStripBgColor')?.value) || '#2A0F33';
            const topStripTextColor = normalizeHexColorAdmin(document.getElementById('topStripTextColor')?.value) || '#FFFFFF';
            const brandSettings = {
                siteName: document.getElementById('siteName').value || 'Mirador Online',
                siteTagline: document.getElementById('siteTagline').value || 'Portal de Noticias',
                topStripTitleText: (document.getElementById('topStripTitleText')?.value || '').trim(),
                topStripSubtitleText: (document.getElementById('topStripSubtitleText')?.value || '').trim(),
                topStripBgColor,
                topStripTextColor,
                logo: finalLogo || null,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            console.log('[Admin] Salvando marca:', {
                ...brandSettings,
                logo: brandSettings.logo ? '[R2_URL]' : null
            });

            try {
                // Salvar no Firebase Firestore
                await db.collection('settings').doc('brand').set(brandSettings);
                console.log('[Admin] Marca salva no Firebase com sucesso!');
                
                // Tambem salvar no localStorage para o admin
                localStorage.setItem('siteBrand', JSON.stringify(brandSettings));

                // Aplicar imediatamente no admin
                applyBrandToAdmin(brandSettings);

                showModal('Sucesso!', 'Identidade visual salva com sucesso!\n\nAs alteracoes foram aplicadas ao site publico e ao painel.', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao salvar identidade visual:', error);
                console.error('[Admin] Codigo do erro:', error.code);
                console.error('[Admin] Mensagem:', error.message);
                showModal('Erro!', 'Nao foi possivel salvar a identidade visual.\n\nVerifique o console para mais detalhes.', 'error');
            }
        }

        // Carregar configuracoes de marca
        function loadBrandSettings() {
            const savedBrand = localStorage.getItem('siteBrand');
            if (savedBrand) {
                try {
                    const settings = JSON.parse(savedBrand);
                    
                    document.getElementById('siteName').value = settings.siteName || 'Mirador Online';
                    document.getElementById('siteTagline').value = settings.siteTagline || 'Portal de Noticias';
                    applySubheaderBrandDefaultsAdmin(settings);
                    
                    if (settings.logo) {
                        currentLogo = settings.logo;
                        updateLogoPreview(settings.logo);
                    }

                    applyBrandToAdmin(settings);
                } catch (error) {
                    console.error('[Admin] Erro ao carregar identidade visual salva:', error);
                    applySubheaderBrandDefaultsAdmin();
                }
            } else {
                applySubheaderBrandDefaultsAdmin();
            }
            updateBrandPreview();
        }

        // Salvar configuracoes de links do rodape
        async function saveFooterLinks() {
            const defaultTermsText = [
                '1. O conteudo publicado neste portal e de uso informativo e jornalistico.',
                '2. E proibida a reproducao integral sem autorizacao previa da redacao.',
                '3. Comentarios e contribuicoes de leitores devem respeitar a legislacao vigente.',
                '4. O portal pode atualizar, corrigir ou remover publicacoes a qualquer momento para manter a qualidade editorial.',
                '5. Ao navegar no site, o usuario concorda com estes termos e com as politicas aplicaveis.'
            ].join('\n');

            const footerLinks = {
                aboutText: document.getElementById('footerAboutText').value || '',
                contactText: document.getElementById('footerContactText').value || '',
                contactPhone: document.getElementById('footerContactPhone').value || '',
                contactEmail: document.getElementById('footerContactEmail').value || '',
                privacyText: document.getElementById('footerPrivacyText').value || '',
                termsText: defaultTermsText,
                social: {
                    instagram: document.getElementById('footerSocialInstagram').value || '',
                    facebook: document.getElementById('footerSocialFacebook').value || '',
                    twitter: document.getElementById('footerSocialTwitter').value || '',
                    youtube: document.getElementById('footerSocialYoutube').value || ''
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('settings').doc('footer').set(footerLinks);
                localStorage.setItem('siteFooterLinks', JSON.stringify(footerLinks));
                showModal('Sucesso!', 'Informacoes do rodape salvas com sucesso!', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao salvar links:', error);
                showModal('Erro!', 'Nao foi possivel salvar os links.', 'error');
            }
        }

        // Carregar configuracoes de links do rodape
        async function loadFooterLinks() {
            try {
                const doc = await db.collection('settings').doc('footer').get();
                if (doc.exists) {
                    const links = doc.data();
                    document.getElementById('footerAboutText').value = links.aboutText || '';
                    document.getElementById('footerContactText').value = links.contactText || links.contact || '';
                    document.getElementById('footerContactPhone').value = links.contactPhone || links.phone || '';
                    document.getElementById('footerContactEmail').value = links.contactEmail || links.email || '';
                    document.getElementById('footerPrivacyText').value = links.privacyText || '';
                    if (links.social) {
                        document.getElementById('footerSocialInstagram').value = links.social.instagram || '';
                        document.getElementById('footerSocialFacebook').value = links.social.facebook || '';
                        document.getElementById('footerSocialTwitter').value = links.social.twitter || '';
                        document.getElementById('footerSocialYoutube').value = links.social.youtube || '';
                    }
                    localStorage.setItem('siteFooterLinks', JSON.stringify(links));
                }
            } catch (error) {
                console.error('[Admin] Erro ao carregar links:', error);
            }
        }

        // Restaurar links padrao
        function resetFooterLinks() {
            document.getElementById('footerAboutText').value = 'O portal nasceu para informar Mirador e toda a regiao com responsabilidade, agilidade e linguagem clara para a comunidade.';
            document.getElementById('footerContactText').value = '';
            document.getElementById('footerContactPhone').value = '';
            document.getElementById('footerContactEmail').value = '';
            document.getElementById('footerPrivacyText').value = 'Utilizamos dados minimos de navegacao para melhorar a experiencia do usuario. Nao comercializamos dados pessoais.';
            document.getElementById('footerSocialInstagram').value = '';
            document.getElementById('footerSocialFacebook').value = '';
            document.getElementById('footerSocialTwitter').value = '';
            document.getElementById('footerSocialYoutube').value = '';
        }

        // Aplicar marca ao painel admin
        function applyBrandToAdmin(settings) {
            const siteName = settings.siteName || 'Mirador Online';
            const siteTagline = settings.siteTagline || 'Portal de Noticias';
            
            const sidebarIconMode = document.getElementById('sidebarIconMode');
            const sidebarLogoMode = document.getElementById('sidebarLogoMode');
            const sidebarIcon = document.getElementById('sidebarIcon');
            const sidebarLogo = document.getElementById('sidebarLogo');
            const sidebarLogoTagline = document.getElementById('sidebarLogoTagline');

            if (settings.logo && sidebarLogo) {
                // Modo com logo: mostrar so logo + tagline
                if (sidebarIconMode) sidebarIconMode.style.display = 'none';
                if (sidebarLogoMode) {
                    sidebarLogoMode.style.display = 'flex';
                    sidebarLogo.src = settings.logo;
                    sidebarLogo.alt = siteName;
                }
                if (sidebarLogoTagline) sidebarLogoTagline.textContent = siteTagline;
            } else {
                // Modo sem logo: mostrar icone + nome + tagline
                if (sidebarIconMode) sidebarIconMode.style.display = 'flex';
                if (sidebarLogoMode) sidebarLogoMode.style.display = 'none';
                if (sidebarIcon) {
                    sidebarIcon.textContent = siteName.charAt(0).toUpperCase();
                }
                const sidebarBrandText = document.getElementById('sidebarBrandText');
                const sidebarTagline = document.getElementById('sidebarTagline');
                if (sidebarBrandText) sidebarBrandText.textContent = siteName;
                if (sidebarTagline) sidebarTagline.textContent = siteTagline;
            }

            // Atualizar titulo da pagina
            document.title = `Admin - ${siteName}`;
        }

        // Aplicar marca na pagina de login
        function applyBrandToLogin(settings) {
            if (!settings) return;
            
            var siteName = settings.siteName || 'Mirador Online';
            var siteTagline = settings.siteTagline || 'Portal de Noticias';
            
            var loginLogoIcon = document.getElementById('loginLogoIcon');
            var loginLogoImg = document.getElementById('loginLogoImg');
            var loginTitle = document.getElementById('loginTitle');
            var loginSubtitle = document.getElementById('loginSubtitle');

            try {
                if (settings.logo && loginLogoImg) {
                    // Com logo: mostra logo
                    if (loginLogoIcon) loginLogoIcon.style.display = 'none';
                    loginLogoImg.src = settings.logo;
                    loginLogoImg.style.display = 'block';
                } else {
                    // Sem logo: mostra icone com inicial
                    if (loginLogoIcon) {
                        loginLogoIcon.style.display = 'flex';
                        loginLogoIcon.textContent = siteName.charAt(0).toUpperCase();
                    }
                    if (loginLogoImg) loginLogoImg.style.display = 'none';
                }
                
                if (loginTitle) loginTitle.textContent = 'Painel Administrativo';
                if (loginSubtitle) loginSubtitle.textContent = siteName;
                
                document.title = 'Admin - ' + siteName;
            } catch(e) {
                console.log('Error applying brand to login:', e);
            }
        }

        // Restaurar marca padrao
        function resetBrand() {
            if (!confirm('Deseja restaurar a identidade visual padrao?')) return;

            currentLogo = null;
            document.getElementById('siteName').value = 'Mirador Online';
            document.getElementById('siteTagline').value = 'Portal de Noticias';
            
            // Limpar preview
            const uploadArea = document.getElementById('logoUploadArea');
            const placeholder = document.getElementById('uploadPlaceholder');
            const changePlaceholder = document.getElementById('uploadChangePlaceholder');
            const previewContainer = document.getElementById('logoPreviewContainer');

            uploadArea.classList.remove('has-image');
            placeholder.style.display = 'block';
            changePlaceholder.style.display = 'none';
            previewContainer.style.display = 'none';
            document.getElementById('logoInput').value = '';

            // Aplicar padrao
            const defaultBrand = {
                siteName: 'Mirador Online',
                siteTagline: 'Portal de Noticias',
                topStripTitleText: 'Mirador e Regiao Online',
                topStripSubtitleText: 'Portal de Noticias',
                topStripBgColor: '#2A0F33',
                topStripTextColor: '#FFFFFF',
                logo: null
            };

            applySubheaderBrandDefaultsAdmin(defaultBrand);
            applyBrandToAdmin(defaultBrand);
            updateBrandPreview();

            localStorage.removeItem('siteBrand');
            localStorage.removeItem('publicSiteBrand');

            showModal('Restaurado!', 'Identidade visual restaurada para o padrao.', 'info');
        }

        // Restaurar cores padrao
        function resetColors() {
            if (!confirm('Deseja restaurar as cores padrao?')) return;

            const defaultColors = {
                Primary: '#2563eb',
                Secondary: '#64748b',
                Accent: '#f8fafc',
                Background: '#ffffff',
                Muted: '#f1f5f9',
                Foreground: '#0f172a',
                MutedForeground: '#64748b',
                Header: '#ffffff',
                HeaderText: '#0f172a',
                Card: '#ffffff',
                FooterText: '#64748b'
            };

            Object.keys(defaultColors).forEach(key => {
                const colorInput = document.getElementById(`color${key}`);
                if (colorInput) {
                    colorInput.value = defaultColors[key];
                }
            });
            const topStripBgColorInput = document.getElementById('topStripBgColor');
            const topStripTextColorInput = document.getElementById('topStripTextColor');
            if (topStripBgColorInput) topStripBgColorInput.value = '#2A0F33';
            if (topStripTextColorInput) topStripTextColorInput.value = '#FFFFFF';

            updatePreview();
            localStorage.removeItem('siteColors');
            localStorage.removeItem('publicSiteColors');

            showModal('Restaurado!', 'Cores restauradas para o padrao.', 'info');
        }

        // Sincronizar color pickers - movido para DOMContentLoaded unificado

        // ========================================
        // NEWS EDITOR FUNCTIONS
        // ========================================
        let currentNewsImage = null;
        let editingNewsId = null;

        // Mostrar pagina de criar noticia
        // ========================================
        // IMPORTAR NOTÃCIA POR URL
        // ========================================
        let importedNewsData = null;

        function handleImportUrlPaste(e) {
            setTimeout(() => {
                const url = e.target.value;
                if (url && isValidUrl(url)) {
                    fetchNewsFromUrl();
                }
            }, 100);
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function clearImportUrl() {
            document.getElementById('importUrlInput').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importLoading').classList.remove('active');
            importedNewsData = null;
            
            // Resetar campos editaveis
            const editHint = document.getElementById('editHint');
            const previewTitle = document.getElementById('importPreviewTitle');
            const previewExcerpt = document.getElementById('importPreviewExcerpt');
            
            if (editHint) editHint.style.display = 'none';
            if (previewTitle) {
                previewTitle.contentEditable = false;
                previewTitle.style.border = '1px solid transparent';
                previewTitle.style.cursor = 'default';
            }
            if (previewExcerpt) {
                previewExcerpt.contentEditable = false;
                previewExcerpt.style.border = '1px solid transparent';
                previewExcerpt.style.cursor = 'default';
            }
        }

        function cancelImport() {
            clearImportUrl();
        }

        // Lista de APIs para tentar extrair dados
        const SCRAPER_APIS = [
            (url) => `https://api.microlink.io/?url=${encodeURIComponent(url)}`,
            (url) => `https://api.linkpreview.net/?key=8d7d5f7e8c7d5f7e8c7d5f7e8c7d5f7e&q=${encodeURIComponent(url)}`,
            (url) => `https://jsonlink.io/api/extract?url=${encodeURIComponent(url)}`,
        ];

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function tryExtractData(url) {
            const urlObj = new URL(url);
            const domain = urlObj.hostname.replace(/^www\./i, '');
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            
            // Tentar cada API em sequencia
            for (const getApiUrl of SCRAPER_APIS) {
                try {
                    const apiUrl = getApiUrl(url);
                    const response = await fetchWithTimeout(apiUrl, 8000);
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    
                    // Microlink
                    if (data.status === 'success' && data.data) {
                        return {
                            title: data.data.title,
                            description: data.data.description,
                            image: data.data.image?.url || data.data.logo?.url,
                            domain: domain,
                            favicon: faviconUrl
                        };
                    }
                    
                    // LinkPreview
                    if (data.title) {
                        return {
                            title: data.title,
                            description: data.description,
                            image: data.image,
                            domain: domain,
                            favicon: faviconUrl
                        };
                    }
                    
                    // JSONLink
                    if (data.meta?.title) {
                        return {
                            title: data.meta.title,
                            description: data.meta.description,
                            image: data.images?.[0],
                            domain: domain,
                            favicon: faviconUrl
                        };
                    }
                } catch (e) {
                    console.log('API falhou:', e.message);
                    continue;
                }
            }
            
            // Se todas falharem, retornar dados basicos
            return {
                title: null,
                description: null,
                image: null,
                domain: domain,
                favicon: faviconUrl
            };
        }

        async function fetchNewsFromUrl() {
            const urlInput = document.getElementById('importUrlInput');
            const url = urlInput.value.trim();
            
            if (!url || !isValidUrl(url)) {
                showModal('URL Invalida', 'Por favor, insira uma URL valida.', 'error');
                return;
            }

            const loading = document.getElementById('importLoading');
            const preview = document.getElementById('importPreview');
            
            loading.classList.add('active');
            preview.style.display = 'none';

            try {
                const extractedData = await tryExtractData(url);
                const urlObj = new URL(url);
                const domain = extractedData.domain || urlObj.hostname.replace(/^www\./i, '');
                
                // Tentar extrair titulo da URL se nao encontrado
                let title = extractedData.title;
                if (!title || title.trim() === '') {
                    // Extrair do pathname da URL
                    const pathParts = urlObj.pathname.split('/').filter(p => p.length > 3);
                    if (pathParts.length > 0) {
                        title = pathParts[pathParts.length - 1]
                            .replace(/-/g, ' ')
                            .replace(/_/g, ' ')
                            .replace(/\.html?$/i, '')
                            .replace(/\.php$/i, '')
                            .trim();
                        // Capitalizar primeira letra
                        title = title.charAt(0).toUpperCase() + title.slice(1);
                    }
                }
                
                // Se ainda nao tiver titulo, usar o dominio
                if (!title || title.trim() === '') {
                    title = 'Noticia de ' + domain;
                }
                
                // Tentar pegar descricao de meta tags se nao tiver
                let description = extractedData.description;
                if (!description || description.trim() === '') {
                    description = 'Leia a noticia completa no site ' + domain;
                }
                
                importedNewsData = {
                    title: title,
                    excerpt: description,
                    image: extractedData.image || '',
                    externalUrl: url,
                    sourceDomain: domain,
                    sourceFavicon: extractedData.favicon || `https://www.google.com/s2/favicons?domain=${domain}&sz=128`,
                    date: new Date().toISOString(),
                    category: 'geral',
                    status: 'published',
                    isImported: true
                };

                // Mostrar preview
                document.getElementById('importPreviewImage').src = importedNewsData.image || 'https://via.placeholder.com/800x400?text=Sem+Imagem';
                document.getElementById('importPreviewTitle').textContent = importedNewsData.title;
                document.getElementById('importPreviewExcerpt').textContent = importedNewsData.excerpt;
                document.getElementById('importPreviewSourceLogo').src = importedNewsData.sourceFavicon;
                document.getElementById('importPreviewSourceName').textContent = domain;
                document.getElementById('importPreviewDate').textContent = new Date().toLocaleDateString('pt-BR');
                
                loading.classList.remove('active');
                preview.style.display = 'block';
                
                // Se os dados estiverem incompletos, mostrar aviso mas permitir editar
                if (!extractedData.title || !extractedData.description) {
                    showEditFields();
                }
                
            } catch (error) {
                console.error('Erro ao importar noticia:', error);
                loading.classList.remove('active');
                showModal('Erro', 'Nao foi possivel importar a noticia. Verifique a URL e tente novamente.', 'error');
            }
        }
        
        // Mostrar campos de edicao para dados incompletos
        function showEditFields() {
            // Mostrar hint de edicao
            const editHint = document.getElementById('editHint');
            if (editHint) editHint.style.display = 'inline-flex';
            
            // Adicionar campos editaveis no preview
            const previewTitle = document.getElementById('importPreviewTitle');
            const previewExcerpt = document.getElementById('importPreviewExcerpt');
            
            previewTitle.contentEditable = true;
            previewTitle.style.border = '1px dashed var(--primary-light)';
            previewTitle.title = 'Clique para editar o titulo';
            previewTitle.style.cursor = 'text';
            
            previewExcerpt.contentEditable = true;
            previewExcerpt.style.border = '1px dashed var(--primary-light)';
            previewExcerpt.title = 'Clique para editar a descricao';
            previewExcerpt.style.cursor = 'text';
            
            // Efeito hover
            previewTitle.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
            });
            previewTitle.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });
            previewExcerpt.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
            });
            previewExcerpt.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });
            
            // Atualizar dados ao editar
            previewTitle.addEventListener('blur', function() {
                importedNewsData.title = this.textContent.trim();
            });
            
            previewExcerpt.addEventListener('blur', function() {
                importedNewsData.excerpt = this.textContent.trim();
            });
            
            // Impedir Enter no titulo (criar nova linha)
            previewTitle.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            });
        }

        async function saveImportedNews() {
            if (!importedNewsData) {
                showModal('Erro', 'Nenhuma noticia para importar.', 'error');
                return;
            }

            const category = document.getElementById('importNewsCategory').value;
            if (!category) {
                showModal('Categoria Obrigatoria', 'Por favor, selecione uma categoria para a noticia.', 'warning');
                return;
            }

            try {
                const newsData = {
                    ...importedNewsData,
                    category: category,
                    categoryName: document.querySelector(`#importNewsCategory option[value="${category}"]`).textContent,
                    source: importedNewsData.source || 'Importacao URL',
                    importMethod: 'url',
                    views: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('news').add(newsData);
                
                showModal('Sucesso!', 'Noticia importada e publicada com sucesso!', 'success');
                
                // Limpar formulario e atualizar listas
                setTimeout(() => {
                    clearImportUrl();
                    loadImportedNewsPage();
                    loadNewsPage();
                    loadDashboard();
                }, 1500);
            } catch (error) {
                console.error('Erro ao salvar noticia importada:', error);
                showModal('Erro', 'Nao foi possivel salvar a noticia. Tente novamente.', 'error');
            }
        }

        // ========================================
        // NEWS EDITOR FUNCTIONS
        // ========================================
        function showCreateNewsPage(newsId = null) {
            // Esconder todas as paginas
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // Mostrar pagina do editor
            document.getElementById('createNewsPage').style.display = 'block';
            
            // Resetar formulario se for nova noticia
            if (!newsId) {
                resetNewsForm();
                document.getElementById('editorPageTitle').textContent = 'Nova Noticia';
            } else {
                editingNewsId = newsId;
                document.getElementById('editorPageTitle').textContent = 'Editar Noticia';
                loadNewsForEdit(newsId);
            }
            
            // Definir data atual
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('newsDate').value = now.toISOString().slice(0, 16);
            
            // Contador de caracteres
            document.getElementById('newsExcerpt').addEventListener('input', function() {
                document.getElementById('excerptCount').textContent = this.value.length;
            });
        }

        // Resetar formulario
        function resetNewsForm() {
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsSlug').value = '';
            document.getElementById('editorContent').innerHTML = '';
            document.getElementById('newsExcerpt').value = '';
            document.getElementById('excerptCount').textContent = '0';
            document.getElementById('newsCategory').value = '';
            document.getElementById('newsAuthor').value = 'Redacao';
            document.getElementById('newsTags').value = '';
            if (document.getElementById('newsExternalUrl')) {
                document.getElementById('newsExternalUrl').value = '';
            }
            const externalHint = document.getElementById('newsExternalDomainHint');
            if (externalHint) externalHint.textContent = '';
            document.querySelector('input[name="newsStatus"][value="published"]').checked = true;
            removeNewsImage();
            editingNewsId = null;
        }

        // Gerar slug do titulo
        function generateSlug() {
            const title = document.getElementById('newsTitle').value;
            const slug = title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 100);
            document.getElementById('newsSlug').value = slug;
        }

        // Formatar texto no editor
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editorContent').focus();
        }

        // Upload de imagem da noticia
        async function handleNewsImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type || !file.type.startsWith('image/')) {
                showModal('Erro!', 'Arquivo invalido. Use apenas imagem.', 'error');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showModal('Erro!', 'Imagem muito grande. Maximo 2MB.', 'error');
                return;
            }

            const uploadArea = document.querySelector('.featured-image-upload');
            const imagePreview = document.getElementById('newsImagePreview');
            const removeBtn = document.getElementById('removeImageBtn');
            const inputEl = document.getElementById('newsImageInput');
            const originalUploadHtml = uploadArea ? uploadArea.innerHTML : '';

            try {
                if (uploadArea) {
                    uploadArea.style.pointerEvents = 'none';
                    uploadArea.innerHTML = `
                        <div style="padding: 1.25rem; text-align: center;">
                            <div style="width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.5rem;"></div>
                            <div style="font-size: 0.8125rem; color: var(--text-muted);">Enviando imagem para o R2...</div>
                        </div>
                    `;
                }

                if (!r2Client) {
                    initR2Client();
                }

                const compressedDataUrl = await compressImage(file, 1400, 1400, 0.8);
                const uploadFile = await dataUrlToFile(compressedDataUrl, `${Date.now()}-noticia.jpg`);
                const result = await r2Client.uploadFile(uploadFile, 'noticias');
                const imageUrl = (result?.url || '').trim();

                if (!imageUrl) {
                    throw new Error('URL da imagem nao retornada pelo R2');
                }

                currentNewsImage = imageUrl;
                if (imagePreview) {
                    imagePreview.src = imageUrl;
                    imagePreview.style.display = 'block';
                }
                if (removeBtn) removeBtn.style.display = 'block';
                if (uploadArea) uploadArea.style.display = 'none';
            } catch (error) {
                console.error('[Admin] Erro ao enviar imagem da noticia para o R2:', error);
                showModal('Erro!', 'Nao foi possivel enviar a imagem para o R2.', 'error');
            } finally {
                if (uploadArea) {
                    uploadArea.innerHTML = originalUploadHtml;
                    uploadArea.style.pointerEvents = '';
                }
                if (inputEl) inputEl.value = '';
            }
        }

        // Remover imagem
        function removeNewsImage() {
            currentNewsImage = null;
            document.getElementById('newsImagePreview').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'none';
            document.querySelector('.featured-image-upload').style.display = 'block';
            document.getElementById('newsImageInput').value = '';
        }

        // Salvar rascunho
        async function saveNewsDraft() {
            await saveNews('draft');
        }

        // Publicar noticia
        async function publishNews() {
            await saveNews('published');
        }

        // Salvar noticia
        async function saveNews(status) {
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('editorContent').innerHTML.trim();
            const category = document.getElementById('newsCategory').value;
            const externalUrl = document.getElementById('newsExternalUrl')?.value.trim() || '';
            const sourceDomain = normalizeDomainFromUrl(externalUrl);

            if (!title) {
                showModal('Erro!', 'O titulo e obrigatorio.', 'error');
                return;
            }

            if ((!content || content === '<br>') && !externalUrl) {
                showModal('Erro!', 'O conteudo e obrigatorio.', 'error');
                return;
            }

            if (externalUrl && !sourceDomain) {
                showModal('Erro!', 'URL externa invalida.', 'error');
                return;
            }

            if (!category) {
                showModal('Erro!', 'Selecione uma categoria.', 'error');
                return;
            }

            let finalNewsImage = currentNewsImage;
            if (isInlineImageDataUrl(finalNewsImage)) {
                try {
                    if (!r2Client) initR2Client();
                    const imageFile = await dataUrlToFile(finalNewsImage, `${Date.now()}-noticia.jpg`);
                    const uploadResult = await r2Client.uploadFile(imageFile, 'noticias');
                    finalNewsImage = (uploadResult?.url || '').trim();
                    currentNewsImage = finalNewsImage || null;
                } catch (uploadError) {
                    console.error('[Admin] Erro ao migrar imagem inline da noticia para R2:', uploadError);
                    showModal('Erro!', 'Nao foi possivel enviar a imagem da noticia para o R2.', 'error');
                    return;
                }
            }

            const newsData = {
                title: title,
                slug: document.getElementById('newsSlug').value || generateSlugFromTitle(title),
                content: content,
                excerpt: document.getElementById('newsExcerpt').value.trim(),
                category: category,
                categoryName: getCategoryName(category),
                image: finalNewsImage || '',
                author: document.getElementById('newsAuthor').value || 'Redacao',
                tags: document.getElementById('newsTags').value.split(',').map(t => t.trim()).filter(t => t),
                status: status,
                featured: false,
                date: new Date(document.getElementById('newsDate').value).toISOString(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                externalUrl: externalUrl,
                sourceDomain: sourceDomain
            };

            try {
                if (editingNewsId) {
                    await db.collection('news').doc(editingNewsId).update(newsData);
                    showModal('Sucesso!', `Noticia atualizada como ${status === 'published' ? 'Publicada' : 'Rascunho'}!`, 'success');
                } else {
                    newsData.views = 0;
                    newsData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('news').add(newsData);
                    showModal('Sucesso!', `Noticia ${status === 'published' ? 'Publicada' : 'Salva como Rascunho'}!`, 'success');
                }
                
                resetNewsForm();
                showPage('news', document.querySelectorAll('.nav-item')[1]);
                loadNewsPage();
                loadImportedNewsPage();
                loadDashboard();
            } catch (error) {
                console.error('Erro ao salvar noticia:', error);
                showModal('Erro!', 'Nao foi possivel salvar a noticia.', 'error');
            }
        }

        // Gerar slug
        function generateSlugFromTitle(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 100);
        }

        function normalizeDomainFromUrl(url) {
            if (!url) return '';
            try {
                const parsed = new URL(url.trim());
                return parsed.hostname.replace(/^www\./i, '');
            } catch (e) {
                return '';
            }
        }

        function handleExternalUrlInput() {
            const input = document.getElementById('newsExternalUrl');
            const hint = document.getElementById('newsExternalDomainHint');
            if (!input || !hint) return;
            const domain = normalizeDomainFromUrl(input.value);
            hint.textContent = domain ? `Fonte detectada: ${domain}` : '';
        }

        // Obter nome da categoria
        function getCategoryName(value) {
            const categories = {
                'mirador': 'Mirador',
                'regiao': 'Regiao',
                'brasil': 'Brasil',
                'policia': 'Policia',
                'esportes': 'Esportes',
                'politica': 'Politica',
                'geral': 'Geral'
            };
            return categories[value] || value;
        }

        // Carregar noticia para edicao
        async function loadNewsForEdit(newsId) {
            try {
                const doc = await db.collection('news').doc(newsId).get();
                if (doc.exists) {
                    const news = doc.data();
                    document.getElementById('newsTitle').value = news.title || '';
                    document.getElementById('newsSlug').value = news.slug || '';
                    document.getElementById('editorContent').innerHTML = news.content || '';
                    document.getElementById('newsExcerpt').value = news.excerpt || '';
                    document.getElementById('excerptCount').textContent = (news.excerpt || '').length;
                    document.getElementById('newsCategory').value = news.category || '';
                    document.getElementById('newsAuthor').value = news.author || 'Redacao';
                    document.getElementById('newsTags').value = (news.tags || []).join(', ');
                    document.getElementById('newsDate').value = news.date ? news.date.slice(0, 16) : '';
                    if (document.getElementById('newsExternalUrl')) {
                        document.getElementById('newsExternalUrl').value = news.externalUrl || '';
                        handleExternalUrlInput();
                    }
                    
                    if (news.image) {
                        currentNewsImage = news.image;
                        document.getElementById('newsImagePreview').src = news.image;
                        document.getElementById('newsImagePreview').style.display = 'block';
                        document.getElementById('removeImageBtn').style.display = 'block';
                        document.querySelector('.featured-image-upload').style.display = 'none';
                    }
                    
                    const status = news.status || 'published';
                    document.querySelector(`input[name="newsStatus"][value="${status}"]`).checked = true;
                }
            } catch (error) {
                console.error('Erro ao carregar noticia:', error);
                showModal('Erro!', 'Nao foi possivel carregar a noticia.', 'error');
            }
        }

        // ========================================
        // NOTIFICATION MODAL FUNCTIONS
        // ========================================
        let pendingModalConfirmResolve = null;

        function getModalElements() {
            return {
                modal: document.getElementById('notificationModal'),
                iconEl: document.getElementById('modalIcon'),
                titleEl: document.getElementById('modalTitle'),
                messageEl: document.getElementById('modalMessage'),
                footerEl: document.getElementById('modalFooter')
            };
        }

        function getModalIconMarkup(type = 'success') {
            const icons = {
                success: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
                error: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
                info: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                warning: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86l-7.4 12.8A1 1 0 003.76 18h16.48a1 1 0 00.87-1.34l-7.4-12.8a1 1 0 00-1.74 0z"/></svg>'
            };

            return icons[type] || icons.info;
        }

        function setModalDefaultFooter() {
            const { footerEl } = getModalElements();
            if (!footerEl) return;
            footerEl.classList.remove('confirm-actions');
            footerEl.innerHTML = '<button class="modal-btn" onclick="closeModal()">OK</button>';
        }

        function openNotificationModal() {
            const { modal } = getModalElements();
            if (!modal) return;

            modal.classList.add('active');
            modal.onclick = function (e) {
                if (e.target !== modal) return;
                if (pendingModalConfirmResolve) {
                    resolveConfirmModal(false);
                    return;
                }
                closeModal();
            };

            document.addEventListener('keydown', handleEscKey);
        }

        function finalizeNotificationModal(confirmChoice = null) {
            const { modal } = getModalElements();
            if (!modal) return;

            modal.classList.remove('active');
            modal.onclick = null;
            document.removeEventListener('keydown', handleEscKey);

            const resolver = pendingModalConfirmResolve;
            pendingModalConfirmResolve = null;
            setModalDefaultFooter();

            if (resolver) {
                resolver(Boolean(confirmChoice));
            }
        }

        function showModal(title, message, type = 'success') {
            const { iconEl, titleEl, messageEl } = getModalElements();
            pendingModalConfirmResolve = null;

            iconEl.className = 'modal-icon ' + type;
            iconEl.innerHTML = getModalIconMarkup(type);
            titleEl.textContent = title;
            messageEl.textContent = message;

            setModalDefaultFooter();
            openNotificationModal();
        }

        function showConfirmModal({
            title = 'Confirmar exclusao',
            message = '',
            confirmText = 'Excluir',
            cancelText = 'Cancelar'
        } = {}) {
            return new Promise((resolve) => {
                pendingModalConfirmResolve = resolve;
                const { iconEl, titleEl, messageEl, footerEl } = getModalElements();

                iconEl.className = 'modal-icon warning';
                iconEl.innerHTML = getModalIconMarkup('warning');
                titleEl.textContent = title;
                messageEl.textContent = message;

                if (footerEl) {
                    footerEl.classList.add('confirm-actions');
                    footerEl.innerHTML = `
                        <button type="button" class="modal-btn modal-btn-secondary" onclick="resolveConfirmModal(false)">${escapeHtml(cancelText)}</button>
                        <button type="button" class="modal-btn modal-btn-danger" onclick="resolveConfirmModal(true)">${escapeHtml(confirmText)}</button>
                    `;
                }

                openNotificationModal();
            });
        }

        function resolveConfirmModal(confirmed) {
            finalizeNotificationModal(Boolean(confirmed));
        }
        
        function closeModal() {
            finalizeNotificationModal(false);
        }
        
        function handleEscKey(e) {
            if (e.key === 'Escape') {
                if (pendingModalConfirmResolve) {
                    resolveConfirmModal(false);
                    return;
                }
                closeModal();
            }
        }

        // Verificar estado de autenticacao
        // Carregar configuracoes de marca na inicializacao
        // DOMContentLoaded da marca movido para o unificado acima

        auth.onAuthStateChanged((user) => {
            if (user) {
                showAdmin();
            } else {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('adminContainer').style.display = 'none';
            }
        });

        // Force reload if cache is old
        (function() {
            const cssVersion = '2026-02-09-002';
            const lastVersion = localStorage.getItem('admin_css_version');
            if (lastVersion !== cssVersion) {
                localStorage.setItem('admin_css_version', cssVersion);
                if (lastVersion) {
                    window.location.reload(true);
                }
            }
        })();

        // ===================== INSTAGRAM MANAGEMENT =====================
        let currentEditingStoryId = null;
        let extractedStoryImage = '';
        let extractedStoryTitle = '';
        const DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN = {
            displayName: 'Mirador e Região Online',
            username: 'mirador_e_regiao_online',
            profileImage: ''
        };
        let instagramProfileSettingsAdmin = { ...DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN };
        let instagramNewsData = {};

        function normalizeInstagramProfileSettingsAdmin(settings = {}) {
            const profileImageCandidates = [
                settings.profileImage,
                settings.profile_image,
                settings.profilePhoto,
                settings.profile_photo,
                settings.avatar,
                settings.avatarUrl,
                settings.avatar_url,
                settings.photo,
                settings.photoUrl,
                settings.photo_url,
                settings.image,
                settings.logo,
                settings.profile && settings.profile.image,
                settings.profile && settings.profile.photo
            ];
            const firstProfileImage = profileImageCandidates.find(value => typeof value === 'string' && value.trim());
            const displayNameRaw = (settings.displayName || settings.name || '').toString().trim();
            const usernameRaw = sanitizeInstagramHandleAdmin(settings.username || settings.handle || displayNameRaw);
            const profileImage = sanitizeInstagramProfileImageAdmin(firstProfileImage || '');

            return {
                displayName: displayNameRaw || DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.displayName,
                username: usernameRaw || DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.username,
                profileImage: profileImage || '',
                updatedAt: settings.updatedAt || null
            };
        }

        function extractInstagramProfileFromLayoutAdmin(layoutData = {}) {
            const nested = (layoutData && typeof layoutData.instagramProfile === 'object' && layoutData.instagramProfile)
                ? layoutData.instagramProfile
                : {};

            return normalizeInstagramProfileSettingsAdmin({
                ...nested,
                displayName:
                    nested.displayName ||
                    layoutData.instagramProfileDisplayName ||
                    layoutData.instagramProfileName ||
                    layoutData.instagramDisplayName ||
                    layoutData.instagramName ||
                    '',
                username:
                    nested.username ||
                    layoutData.instagramProfileUsername ||
                    layoutData.instagramUsername ||
                    layoutData.instagramHandle ||
                    '',
                profileImage:
                    nested.profileImage ||
                    layoutData.instagramProfileImage ||
                    layoutData.instagramProfilePhoto ||
                    layoutData.instagramAvatar ||
                    ''
            });
        }

        function hasInstagramProfileInLayoutAdmin(layoutData = {}) {
            const nested = (layoutData && typeof layoutData.instagramProfile === 'object' && layoutData.instagramProfile)
                ? layoutData.instagramProfile
                : {};
            return Boolean(
                nested.displayName ||
                nested.username ||
                nested.profileImage ||
                layoutData.instagramProfileDisplayName ||
                layoutData.instagramProfileUsername ||
                layoutData.instagramProfileImage ||
                layoutData.instagramProfileName ||
                layoutData.instagramProfilePhoto ||
                layoutData.instagramAvatar
            );
        }

        function extractInstagramProfileFromBrandAdmin(brandData = {}) {
            return normalizeInstagramProfileSettingsAdmin({
                displayName:
                    brandData.instagramProfileDisplayName ||
                    brandData.instagramDisplayName ||
                    '',
                username:
                    brandData.instagramProfileUsername ||
                    brandData.instagramUsername ||
                    brandData.instagramHandle ||
                    '',
                profileImage:
                    brandData.instagramProfileImage ||
                    brandData.instagramProfilePhoto ||
                    brandData.instagramAvatar ||
                    ''
            });
        }

        function hasInstagramProfileInBrandAdmin(brandData = {}) {
            return Boolean(
                brandData.instagramProfileDisplayName ||
                brandData.instagramDisplayName ||
                brandData.instagramProfileUsername ||
                brandData.instagramUsername ||
                brandData.instagramHandle ||
                brandData.instagramProfileImage ||
                brandData.instagramProfilePhoto ||
                brandData.instagramAvatar
            );
        }

        function applyInstagramProfileSettingsAdminForm(settings = {}) {
            const normalized = normalizeInstagramProfileSettingsAdmin(settings);
            const nameInput = document.getElementById('instagramDefaultProfileName');
            const usernameInput = document.getElementById('instagramDefaultProfileUsername');
            const imageInput = document.getElementById('instagramDefaultProfileImage');
            if (nameInput) nameInput.value = normalized.displayName;
            if (usernameInput) usernameInput.value = normalized.username;
            if (imageInput) imageInput.value = normalized.profileImage;
            instagramProfileSettingsAdmin = normalized;
            updateInstagramProfilePreviewAdmin();
        }

        function updateInstagramProfilePreviewAdmin() {
            const image = sanitizeInstagramProfileImageAdmin(document.getElementById('instagramDefaultProfileImage')?.value || '');
            const name = (document.getElementById('instagramDefaultProfileName')?.value || '').trim();
            const username = sanitizeInstagramHandleAdmin(document.getElementById('instagramDefaultProfileUsername')?.value || '');
            const previewWrap = document.getElementById('instagramDefaultProfilePreviewWrap');
            const previewImg = document.getElementById('instagramDefaultProfilePreview');
            const previewName = document.getElementById('instagramDefaultProfilePreviewName');
            const removeBtn = document.getElementById('instagramDefaultProfileRemoveBtn');
            if (previewName) {
                previewName.textContent = name || username || DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.displayName;
            }
            if (previewWrap && previewImg) {
                if (image) {
                    previewWrap.style.display = 'block';
                    previewImg.src = image;
                    if (removeBtn) removeBtn.style.display = 'inline-flex';
                } else {
                    previewWrap.style.display = 'none';
                    previewImg.src = '';
                    if (removeBtn) removeBtn.style.display = 'none';
                }
            }
        }

        function removeInstagramDefaultProfileImage() {
            const imageInput = document.getElementById('instagramDefaultProfileImage');
            const fileInput = document.getElementById('instagramDefaultProfileUpload');
            if (imageInput) imageInput.value = '';
            if (fileInput) fileInput.value = '';
            updateInstagramProfilePreviewAdmin();
        }

        function handleInstagramDefaultProfileImageDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const files = e.dataTransfer?.files || [];
            if (files.length > 0) {
                handleInstagramDefaultProfileImageUpload({ target: { files } });
            }
            if (e.currentTarget && e.currentTarget.style) {
                e.currentTarget.style.borderColor = 'var(--border)';
                e.currentTarget.style.background = 'var(--bg-primary)';
            }
        }

        async function handleInstagramDefaultProfileImageUpload(event) {
            const file = event?.target?.files?.[0];
            if (!file) return;

            if (!file.type || !file.type.startsWith('image/')) {
                showModal('Erro', 'Arquivo invalido. Envie uma imagem.', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showModal('Erro', 'Imagem muito grande. Maximo 10MB.', 'error');
                return;
            }

            const uploadArea = document.getElementById('instagramDefaultProfileUploadArea');
            const fileInput = document.getElementById('instagramDefaultProfileUpload');
            const imageInput = document.getElementById('instagramDefaultProfileImage');
            if (!uploadArea || !imageInput) return;

            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = '<div style="padding: 0.75rem; text-align: center;"><div style="width: 26px; height: 26px; border: 2px solid var(--border); border-top-color: #E4405F; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.5rem;"></div><p style="font-size: 0.8125rem; color: var(--text-muted);">Enviando foto...</p></div>';

            try {
                if (!r2Client) {
                    initR2Client();
                }

                const result = await r2Client.uploadFile(file, 'instagram-profile');
                const uploadedUrl = sanitizeInstagramProfileImageAdmin(result?.url || '');

                if (!uploadedUrl) {
                    throw new Error('URL da foto nao retornada pelo upload');
                }

                imageInput.value = uploadedUrl;
                const nameInput = document.getElementById('instagramDefaultProfileName');
                const usernameInput = document.getElementById('instagramDefaultProfileUsername');
                if (nameInput && !(nameInput.value || '').trim()) {
                    nameInput.value = DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.displayName;
                }
                if (usernameInput && !sanitizeInstagramHandleAdmin(usernameInput.value || '')) {
                    usernameInput.value = DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.username;
                }
                updateInstagramProfilePreviewAdmin();
                await saveInstagramProfileSettingsAdmin({ silent: true });
                showModal('Sucesso!', 'Foto enviada e perfil salvo com sucesso.', 'success');
            } catch (error) {
                console.error('[Admin] Erro ao enviar foto de perfil do Instagram:', error);
                showModal('Erro', 'Nao foi possivel enviar a foto: ' + (error.message || 'erro desconhecido'), 'error');
            } finally {
                uploadArea.innerHTML = originalContent;
                if (fileInput) fileInput.value = '';
            }
        }

        async function loadInstagramProfileSettingsAdmin() {
            let profileDoc = null;
            try {
                profileDoc = await db.collection('settings').doc('instagramProfile').get({ source: 'server' });
            } catch (_error) {}

            try {
                if (!profileDoc) {
                    profileDoc = await db.collection('settings').doc('instagramProfile').get();
                }
                if (profileDoc && profileDoc.exists) {
                    const normalized = normalizeInstagramProfileSettingsAdmin(profileDoc.data() || {});
                    instagramProfileSettingsAdmin = normalized;
                    localStorage.setItem('siteInstagramProfile', JSON.stringify(normalized));
                    localStorage.setItem('publicInstagramProfile', JSON.stringify(normalized));
                    applyInstagramProfileSettingsAdminForm(normalized);
                    return;
                }
            } catch (error) {
                console.log('[Admin] Erro ao carregar perfil oficial do Instagram:', error);
            }

            try {
                const layoutDoc = await db.collection('settings').doc('layout').get();
                if (layoutDoc && layoutDoc.exists && hasInstagramProfileInLayoutAdmin(layoutDoc.data() || {})) {
                    const normalized = extractInstagramProfileFromLayoutAdmin(layoutDoc.data() || {});
                    instagramProfileSettingsAdmin = normalized;
                    localStorage.setItem('siteInstagramProfile', JSON.stringify(normalized));
                    localStorage.setItem('publicInstagramProfile', JSON.stringify(normalized));
                    applyInstagramProfileSettingsAdminForm(normalized);
                    return;
                }
            } catch (layoutError) {
                console.log('[Admin] Erro ao carregar fallback do perfil no layout:', layoutError);
            }

            try {
                const brandDoc = await db.collection('settings').doc('brand').get();
                if (brandDoc && brandDoc.exists && hasInstagramProfileInBrandAdmin(brandDoc.data() || {})) {
                    const normalized = extractInstagramProfileFromBrandAdmin(brandDoc.data() || {});
                    instagramProfileSettingsAdmin = normalized;
                    localStorage.setItem('siteInstagramProfile', JSON.stringify(normalized));
                    localStorage.setItem('publicInstagramProfile', JSON.stringify(normalized));
                    applyInstagramProfileSettingsAdminForm(normalized);
                    return;
                }
            } catch (brandError) {
                console.log('[Admin] Erro ao carregar fallback do perfil no brand:', brandError);
            }

            try {
                const saved = localStorage.getItem('siteInstagramProfile');
                if (saved) {
                    const normalized = normalizeInstagramProfileSettingsAdmin(JSON.parse(saved));
                    instagramProfileSettingsAdmin = normalized;
                    applyInstagramProfileSettingsAdminForm(normalized);
                    return;
                }
            } catch (_e) {}

            applyInstagramProfileSettingsAdminForm(DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN);
        }

        async function saveInstagramProfileSettingsAdmin(options = {}) {
            const silent = Boolean(options && options.silent);
            try {
                const displayName = (document.getElementById('instagramDefaultProfileName')?.value || '').trim();
                const username = sanitizeInstagramHandleAdmin(document.getElementById('instagramDefaultProfileUsername')?.value || '');
                let profileImage = sanitizeInstagramProfileImageAdmin(document.getElementById('instagramDefaultProfileImage')?.value || '');
                if (isInlineImageDataUrl(profileImage)) {
                    if (!r2Client) initR2Client();
                    const imageFile = await dataUrlToFile(profileImage, `instagram-profile-${Date.now()}.jpg`);
                    const uploadResult = await r2Client.uploadFile(imageFile, 'instagram-profile');
                    profileImage = sanitizeInstagramProfileImageAdmin(uploadResult?.url || '');
                    const imageInput = document.getElementById('instagramDefaultProfileImage');
                    if (imageInput) imageInput.value = profileImage;
                }
                const payload = normalizeInstagramProfileSettingsAdmin({
                    displayName,
                    username,
                    profileImage,
                    updatedAt: new Date().toISOString()
                });

                await Promise.all([
                    db.collection('settings').doc('instagramProfile').set(payload, { merge: true }),
                    db.collection('settings').doc('layout').set({
                        instagramProfile: {
                            displayName: payload.displayName || '',
                            username: payload.username || '',
                            profileImage: payload.profileImage || '',
                            updatedAt: payload.updatedAt || new Date().toISOString()
                        },
                        instagramProfileDisplayName: payload.displayName || '',
                        instagramProfileUsername: payload.username || '',
                        instagramProfileImage: payload.profileImage || '',
                        instagramProfileUpdatedAt: payload.updatedAt || new Date().toISOString()
                    }, { merge: true }),
                    db.collection('settings').doc('brand').set({
                        instagramProfileDisplayName: payload.displayName || '',
                        instagramProfileUsername: payload.username || '',
                        instagramProfileImage: payload.profileImage || '',
                        instagramProfileUpdatedAt: payload.updatedAt || new Date().toISOString()
                    }, { merge: true })
                ]);
                instagramProfileSettingsAdmin = payload;
                localStorage.setItem('siteInstagramProfile', JSON.stringify(payload));
                localStorage.setItem('publicInstagramProfile', JSON.stringify(payload));
                const syncResult = await applyOfficialInstagramProfileToExistingPostsAdmin(payload);
                updateInstagramProfilePreviewAdmin();
                const updatedCount = syncResult?.updated || 0;
                if (!silent) {
                    showModal('Sucesso!', `Perfil oficial salvo. ${updatedCount} post(s) de Instagram foram atualizados com a foto/nome oficial.`, 'success');
                }
                return payload;
            } catch (error) {
                console.error('[Admin] Erro ao salvar perfil oficial do Instagram:', error);
                if (!silent) {
                    showModal('Erro!', 'Nao foi possivel salvar o perfil oficial do Instagram.', 'error');
                }
                throw error;
            }
        }

        async function applyOfficialInstagramProfileToExistingPostsAdmin(profile = {}) {
            const normalized = normalizeInstagramProfileSettingsAdmin(profile || {});
            let docs = [];

            try {
                const snapshot = await db.collection('news').where('source', '==', 'Instagram').get();
                docs = snapshot.docs || [];
            } catch (_queryError) {
                try {
                    const fallbackSnapshot = await db.collection('news').get();
                    docs = (fallbackSnapshot.docs || []).filter(doc => {
                        const data = doc.data() || {};
                        return data.source === 'Instagram' || (String(data.category || '').toLowerCase() === 'instagram');
                    });
                } catch (error) {
                    console.error('[Admin] Falha ao listar posts para sincronizar perfil:', error);
                    return { updated: 0 };
                }
            }

            if (!docs.length) return { updated: 0 };

            const batchLimit = 400;
            let updated = 0;
            for (let i = 0; i < docs.length; i += batchLimit) {
                const chunk = docs.slice(i, i + batchLimit);
                const batch = db.batch();

                chunk.forEach(doc => {
                    batch.update(doc.ref, {
                        instagramUsername: normalized.username || '',
                        instagramDisplayName: normalized.displayName || '',
                        instagramProfileImage: normalized.profileImage || '',
                        instagramMetaUpdatedAt: new Date().toISOString()
                    });
                    updated += 1;
                });

                await batch.commit();
            }

            return { updated };
        }

        function switchNewsTab(tab) {
            const tabs = [
                { key: 'publicacoes', buttonId: 'tabNewsPublicacoes', contentId: 'newsPublicacoesTab' },
                { key: 'criar', buttonId: 'tabNewsCriar', contentId: 'newsCriarTab' }
            ];

            tabs.forEach(item => {
                const button = document.getElementById(item.buttonId);
                const content = document.getElementById(item.contentId);
                const active = item.key === tab;

                if (button) {
                    button.style.borderBottomColor = active ? 'var(--primary)' : 'transparent';
                    button.style.color = active ? 'var(--primary)' : 'var(--text-muted)';
                    button.classList.toggle('active', active);
                }

                if (content) {
                    content.style.display = active ? 'block' : 'none';
                }
            });

            if (tab === 'publicacoes') {
                loadNewsPage();
            }
        }

        function switchImportNewsTab(tab) {
            const tabs = [
                { key: 'publicacoes', buttonId: 'tabImportNewsPublicacoes', contentId: 'importNewsPublicacoesTab' },
                { key: 'importar', buttonId: 'tabImportNewsImportar', contentId: 'importNewsImportarTab' }
            ];

            tabs.forEach(item => {
                const button = document.getElementById(item.buttonId);
                const content = document.getElementById(item.contentId);
                const active = item.key === tab;

                if (button) {
                    button.style.borderBottomColor = active ? 'var(--primary)' : 'transparent';
                    button.style.color = active ? 'var(--primary)' : 'var(--text-muted)';
                    button.classList.toggle('active', active);
                }

                if (content) {
                    content.style.display = active ? 'block' : 'none';
                }
            });

            if (tab === 'publicacoes') {
                loadImportedNewsPage();
            }
        }

        function switchInstagramTab(tab) {
            const tabs = [
                { key: 'posts', buttonId: 'tabPosts', contentId: 'instagramPostsTab' },
                { key: 'import', buttonId: 'tabImport', contentId: 'instagramImportTab' }
            ];

            tabs.forEach(item => {
                const button = document.getElementById(item.buttonId);
                const content = document.getElementById(item.contentId);
                const active = item.key === tab;

                if (button) {
                    button.style.borderBottomColor = active ? 'var(--primary)' : 'transparent';
                    button.style.color = active ? 'var(--primary)' : 'var(--text-muted)';
                    button.classList.toggle('active', active);
                }

                if (content) {
                    content.style.display = active ? 'block' : 'none';
                }
            });

            if (tab === 'posts') {
                loadInstagramPostsPage();
            }
        }

        async function loadInstagramAdmin() {
            await loadInstagramProfileSettingsAdmin();
            await loadInstagramPostsPage();
        }

        function cleanInstagramText(text) {
            if (!text) return '';
            
            // Remove padrÃµes comuns de metadados do Instagram
            let cleaned = text
                // Remove "X likes, Y comments - username on Date:"
                .replace(/^\s*["']?\s*[\d.,kmb]+\s*likes?,?\s*[\d.,kmb]*\s*comments?\s*-\s*[a-z0-9._]{2,30}\s+on\s+[^:]+:?\s*/i, '')
                // Remove "username on Date:"
                .replace(/^\s*["']?\s*[a-z0-9._]{2,30}\s+on\s+[^:]+:?\s*/i, '')
                // Remove aspas no inicio e fim
                .replace(/^\s*["']+|["']+\s*$/g, '')
                // Remove hashtags no final (opcional - mantem por enquanto)
                // .replace(/#\w+/g, '')
                // Remove multiplos espacos
                .replace(/\s+/g, ' ')
                // Trim
                .trim();
            
            return cleaned;
        }

        function generateTitleFromText(text, maxLength = 80) {
            if (!text) return 'Noticia do Instagram';
            
            // Limpar o texto primeiro
            let cleaned = cleanInstagramText(text);
            
            // Pegar as primeiras palavras ate o limite de caracteres
            if (cleaned.length <= maxLength) {
                return cleaned;
            }
            
            // Cortar no ultimo espaco antes do limite
            let truncated = cleaned.substring(0, maxLength);
            let lastSpace = truncated.lastIndexOf(' ');
            if (lastSpace > 0) {
                truncated = truncated.substring(0, lastSpace);
            }
            
            return truncated + '...';
        }

        function parseInstagramCountValue(value) {
            if (typeof value === 'number' && Number.isFinite(value)) return Math.max(0, Math.round(value));
            if (typeof value !== 'string') return 0;

            const raw = value.trim().toLowerCase();
            if (!raw) return 0;

            const compact = raw.match(/([\d.,]+)\s*(k|m|b|mil|mi)?/i);
            if (!compact) {
                const digitsOnly = raw.replace(/[^\d]/g, '');
                return digitsOnly ? parseInt(digitsOnly, 10) : 0;
            }

            const numPart = compact[1].replace(/\s/g, '');
            let numeric = 0;
            if (numPart.includes('.') && numPart.includes(',')) {
                numeric = Number(numPart.replace(/\./g, '').replace(',', '.'));
            } else if (numPart.includes(',') && !numPart.includes('.')) {
                const maybeDecimal = numPart.split(',')[1];
                if (maybeDecimal && maybeDecimal.length <= 2) {
                    numeric = Number(numPart.replace(',', '.'));
                } else {
                    numeric = Number(numPart.replace(/,/g, ''));
                }
            } else {
                numeric = Number(numPart.replace(/[^\d.]/g, ''));
            }

            if (!Number.isFinite(numeric)) return 0;

            const suffix = (compact[2] || '').toLowerCase();
            const multiplier =
                suffix === 'k' || suffix === 'mil' ? 1000 :
                suffix === 'm' || suffix === 'mi' ? 1000000 :
                suffix === 'b' ? 1000000000 :
                1;

            return Math.max(0, Math.round(numeric * multiplier));
        }

        function extractInstagramUsernameFromUrlAdmin(url) {
            if (!url) return '';
            try {
                const parsed = new URL(url);
                const first = parsed.pathname.split('/').filter(Boolean)[0] || '';
                const reserved = ['p', 'reel', 'tv', 'stories', 'explore', 'accounts'];
                if (!first || reserved.includes(first.toLowerCase())) return '';
                return first.replace(/^@/, '');
            } catch (_e) {
                return '';
            }
        }

        function extractInstagramUsernameFromTextAdmin(text) {
            if (!text || typeof text !== 'string') return '';

            const patterns = [
                /-\s*([a-z0-9._]{2,30})\s+on\b/i,
                /\bby\s+([a-z0-9._]{2,30})\b/i,
                /@([a-z0-9._]{2,30})/i
            ];

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) return match[1];
            }
            return '';
        }

        function buildInstagramAvatarUrlAdmin(username, fallbackName = 'IG') {
            const clean = (username || '').replace(/^@/, '').trim();
            if (!clean) {
                return `https://ui-avatars.com/api/?name=${encodeURIComponent(fallbackName)}&background=E4405F&color=fff`;
            }
            return `https://unavatar.io/instagram/${encodeURIComponent(clean)}`;
        }

        function sanitizeInstagramHandleAdmin(value) {
            if (value == null) return '';
            const text = String(value).trim().replace(/^@/, '');
            if (!text) return '';

            const match = text.match(/[a-z0-9._]{2,30}/i);
            const handle = (match && match[0]) ? match[0].toLowerCase() : '';
            if (!handle) return '';
            if (!/[a-z]/.test(handle)) return '';
            if (/^[._]|[._]$/.test(handle)) return '';

            const blocked = ['instagram', 'undefined', 'null', 'nan', 'profile', 'user'];
            if (blocked.includes(handle)) return '';
            return handle;
        }

        function sanitizeInstagramProfileImageAdmin(url) {
            if (!url || typeof url !== 'string') return '';
            const clean = url.trim();
            if (!clean) return '';
            return clean;
        }

        function sanitizeInstagramDisplayNameAdmin(value, fallbackHandle = '', description = '', instagramUrl = '') {
            const raw = (value == null ? '' : String(value)).trim();
            const cleanedRaw = cleanInstagramText(raw);

            const candidates = [
                sanitizeInstagramHandleAdmin(cleanedRaw),
                sanitizeInstagramHandleAdmin(fallbackHandle),
                sanitizeInstagramHandleAdmin(extractInstagramUsernameFromTextAdmin(description)),
                sanitizeInstagramHandleAdmin(extractInstagramUsernameFromUrlAdmin(instagramUrl))
            ].filter(Boolean);

            if (candidates.length > 0) return candidates[0];
            return 'instagram';
        }

        function extractInstagramHandlesFromTextAdmin(text = '') {
            if (!text || typeof text !== 'string') return [];

            const handles = new Set();
            const addHandle = (value) => {
                const clean = sanitizeInstagramHandleAdmin(value);
                if (clean) handles.add(clean);
            };

            const collabLead = text.match(/^\s*([a-z0-9._]{2,30})\s+(?:e|and)\s+(?:outra\s+conta|outros?\s+\d+|others?\s+\d+)/i);
            if (collabLead && collabLead[1]) addHandle(collabLead[1]);

            return Array.from(handles);
        }

        function collectInstagramCollaboratorsAdmin(...sources) {
            const handles = new Set();
            const addHandle = (value) => {
                const clean = sanitizeInstagramHandleAdmin(value);
                if (clean) handles.add(clean);
            };

            for (const source of sources) {
                if (!source) continue;

                if (Array.isArray(source)) {
                    source.forEach(item => addHandle(item));
                    continue;
                }

                if (typeof source === 'string') {
                    const trimmed = source.trim();
                    if (/^[a-z0-9._]{2,30}$/i.test(trimmed)) {
                        addHandle(trimmed);
                    }
                    extractInstagramHandlesFromTextAdmin(trimmed).forEach(addHandle);
                    continue;
                }
            }

            return Array.from(handles);
        }

        function normalizeInstagramMetaAdmin(meta = {}, instagramUrl = '') {
            const textBlob = [
                meta.description,
                meta.title,
                meta.authorName,
                meta.author
            ].filter(Boolean).join(' | ');

            const likesMatch = textBlob.match(/([\d.,kmb]+)\s+likes?/i);
            const commentsMatch = textBlob.match(/([\d.,kmb]+)\s+comments?/i);

            const collaborators = collectInstagramCollaboratorsAdmin(
                meta.collaborators || [],
                meta.username,
                extractInstagramUsernameFromUrlAdmin(meta.authorUrl || ''),
                extractInstagramUsernameFromTextAdmin(textBlob),
                extractInstagramUsernameFromUrlAdmin(instagramUrl)
            );

            const username = sanitizeInstagramHandleAdmin(
                meta.username ||
                collaborators[0] ||
                extractInstagramUsernameFromUrlAdmin(meta.authorUrl || '') ||
                extractInstagramUsernameFromTextAdmin(textBlob) ||
                extractInstagramUsernameFromUrlAdmin(instagramUrl)
            );

            const likes = meta.likes != null ? parseInstagramCountValue(meta.likes) : (likesMatch ? parseInstagramCountValue(likesMatch[1]) : 0);
            const comments = meta.comments != null ? parseInstagramCountValue(meta.comments) : (commentsMatch ? parseInstagramCountValue(commentsMatch[1]) : 0);
            const displayName = sanitizeInstagramDisplayNameAdmin(
                meta.displayName || meta.authorName || username || '',
                username,
                textBlob,
                instagramUrl
            );
            const cleanProfileImage = sanitizeInstagramProfileImageAdmin(meta.profileImage || '');
            const hasAdditionalCollaborator = Boolean(
                meta.hasAdditionalCollaborator ||
                collaborators.length > 1 ||
                /(?:\be\b|\band\b)\s+(?:outra\s+conta|outros?\s+\d+|others?\s+\d+)/i.test(`${meta.title || ''} ${meta.description || ''} ${meta.authorName || ''}`)
            );

            return {
                likes,
                comments,
                username,
                displayName,
                profileImage: cleanProfileImage || '',
                collaborators,
                hasAdditionalCollaborator
            };
        }

        async function fetchInstagramMetaForAdmin(url) {
            let internalMeta = null;
            let microlinkData = null;
            let jsonlinkData = null;
            let noembedData = null;

            const encodedUrl = encodeURIComponent(url);
            const workerBaseUrl = (typeof getWorkerBaseUrl === 'function')
                ? getWorkerBaseUrl().replace(/\/$/, '')
                : 'https://mirador-r2.sitemirador2026.workers.dev';
            const workerEndpoint = `${workerBaseUrl}/api/instagram/meta?url=${encodedUrl}`;
            const localEndpoint = `/api/instagram/meta?url=${encodedUrl}`;
            const metaEndpoints = (typeof window !== 'undefined' && window.location && window.location.protocol === 'file:')
                ? [workerEndpoint]
                : [localEndpoint, workerEndpoint];

            for (const endpoint of metaEndpoints) {
                try {
                    const response = await fetch(endpoint);
                    if (!response.ok) continue;
                    const payload = await response.json();
                    if (payload && payload.success) {
                        internalMeta = payload;
                        break;
                    }
                } catch (_internalError) {}
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`, {
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const payload = await response.json();
                    microlinkData = payload?.data || null;
                }
            } catch (apiError) {
                console.log('[Admin] Microlink API falhou:', apiError.message);
            }

            if (!microlinkData) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);
                    const response = await fetch(`https://jsonlink.io/api/extract?url=${encodeURIComponent(url)}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        jsonlinkData = await response.json();
                    }
                } catch (jsonError) {
                    console.log('[Admin] JSONLink falhou:', jsonError.message);
                }
            }

            if (!microlinkData && !jsonlinkData) {
                try {
                    const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
                    if (response.ok) {
                        noembedData = await response.json();
                    }
                } catch (_e) {}
            }

            const merged = {
                image: internalMeta?.image || microlinkData?.image?.url || microlinkData?.image || (jsonlinkData?.images && jsonlinkData.images[0]) || '',
                video: internalMeta?.video || microlinkData?.video?.url || microlinkData?.video || (jsonlinkData?.videos && jsonlinkData.videos[0]) || '',
                title: internalMeta?.title || microlinkData?.title || jsonlinkData?.meta?.title || noembedData?.title || '',
                description: internalMeta?.description || microlinkData?.description || jsonlinkData?.meta?.description || noembedData?.title || '',
                likes: internalMeta?.likes ?? microlinkData?.likes ?? microlinkData?.like_count ?? microlinkData?.engagement?.likes,
                comments: internalMeta?.comments ?? microlinkData?.comments ?? microlinkData?.comment_count ?? microlinkData?.engagement?.comments,
                authorName: internalMeta?.displayName || microlinkData?.author?.name || noembedData?.author_name || '',
                authorUrl: microlinkData?.author?.url || '',
                username: internalMeta?.username || microlinkData?.author?.username || '',
                profileImage: internalMeta?.profileImage || microlinkData?.author?.image?.url || microlinkData?.author?.avatar || '',
                displayName: internalMeta?.displayName || microlinkData?.author?.name || noembedData?.author_name || '',
                collaborators: internalMeta?.collaborators || [],
                hasAdditionalCollaborator: Boolean(internalMeta?.hasAdditionalCollaborator)
            };
            const urlLooksVideo = /instagram\.com\/(?:reel|reels|tv)\//i.test(url);
            const inferredVideoPost = Boolean(
                merged.video ||
                internalMeta?.mediaType === 'video' ||
                internalMeta?.isVideoPost ||
                urlLooksVideo
            );
            const resolvedMediaType = inferredVideoPost ? 'video' : 'image';

            const normalized = normalizeInstagramMetaAdmin(merged, url);
            return {
                ...merged,
                ...normalized,
                mediaType: resolvedMediaType,
                isVideoPost: inferredVideoPost,
                requiresVideoUpload: inferredVideoPost && !merged.video
            };
        }

        async function extractInstagramNewsData(e) {
            setTimeout(async () => {
                const target = e.target || document.getElementById('instagramNewsUrl');
                const url = target?.value?.trim() || '';
                
                if (!url || !url.includes('instagram.com')) return;
                
                const loading = document.getElementById('instagramNewsLoading');
                const preview = document.getElementById('instagramNewsPreview');
                
                loading.style.display = 'block';
                preview.style.display = 'none';
                
                let imageUrl = '';
                let videoUrl = '';
                let title = '';
                let description = '';
                
                try {
                    const extracted = await fetchInstagramMetaForAdmin(url);
                    imageUrl = extracted.image || '';
                    videoUrl = extracted.video || '';
                    title = extracted.title || '';
                    description = extracted.description || '';
                    const isVideoPost = Boolean(
                        extracted.mediaType === 'video' ||
                        extracted.isVideoPost ||
                        /instagram\.com\/(?:reel|reels|tv)\//i.test(url)
                    );
                    
                    // Processar dados extraidos (ou usar valores padrao se vazio)
                    const cleanedContent = cleanInstagramText(description || '');
                    const cleanedTitle = cleanInstagramText(title || '');
                    const finalTitle = cleanedTitle || generateTitleFromText(cleanedContent) || 'Post do Instagram';
                    
                    instagramNewsData.image = imageUrl;
                    instagramNewsData.video = videoUrl;
                    instagramNewsData.mediaType = isVideoPost ? 'video' : 'image';
                    instagramNewsData.title = finalTitle;
                    instagramNewsData.content = cleanedContent;
                    instagramNewsData.url = url;
                    instagramNewsData.username = sanitizeInstagramHandleAdmin(extracted.username || '');
                    instagramNewsData.displayName = sanitizeInstagramDisplayNameAdmin(
                        extracted.displayName || extracted.username || '',
                        extracted.username || '',
                        cleanedContent,
                        url
                    );
                    instagramNewsData.profileImage = sanitizeInstagramProfileImageAdmin(extracted.profileImage || '');

                    const likesInput = document.getElementById('instagramLikesCount');
                    const commentsInput = document.getElementById('instagramCommentsCount');
                    if (likesInput) likesInput.value = (extracted.likes ?? 0).toString();
                    if (commentsInput) commentsInput.value = (extracted.comments ?? 0).toString();
                    
                    // Preencher formulario (apenas legenda - titulo e gerado automaticamente da legenda)
                    document.getElementById('instagramNewsCaption').value = cleanedContent;
                    
                    // Mostrar midia extraida (video ou imagem)
                    if (videoUrl || imageUrl || isVideoPost) {
                        setInstagramMainMediaPreview({
                            mediaType: isVideoPost ? 'video' : 'image',
                            imageUrl: imageUrl,
                            videoUrl: videoUrl,
                            showManualVideoNotice: isVideoPost && !videoUrl
                        });
                    } else {
                        // Se nao conseguiu midia, mostrar area de upload
                        setInstagramMainMediaPreview({ mediaType: 'image', imageUrl: '', videoUrl: '' });
                    }
                    
                    loading.style.display = 'none';
                    preview.style.display = 'block';
                    
                } catch (error) {
                    console.error('[Admin] Erro ao extrair noticia do Instagram:', error);
                    setInstagramMainMediaPreview({ mediaType: 'image', imageUrl: '', videoUrl: '' });
                    // Mesmo com erro, mostrar o formulario para preenchimento manual
                    loading.style.display = 'none';
                    preview.style.display = 'block';
                }
            }, 100);
        }

        async function saveInstagramNews() {
            const captionContent = document.getElementById('instagramNewsCaption').value.trim();
            let image = (document.getElementById('instagramNewsImageUrl').value || '').trim();
            const videoUrl = (document.getElementById('instagramNewsVideoUrl')?.value || '').trim();
            const mediaType = (document.getElementById('instagramNewsMediaType')?.value || 'image') === 'video' ? 'video' : 'image';
            const hasVideo = Boolean(videoUrl);
            const resolvedMediaType = hasVideo ? 'video' : mediaType;
            const category = document.getElementById('instagramNewsCategory').value;
            const instagramUrl = document.getElementById('instagramNewsUrl').value.trim();
            const likes = parseInt(document.getElementById('instagramLikesCount').value) || 0;
            const comments = parseInt(document.getElementById('instagramCommentsCount').value) || 0;
            const instagramMeta = normalizeInstagramMetaAdmin({
                likes,
                comments,
                username: instagramNewsData.username || '',
                displayName: instagramNewsData.displayName || '',
                profileImage: instagramNewsData.profileImage || '',
                description: captionContent
            }, instagramUrl);
            const officialProfile = normalizeInstagramProfileSettingsAdmin(instagramProfileSettingsAdmin || {});
            const configuredDisplayName = (document.getElementById('instagramDefaultProfileName')?.value || '').trim();
            const configuredUsername = sanitizeInstagramHandleAdmin(document.getElementById('instagramDefaultProfileUsername')?.value || '');
            const configuredProfileImage = sanitizeInstagramProfileImageAdmin(document.getElementById('instagramDefaultProfileImage')?.value || '');
            const finalProfileUsername = configuredUsername || officialProfile.username || instagramMeta.username || DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.username;
            const finalProfileDisplayName = configuredDisplayName || officialProfile.displayName || instagramMeta.displayName || finalProfileUsername || DEFAULT_INSTAGRAM_PROFILE_SETTINGS_ADMIN.displayName;
            const finalProfileImage = configuredProfileImage || officialProfile.profileImage || '';

            if (!finalProfileImage) {
                showModal('Atencao', 'Envie a foto do perfil oficial na caixa "Foto do perfil" antes de publicar o post.', 'warning');
                return;
            }
            
            let categoryName = document.querySelector(`#instagramNewsCategory option[value="${category}"]`).textContent;
            categoryName = categoryName.replace(/[^\w\s]/g, '').trim();
            
            if (mediaType === 'video' && !videoUrl) {
                showModal('Atencao', 'O video do post e obrigatorio. Faca upload do video.', 'warning');
                return;
            }
            
            if (!captionContent) {
                showModal('Atencao', 'A legenda do post e obrigatoria.', 'warning');
                return;
            }
            
            if (!instagramUrl) {
                showModal('Atencao', 'O link do Instagram e obrigatorio.', 'warning');
                return;
            }
            
            // Gerar titulo a partir da legenda (primeiras palavras)
            const title = generateTitleFromText(captionContent);
            
            // Obter galeria de midias
            let gallery = [];
            try {
                const galleryInput = document.getElementById('instagramGalleryUrls').value;
                if (galleryInput) {
                    gallery = JSON.parse(galleryInput);
                }
            } catch (e) {
                console.error('[Admin] Erro ao parsear galeria:', e);
            }

            if (isInlineImageDataUrl(image)) {
                try {
                    if (!r2Client) initR2Client();
                    const imageFile = await dataUrlToFile(image, `${Date.now()}-instagram-thumb.jpg`);
                    const uploadResult = await r2Client.uploadFile(imageFile, 'instagram');
                    image = (uploadResult?.url || '').trim();
                    const imageInput = document.getElementById('instagramNewsImageUrl');
                    if (imageInput) imageInput.value = image;
                } catch (uploadError) {
                    console.error('[Admin] Erro ao migrar thumbnail inline do Instagram para R2:', uploadError);
                    showModal('Erro', 'Nao foi possivel enviar a miniatura do video para o R2.', 'error');
                    return;
                }
            }

            if (Array.isArray(gallery) && gallery.length > 0) {
                for (let i = 0; i < gallery.length; i++) {
                    const item = gallery[i];
                    if (!item || !isInlineImageDataUrl(item.url)) continue;
                    try {
                        if (!r2Client) initR2Client();
                        const imageFile = await dataUrlToFile(item.url, `${Date.now()}-instagram-gallery-${i}.jpg`);
                        const uploadResult = await r2Client.uploadFile(imageFile, 'instagram');
                        const migratedUrl = (uploadResult?.url || '').trim();
                        if (migratedUrl) {
                            gallery[i] = { ...item, url: migratedUrl };
                        }
                    } catch (galleryUploadError) {
                        console.error('[Admin] Erro ao migrar item inline da galeria para R2:', galleryUploadError);
                        showModal('Erro', `Nao foi possivel enviar a midia ${i + 1} da galeria para o R2.`, 'error');
                        return;
                    }
                }
            }

            const hasImage = Boolean(image);
             
            // Verificar tamanho estimado do documento (limite 1MB = 1.048.576 bytes)
            const estimatedSize = JSON.stringify({
                title, captionContent, image, videoUrl, mediaType, gallery, instagramUrl
            }).length;
            
            console.log(`[Admin] Tamanho estimado do documento: ${Math.round(estimatedSize/1024)}KB`);
            console.log(`[Admin] - Imagem de capa: ${Math.round(image.length/1024)}KB`);
            console.log(`[Admin] - Itens na galeria: ${gallery.length}`);
            gallery.forEach((item, i) => {
                console.log(`[Admin]   - Item ${i+1}: ${Math.round(item.url.length/1024)}KB`);
            });
            
            if (estimatedSize > 900000) { // Limite de seguranca 900KB
                showModal('Erro', `O post esta muito grande (${Math.round(estimatedSize/1024)}KB). Reduza o numero de fotos na galeria ou use imagens menores.`, 'error');
                return;
            }
            
            const newsData = {
                title,
                excerpt: captionContent.substring(0, 200) + (captionContent.length > 200 ? '...' : ''),
                content: captionContent,
                image: resolvedMediaType === 'video'
                    ? (hasImage ? image : '')
                    : (hasImage ? image : 'https://via.placeholder.com/800x400?text=Sem+Imagem'),
                instagramMediaType: resolvedMediaType,
                instagramVideoUrl: resolvedMediaType === 'video' ? videoUrl : '',
                category,
                categoryName,
                date: new Date().toISOString(),
                status: 'published',
                isImported: true,
                instagramUrl: instagramUrl,
                sourceUrl: instagramUrl,
                source: 'Instagram',
                instagramLikes: likes,
                instagramComments: comments,
                instagramUsername: finalProfileUsername,
                instagramDisplayName: finalProfileDisplayName,
                instagramProfileImage: finalProfileImage,
                instagramCollaborators: Array.isArray(instagramMeta.collaborators) ? instagramMeta.collaborators : [],
                instagramHasCollaborator: Boolean(instagramMeta.hasAdditionalCollaborator),
                instagramMetaUpdatedAt: new Date().toISOString(),
                gallery: gallery, // Galeria de fotos/videos adicionais
                views: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('news').add(newsData);
                showModal('Sucesso!', 'Post do Instagram publicado com sucesso!', 'success');
                clearInstagramNewsForm();
                loadDashboard();
                loadNewsPage();
                loadInstagramPostsPage();
            } catch (error) {
                console.error('[Admin] Erro ao salvar noticia:', error);
                showModal('Erro', 'Nao foi possivel salvar: ' + error.message, 'error');
            }
        }

        // Drag and drop para imagem do Instagram
        function handleInstagramImageDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                const event = { target: { files: files } };
                handleInstagramImageUpload(event);
            }
            // Resetar estilo
            if (e.target.style) {
                e.target.style.borderColor = 'var(--border)';
                e.target.style.background = 'var(--bg-primary)';
            }
        }
        
        const MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES = 15 * 1024 * 1024;

        function setInstagramMainMediaPreview({ mediaType = 'image', imageUrl = '', videoUrl = '', showManualVideoNotice = false } = {}) {
            const previewContainer = document.getElementById('instagramImagePreviewContainer');
            const uploadArea = document.getElementById('instagramImageUploadArea');
            const imageEl = document.getElementById('instagramNewsImage');
            const videoEl = document.getElementById('instagramNewsVideo');
            const imageInput = document.getElementById('instagramNewsImageUrl');
            const videoInput = document.getElementById('instagramNewsVideoUrl');
            const mediaTypeInput = document.getElementById('instagramNewsMediaType');
            const manualVideoNotice = document.getElementById('instagramVideoManualNotice');

            if (!previewContainer || !uploadArea || !imageEl || !videoEl || !imageInput || !videoInput || !mediaTypeInput) return;
            if (manualVideoNotice) {
                manualVideoNotice.style.display = showManualVideoNotice ? 'block' : 'none';
            }

            if (mediaType === 'video' && videoUrl) {
                imageEl.style.display = 'none';
                imageEl.src = imageUrl || '';
                videoEl.style.display = 'block';
                videoEl.src = videoUrl;
                previewContainer.style.display = 'block';
                uploadArea.style.display = 'none';
                imageInput.value = imageUrl || '';
                videoInput.value = videoUrl;
                mediaTypeInput.value = 'video';
                instagramNewsData.image = imageUrl || '';
                instagramNewsData.video = videoUrl;
                instagramNewsData.mediaType = 'video';
                return;
            }

            if (mediaType === 'video' && !videoUrl) {
                videoEl.pause();
                videoEl.src = '';
                videoEl.style.display = 'none';

                if (imageUrl) {
                    imageEl.style.display = 'block';
                    imageEl.src = imageUrl;
                    previewContainer.style.display = 'block';
                } else {
                    imageEl.style.display = 'none';
                    imageEl.src = '';
                    previewContainer.style.display = 'none';
                }

                // Mantem o upload visivel para o usuario enviar o video manualmente
                uploadArea.style.display = 'block';
                imageInput.value = imageUrl || '';
                videoInput.value = '';
                mediaTypeInput.value = 'video';
                instagramNewsData.image = imageUrl || '';
                instagramNewsData.video = '';
                instagramNewsData.mediaType = 'video';
                return;
            }

            if (imageUrl) {
                imageEl.style.display = 'block';
                imageEl.src = imageUrl;
                videoEl.style.display = 'none';
                videoEl.pause();
                videoEl.src = '';
                previewContainer.style.display = 'block';
                uploadArea.style.display = 'none';
                imageInput.value = imageUrl;
                videoInput.value = '';
                mediaTypeInput.value = 'image';
                instagramNewsData.image = imageUrl;
                instagramNewsData.video = '';
                instagramNewsData.mediaType = 'image';
                return;
            }

            imageEl.src = '';
            videoEl.pause();
            videoEl.src = '';
            imageEl.style.display = 'none';
            videoEl.style.display = 'none';
            previewContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            imageInput.value = '';
            videoInput.value = '';
            mediaTypeInput.value = 'image';
            instagramNewsData.image = '';
            instagramNewsData.video = '';
            instagramNewsData.mediaType = 'image';
        }

        function removeInstagramImage() {
            setInstagramMainMediaPreview({ mediaType: 'image', imageUrl: '', videoUrl: '' });
            const fileInput = document.getElementById('instagramImageUpload');
            if (fileInput) fileInput.value = '';
        }

        async function dataUrlToFile(dataUrl, filename = 'image.jpg') {
            const response = await fetch(dataUrl);
            const blob = await response.blob();
            return new File([blob], filename, { type: blob.type || 'image/jpeg', lastModified: Date.now() });
        }

        function getSupportedVideoMimeType() {
            if (typeof MediaRecorder === 'undefined') return '';
            const candidates = [
                'video/webm;codecs=vp9,opus',
                'video/webm;codecs=vp8,opus',
                'video/webm'
            ];
            return candidates.find(type => MediaRecorder.isTypeSupported(type)) || '';
        }

        async function generateVideoThumbnailDataUrl(file, maxWidth = 720, maxHeight = 1280) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.muted = true;
                video.playsInline = true;
                video.src = url;

                const cleanup = () => {
                    URL.revokeObjectURL(url);
                    video.src = '';
                };

                video.onloadedmetadata = () => {
                    let width = video.videoWidth || 720;
                    let height = video.videoHeight || 1280;
                    const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
                    width = Math.max(1, Math.floor(width * ratio));
                    height = Math.max(1, Math.floor(height * ratio));

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    const captureFrame = () => {
                        try {
                            ctx.drawImage(video, 0, 0, width, height);
                            const data = canvas.toDataURL('image/jpeg', 0.72);
                            cleanup();
                            resolve(data);
                        } catch (error) {
                            cleanup();
                            reject(error);
                        }
                    };

                    if (video.duration && Number.isFinite(video.duration) && video.duration > 0.3) {
                        video.currentTime = Math.min(0.3, Math.max(0.01, video.duration / 4));
                    } else {
                        captureFrame();
                    }

                    video.onseeked = captureFrame;
                };

                video.onerror = () => {
                    cleanup();
                    reject(new Error('Nao foi possivel gerar miniatura do video'));
                };
            });
        }

        async function compressVideoToTargetSize(file, maxBytes = MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES) {
            if (!(file instanceof File)) return file;
            if (file.size <= maxBytes) return file;

            const mimeType = getSupportedVideoMimeType();
            if (!mimeType || typeof MediaRecorder === 'undefined') {
                throw new Error('Seu navegador nao suporta compressao automatica de video');
            }

            return new Promise((resolve, reject) => {
                const sourceUrl = URL.createObjectURL(file);
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.muted = true;
                video.playsInline = true;
                video.src = sourceUrl;

                let recorder = null;
                let stopTimer = null;
                const chunks = [];

                const cleanup = () => {
                    if (stopTimer) {
                        clearTimeout(stopTimer);
                        stopTimer = null;
                    }
                    if (recorder && recorder.state !== 'inactive') {
                        try { recorder.stop(); } catch (_e) {}
                    }
                    video.pause();
                    video.src = '';
                    URL.revokeObjectURL(sourceUrl);
                };

                video.onloadedmetadata = async () => {
                    try {
                        const duration = Number(video.duration) || 0;
                        if (!Number.isFinite(duration) || duration <= 0) {
                            cleanup();
                            reject(new Error('Duracao do video invalida para compressao'));
                            return;
                        }

                        const stream = video.captureStream ? video.captureStream() : (video.mozCaptureStream ? video.mozCaptureStream() : null);
                        if (!stream) {
                            cleanup();
                            reject(new Error('captureStream nao suportado para compressao'));
                            return;
                        }

                        const targetBits = Math.floor(maxBytes * 8 * 0.92);
                        const audioBitsPerSecond = 64000;
                        const videoBitsPerSecond = Math.max(180000, Math.floor(targetBits / duration) - audioBitsPerSecond);

                        recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond, audioBitsPerSecond });
                        recorder.ondataavailable = (event) => {
                            if (event.data && event.data.size > 0) chunks.push(event.data);
                        };
                        recorder.onerror = () => {
                            cleanup();
                            reject(new Error('Falha ao comprimir video no navegador'));
                        };
                        recorder.onstop = () => {
                            const compressedBlob = new Blob(chunks, { type: mimeType });
                            const ext = mimeType.includes('webm') ? 'webm' : 'mp4';
                            const compressedFile = new File(
                                [compressedBlob],
                                `${file.name.replace(/\.[^.]+$/, '')}-compressed.${ext}`,
                                { type: compressedBlob.type || mimeType, lastModified: Date.now() }
                            );
                            cleanup();
                            resolve(compressedFile);
                        };

                        await video.play();
                        recorder.start(1000);
                        stopTimer = setTimeout(() => {
                            if (recorder && recorder.state !== 'inactive') recorder.stop();
                        }, Math.ceil(duration * 1000) + 800);
                        video.onended = () => {
                            if (recorder && recorder.state !== 'inactive') recorder.stop();
                        };
                    } catch (error) {
                        cleanup();
                        reject(error);
                    }
                };

                video.onerror = () => {
                    cleanup();
                    reject(new Error('Nao foi possivel abrir o video para compressao'));
                };
            });
        }

        async function handleInstagramImageUpload(event) {
            const file = event?.target?.files?.[0];
            if (!file) return;

            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo', 'video/ogg'];
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');

            if (!isImage && !isVideo) {
                showModal('Erro', 'Tipo de arquivo nao suportado. Use imagem ou video.', 'error');
                return;
            }

            if (isImage && !validImageTypes.includes(file.type)) {
                showModal('Erro', 'Imagem invalida. Use JPG, PNG, GIF ou WebP.', 'error');
                return;
            }

            if (isVideo && !validVideoTypes.includes(file.type)) {
                showModal('Erro', 'Video invalido. Use MP4, WEBM, MOV, AVI ou OGG.', 'error');
                return;
            }

            const uploadArea = document.getElementById('instagramImageUploadArea');
            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = '<div style="padding: 2rem; text-align: center;"><div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: #E4405F; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p style="font-size: 0.875rem; color: var(--text-muted);">Processando midia...</p></div>';

            try {
                if (!r2Client) initR2Client();

                if (isImage) {
                    if (file.size > 12 * 1024 * 1024) {
                        throw new Error('Imagem muito grande. Maximo 12MB.');
                    }

                    const compressedDataUrl = await compressImage(file, 1280, 1280, 0.78);
                    const uploadFile = await dataUrlToFile(compressedDataUrl, `${Date.now()}-instagram.jpg`);
                    const result = await r2Client.uploadFile(uploadFile, 'instagram');
                    const imageUrl = result?.url || '';
                    if (!imageUrl) throw new Error('Upload da imagem falhou');

                    setInstagramMainMediaPreview({
                        mediaType: 'image',
                        imageUrl,
                        videoUrl: ''
                    });
                } else {
                    if (file.size > 120 * 1024 * 1024) {
                        throw new Error('Video muito grande para processar. Maximo recomendado: 120MB.');
                    }

                    let uploadVideoFile = file;
                    if (file.size > MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES) {
                        uploadArea.innerHTML = '<div style="padding: 2rem; text-align: center;"><div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: #E4405F; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p style="font-size: 0.875rem; color: var(--text-muted);">Comprimindo video para 15MB...</p></div>';
                        uploadVideoFile = await compressVideoToTargetSize(file, MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES);
                    }

                    if (uploadVideoFile.size > MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES) {
                        throw new Error('Nao foi possivel comprimir o video para no maximo 15MB.');
                    }

                    uploadArea.innerHTML = '<div style="padding: 2rem; text-align: center;"><div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: #E4405F; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p style="font-size: 0.875rem; color: var(--text-muted);">Enviando video...</p></div>';
                    const result = await r2Client.uploadFile(uploadVideoFile, 'instagram');
                    const videoUrl = result?.url || '';
                    if (!videoUrl) throw new Error('Upload do video falhou');

                    let thumbnailUrl = '';
                    try {
                        thumbnailUrl = await generateVideoThumbnailDataUrl(uploadVideoFile);
                    } catch (_thumbError) {
                        thumbnailUrl = '';
                    }

                    setInstagramMainMediaPreview({
                        mediaType: 'video',
                        imageUrl: thumbnailUrl,
                        videoUrl
                    });
                }

                const preview = document.getElementById('instagramNewsPreview');
                if (preview && preview.style.display === 'none') {
                    preview.style.display = 'block';
                }
            } catch (error) {
                console.error('[Admin] Erro ao processar midia do Instagram:', error);
                showModal('Erro', 'Erro ao processar a midia: ' + (error.message || 'Tente novamente.'), 'error');
            } finally {
                uploadArea.innerHTML = originalContent;
                const fileInput = document.getElementById('instagramImageUpload');
                if (fileInput) fileInput.value = '';
            }
        }

        // Array para armazenar as midias da galeria
        let instagramGalleryData = [];

        // Handler para upload de multiplas midias (galeria)
        async function handleInstagramGalleryUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // Limite maximo de 5 itens na galeria
            const maxGalleryItems = 5;
            const remainingSlots = maxGalleryItems - instagramGalleryData.length;
            
            if (remainingSlots <= 0) {
                showModal('Atencao', `Maximo de ${maxGalleryItems} fotos/videos na galeria.`, 'warning');
                return;
            }
            
            const filesToProcess = files.slice(0, remainingSlots);
            
            const uploadArea = document.getElementById('instagramGalleryUploadArea');
            const originalContent = uploadArea.innerHTML;

            try {
                if (!r2Client) initR2Client();

                for (const file of filesToProcess) {
                    // Validar tipo de arquivo
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'video/mp4', 'video/webm', 'video/quicktime'];
                    if (!validTypes.includes(file.type)) {
                        showModal('Erro', `Tipo de arquivo nao suportado: "${file.name}". Use JPG, PNG, GIF, WebP, MP4, WebM ou MOV.`, 'error');
                        continue;
                    }

                    const isVideo = file.type.startsWith('video/');
                    if (isVideo && file.size > 120 * 1024 * 1024) {
                        showModal('Erro', `Video "${file.name}" muito grande. Maximo 120MB para processamento.`, 'error');
                        continue;
                    }
                    if (!isVideo && file.size > 12 * 1024 * 1024) {
                        showModal('Erro', `Imagem "${file.name}" muito grande. Maximo 12MB.`, 'error');
                        continue;
                    }

                    try {
                        uploadArea.innerHTML = `<div style="padding: 1rem; text-align: center;"><p style="font-size: 0.875rem; color: var(--text-muted);">Processando ${file.name}...</p></div>`;

                        let uploadFile = file;
                        if (isVideo) {
                            if (file.size > MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES) {
                                uploadArea.innerHTML = `<div style="padding: 1rem; text-align: center;"><p style="font-size: 0.875rem; color: var(--text-muted);">Comprimindo ${file.name} para 15MB...</p></div>`;
                                uploadFile = await compressVideoToTargetSize(file, MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES);
                            }
                            if (uploadFile.size > MAX_INSTAGRAM_VIDEO_UPLOAD_BYTES) {
                                showModal('Erro', `Nao foi possivel comprimir "${file.name}" para no maximo 15MB.`, 'error');
                                continue;
                            }
                        } else {
                            const compressedDataUrl = await compressImage(file, 1280, 1280, 0.75);
                            uploadFile = await dataUrlToFile(compressedDataUrl, `${Date.now()}-instagram-gallery.jpg`);
                        }

                        uploadArea.innerHTML = `<div style="padding: 1rem; text-align: center;"><p style="font-size: 0.875rem; color: var(--text-muted);">Enviando ${file.name} para o R2...</p></div>`;

                        const result = await r2Client.uploadFile(uploadFile, 'instagram');
                        const mediaUrl = (result?.url || '').trim();
                        if (!mediaUrl) {
                            throw new Error('URL nao retornada pelo R2');
                        }

                        instagramGalleryData.push({
                            type: isVideo ? 'video' : 'image',
                            url: mediaUrl,
                            name: file.name
                        });
                    } catch (error) {
                        console.error('[Admin] Erro ao processar arquivo da galeria:', error);
                        showModal('Erro', `Erro ao processar "${file.name}".`, 'error');
                    }
                }
            } finally {
                // Restaurar area de upload
                uploadArea.innerHTML = originalContent;
            }
            
            // Atualizar preview
            updateInstagramGalleryPreview();
            
            // Atualizar input hidden
            document.getElementById('instagramGalleryUrls').value = JSON.stringify(instagramGalleryData);

            if (event?.target) {
                event.target.value = '';
            }
        }

        // Comprimir imagem para upload otimizado
        async function compressImage(file, maxWidth = 600, maxHeight = 600, quality = 0.6) {
            return new Promise((resolve, reject) => {
                // Se nao for imagem, retornar o arquivo original
                if (!file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Calcular novo tamanho mantendo proporcao
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Converter para JPEG com qualidade reduzida
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    console.log(`[Admin] Imagem comprimida: ${file.name} - Original: ${Math.round(file.size/1024)}KB, Base64: ${Math.round(compressedData.length/1024)}KB`);
                    resolve(compressedData);
                };
                img.onerror = reject;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Handler para drop de arquivos na galeria
        function handleInstagramGalleryDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                const event = { target: { files: files } };
                handleInstagramGalleryUpload(event);
            }
            // Resetar estilo
            if (e.target.style) {
                e.target.style.borderColor = 'var(--border)';
                e.target.style.background = 'var(--bg-primary)';
            }
        }

        // Atualizar preview da galeria
        function updateInstagramGalleryPreview() {
            const container = document.getElementById('instagramGalleryPreviewContainer');
            const previewDiv = document.getElementById('instagramGalleryPreview');
            
            if (instagramGalleryData.length === 0) {
                container.style.display = 'none';
                previewDiv.innerHTML = '';
                return;
            }
            
            container.style.display = 'block';
            previewDiv.innerHTML = instagramGalleryData.map((item, index) => `
                <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                    ${item.type === 'video' ? `
                        <video src="${item.url}" style="width: 100%; height: 100%; object-fit: cover;" muted></video>
                        <div style="position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </div>
                    ` : `
                        <img src="${item.url}" style="width: 100%; height: 100%; object-fit: cover;">
                    `}
                    <button type="button" onclick="removeInstagramGalleryItem(${index})" style="position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                        x
                    </button>
                </div>
            `).join('');
        }

        // Remover item da galeria
        function removeInstagramGalleryItem(index) {
            instagramGalleryData.splice(index, 1);
            updateInstagramGalleryPreview();
            document.getElementById('instagramGalleryUrls').value = JSON.stringify(instagramGalleryData);
        }

        function clearInstagramNewsForm() {
            try {
                const urlInput = document.getElementById('instagramNewsUrl');
                if (urlInput) urlInput.value = '';
                
                const captionInput = document.getElementById('instagramNewsCaption');
                if (captionInput) captionInput.value = '';
                
                const imagePreview = document.getElementById('instagramNewsImage');
                if (imagePreview) imagePreview.src = '';
                if (imagePreview) imagePreview.style.display = 'block';
                const videoPreview = document.getElementById('instagramNewsVideo');
                if (videoPreview) {
                    videoPreview.pause();
                    videoPreview.src = '';
                    videoPreview.style.display = 'none';
                }
                
                const imagePreviewContainer = document.getElementById('instagramImagePreviewContainer');
                if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
                
                const imageUrlInput = document.getElementById('instagramNewsImageUrl');
                if (imageUrlInput) imageUrlInput.value = '';
                const videoUrlInput = document.getElementById('instagramNewsVideoUrl');
                if (videoUrlInput) videoUrlInput.value = '';
                const mediaTypeInput = document.getElementById('instagramNewsMediaType');
                if (mediaTypeInput) mediaTypeInput.value = 'image';

                const manualVideoNotice = document.getElementById('instagramVideoManualNotice');
                if (manualVideoNotice) manualVideoNotice.style.display = 'none';
                
                const preview = document.getElementById('instagramNewsPreview');
                if (preview) preview.style.display = 'none';
                
                const uploadArea = document.getElementById('instagramImageUploadArea');
                if (uploadArea) uploadArea.style.display = 'block';
                
                // Limpar galeria
                instagramGalleryData = [];
                const galleryPreviewContainer = document.getElementById('instagramGalleryPreviewContainer');
                if (galleryPreviewContainer) galleryPreviewContainer.style.display = 'none';
                const galleryPreview = document.getElementById('instagramGalleryPreview');
                if (galleryPreview) galleryPreview.innerHTML = '';
                const galleryUrlsInput = document.getElementById('instagramGalleryUrls');
                if (galleryUrlsInput) galleryUrlsInput.value = '[]';
                const galleryFileInput = document.getElementById('instagramGalleryUpload');
                if (galleryFileInput) galleryFileInput.value = '';
                
                const likesInput = document.getElementById('instagramLikesCount');
                if (likesInput) likesInput.value = '';
                
                const commentsInput = document.getElementById('instagramCommentsCount');
                if (commentsInput) commentsInput.value = '';
                
                const fileInput = document.getElementById('instagramImageUpload');
                if (fileInput) fileInput.value = '';
                
                instagramNewsData = {};
            } catch (e) {
                console.error('[Admin] Erro ao limpar formulario:', e);
            }
        }

        async function checkExpiredStories() {
            try {
                const now = new Date();
                const snapshot = await db.collection('stories').get();
                
                snapshot.forEach(async (doc) => {
                    const story = doc.data();
                    const storyDate = new Date(story.date);
                    const hoursDiff = (now - storyDate) / (1000 * 60 * 60);
                    
                    if (hoursDiff >= 24) {
                        // Mover para arquivo
                        await db.collection('storiesArchive').doc(doc.id).set({
                            ...story,
                            archivedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // Deletar da colecao ativa
                        await db.collection('stories').doc(doc.id).delete();
                    }
                });
            } catch (error) {
                console.error('[Admin] Erro ao verificar stories expirados:', error);
            }
        }

        async function loadStoriesArchive() {
            try {
                const snapshot = await db.collection('storiesArchive').orderBy('archivedAt', 'desc').get();
                const container = document.getElementById('storiesArchiveList');
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><p>Nenhum story arquivado</p></div>';
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">';
                snapshot.forEach(doc => {
                    const story = doc.data();
                    const archivedDate = story.archivedAt ? new Date(story.archivedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                    html += `
                        <div class="story-card" style="background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border); opacity: 0.7;">
                            <div style="aspect-ratio: 9/16; position: relative;">
                                <img src="${story.image}" alt="${story.title}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="padding: 1rem;">
                                <h4 style="font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.25rem;">${story.title}</h4>
                                <p style="font-size: 0.8125rem; color: var(--text-muted);">Arquivado em: ${archivedDate}</p>
                                <button class="btn btn-primary btn-sm" style="margin-top: 0.5rem; width: 100%;" onclick="restoreStory('${doc.id}')">Restaurar</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('[Admin] Erro ao carregar arquivo:', error);
            }
        }

        async function restoreStory(id) {
            try {
                const doc = await db.collection('storiesArchive').doc(id).get();
                if (doc.exists) {
                    const story = doc.data();
                    // Atualizar data para agora (renova 24h)
                    story.date = new Date().toISOString();
                    story.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('stories').doc(id).set(story);
                    await db.collection('storiesArchive').doc(id).delete();
                    
                    showModal('Sucesso!', 'Story restaurado com sucesso!', 'success');
                    loadStoriesArchive();
                    loadStoriesAdmin();
                }
            } catch (error) {
                console.error('[Admin] Erro ao restaurar story:', error);
                showModal('Erro', 'Nao foi possivel restaurar o story.', 'error');
            }
        }

        async function extractStoryData(e) {
            // Esperar um pouco para o valor ser colado
            setTimeout(async () => {
                const target = e.target || document.getElementById('storyUrlInput');
                const url = target?.value?.trim() || '';
                console.log('[Admin] Extraindo dados do URL:', url);
                
                if (!url || !url.includes('instagram.com')) {
                    console.log('[Admin] URL invalido ou nao e Instagram');
                    return;
                }
                
                const loadingIndicator = document.getElementById('storyLoadingIndicator');
                const previewContainer = document.getElementById('storyImagePreviewContainer');
                const previewImg = document.getElementById('storyPreviewImg');
                const titleInput = document.getElementById('storyTitleInput');
                const imageInput = document.getElementById('storyImageInput');
                
                console.log('[Admin] Elementos encontrados:', { loadingIndicator, previewContainer, previewImg, titleInput, imageInput });
                
                loadingIndicator.style.display = 'block';
                previewContainer.style.display = 'none';
                
                try {
                    // Tentar extrair usando Microlink
                    const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data) {
                        const linkData = data.data;
                        
                        // Extrair imagem
                        const imageUrl = linkData.image?.url || linkData.logo?.url || '';
                        console.log('[Admin] Imagem extraida:', imageUrl);
                        if (imageUrl) {
                            extractedStoryImage = imageUrl;
                            if (imageInput) {
                                imageInput.value = imageUrl;
                                console.log('[Admin] Input atualizado:', imageInput.value);
                            }
                            if (previewImg) {
                                previewImg.src = imageUrl;
                                previewImg.style.display = 'block';
                            }
                            if (previewContainer) {
                                previewContainer.style.display = 'none';
                            }
                        }
                        
                        // Extrair titulo
                        const title = linkData.title || '';
                        console.log('[Admin] Titulo extraido:', title);
                        if (title && titleInput && !titleInput.value) {
                            extractedStoryTitle = title;
                            titleInput.value = title;
                        }
                        
                        console.log('[Admin] Extracao concluida:', { imageUrl, title, extractedStoryImage });
                    } else {
                        // Fallback: tentar extrair da URL do Instagram
                        // Instagram geralmente tem meta tags que podem ser acessadas
                        showModal('Atencao', 'Nao foi possivel extrair automaticamente. Voce pode preencher manualmente.', 'info');
                        previewContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('[Admin] Erro ao extrair dados do story:', error);
                    previewContainer.style.display = 'block';
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }, 100);
        }

        async function loadStoriesAdmin() {
            try {
                // Verificar e mover stories expirados
                await checkExpiredStories();
                
                const snapshot = await db.collection('stories').orderBy('date', 'desc').get();
                const container = document.getElementById('storiesList');
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="48" height="48">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <circle cx="12" cy="12" r="3" fill="currentColor"/>
                            </svg>
                            <p>Nenhum story ativo</p>
                            <p style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">Stories expiram automaticamente apos 24 horas</p>
                            <button class="btn btn-primary btn-sm" style="margin-top: 1rem;" onclick="showCreateStoryModal()">
                                Criar story
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">';
                snapshot.forEach(doc => {
                    const story = doc.data();
                    const date = new Date(story.date);
                    const hoursLeft = Math.max(0, 24 - Math.floor((new Date() - date) / (1000 * 60 * 60)));
                    
                    let previewHtml = '';
                    if (story.type === 'text') {
                        // Preview de story de texto
                        previewHtml = `
                            <div style="width: 100%; height: 100%; background: ${story.bgColor || '#E4405F'}; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                                <p style="color: white; font-size: 0.875rem; text-align: center; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">${story.text || story.title}</p>
                            </div>
                        `;
                    } else if (story.isVideo) {
                        // Preview de video
                        previewHtml = `
                            <video src="${story.image}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); border-radius: 50%; padding: 0.5rem;">
                                <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                                    <polygon points="5,3 19,12 5,21" fill="white"/>
                                </svg>
                            </div>
                        `;
                    } else {
                        // Preview de imagem
                        previewHtml = `<img src="${story.image}" alt="${story.title}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    }
                    
                    html += `
                        <div class="story-card" style="background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border);">
                            <div style="aspect-ratio: 9/16; position: relative;">
                                ${previewHtml}
                                <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                                    <button class="action-btn" onclick="editStory('${doc.id}')" title="Editar">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button class="action-btn delete" onclick="deleteStory('${doc.id}')" title="Excluir">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 0.5rem; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);">
                                    <span style="color: white; font-size: 0.75rem; font-weight: 500;">${hoursLeft}h restantes</span>
                                </div>
                            </div>
                            <div style="padding: 0.75rem;">
                                <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${story.title}</h4>
                                <span style="font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase;">${story.type === 'text' ? 'Texto' : story.isVideo ? 'Video' : 'Foto'}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('[Admin] Erro ao carregar stories:', error);
            }
        }

        function toggleStoryType(type) {
            const mediaSection = document.getElementById('storyMediaSection');
            const textSection = document.getElementById('storyTextSection');
            
            if (type === 'media') {
                mediaSection.style.display = 'block';
                textSection.style.display = 'none';
            } else {
                mediaSection.style.display = 'none';
                textSection.style.display = 'block';
            }
        }

        function setStoryBgColor(color) {
            document.getElementById('storyBgColor').value = color;
        }

        async function handleStoryFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
                showModal('Erro', 'Arquivo muito grande. Maximo 50MB.', 'error');
                return;
            }
            
            const previewDiv = document.getElementById('storyFilePreview');
            const previewImg = document.getElementById('storyFilePreviewImg');
            const previewVideo = document.getElementById('storyFilePreviewVideo');
            const progressDiv = document.getElementById('storyUploadProgress');
            const progressBar = document.getElementById('storyUploadProgressBar');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (file.type.startsWith('video/')) {
                    previewImg.style.display = 'none';
                    previewVideo.style.display = 'block';
                    previewVideo.src = e.target.result;
                } else {
                    previewVideo.style.display = 'none';
                    previewImg.style.display = 'block';
                    previewImg.src = e.target.result;
                }
                previewDiv.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            progressDiv.style.display = 'block';
            
            try {
                if (!r2Client) {
                    initR2Client();
                }

                const result = await r2Client.uploadFile(file, 'stories', (progress) => {
                    progressBar.style.width = `${Math.max(0, Math.min(progress, 100))}%`;
                });

                const fileUrl = result?.url || '';
                if (!fileUrl) {
                    throw new Error('URL do arquivo nao retornada pelo R2');
                }

                document.getElementById('storyMediaUrl').value = fileUrl;
                extractedStoryImage = fileUrl;
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 200);
            } catch (error) {
                console.error('[Admin] Erro no upload:', error);
                showModal('Erro', 'Erro ao fazer upload: ' + error.message, 'error');
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }

        function showCreateStoryModal() {
            console.log('[Admin] Abrindo modal de story');
            currentEditingStoryId = null;
            extractedStoryImage = '';
            extractedStoryTitle = '';
            
            document.getElementById('storyFormTitle').textContent = 'Novo Story';
            document.getElementById('storyTitleInput').value = '';
            document.getElementById('storyTextContent').value = '';
            document.getElementById('storyBgColor').value = '#E4405F';
            document.getElementById('storyMediaUrl').value = '';
            document.getElementById('storyFileInput').value = '';
            
            document.getElementById('storyFilePreview').style.display = 'none';
            document.getElementById('storyFilePreviewImg').src = '';
            document.getElementById('storyFilePreviewVideo').src = '';
            document.getElementById('storyUploadProgress').style.display = 'none';
            
            document.querySelector('input[name="storyType"][value="media"]').checked = true;
            toggleStoryType('media');
            
            document.getElementById('storyModalOverlay').classList.add('active');
        }

        function closeStoryModal() {
            console.log('[Admin] Fechando modal');
            const modal = document.getElementById('storyModalOverlay');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function previewStoryImage(url) {
            const preview = document.getElementById('storyPreviewImg');
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    preview.style.display = 'none';
                };
            } else {
                preview.style.display = 'none';
            }
        }

        async function saveStory() {
            console.log('[Admin] Iniciando saveStory...');
            
            const storyType = document.querySelector('input[name="storyType"]:checked')?.value || 'media';
            const title = document.getElementById('storyTitleInput')?.value?.trim() || 'Story';
            
            let storyData = {
                title,
                type: storyType,
                date: new Date().toISOString(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (storyType === 'media') {
                // Story com foto ou video
                const mediaUrl = document.getElementById('storyMediaUrl')?.value || extractedStoryImage;
                
                if (!mediaUrl) {
                    showModal('Atencao', 'Faca upload de uma foto ou video', 'warning');
                    return;
                }
                
                storyData.image = mediaUrl;
                storyData.isVideo = mediaUrl.includes('.mp4') || mediaUrl.includes('.mov') || mediaUrl.includes('video');
            } else {
                // Story de texto
                const textContent = document.getElementById('storyTextContent')?.value?.trim();
                const bgColor = document.getElementById('storyBgColor')?.value || '#E4405F';
                
                if (!textContent) {
                    showModal('Atencao', 'Digite o texto do story', 'warning');
                    return;
                }
                
                storyData.text = textContent;
                storyData.bgColor = bgColor;
                storyData.image = null; // Story de texto nao tem imagem
            }
            
            console.log('[Admin] Salvando story:', storyData);
            
            try {
                if (currentEditingStoryId) {
                    await db.collection('stories').doc(currentEditingStoryId).update(storyData);
                    showModal('Sucesso!', 'Story atualizado com sucesso!', 'success');
                } else {
                    await db.collection('stories').add(storyData);
                    showModal('Sucesso!', 'Story publicado com sucesso!', 'success');
                }
                closeStoryModal();
                loadStoriesAdmin();
            } catch (error) {
                console.error('[Admin] Erro ao salvar story:', error);
                showModal('Erro!', 'Nao foi possivel salvar o story. Erro: ' + error.message, 'error');
            }
        }

        async function editStory(id) {
            try {
                const doc = await db.collection('stories').doc(id).get();
                if (doc.exists) {
                    const story = doc.data();
                    currentEditingStoryId = id;
                    extractedStoryImage = story.image || '';
                    extractedStoryTitle = story.title || '';
                    
                    document.getElementById('storyFormTitle').textContent = 'Editar Story';
                    document.getElementById('storyTitleInput').value = story.title || '';
                    
                    // Configurar tipo de story
                    const storyType = story.type || 'media';
                    document.querySelector(`input[name="storyType"][value="${storyType}"]`).checked = true;
                    toggleStoryType(storyType);
                    
                    if (storyType === 'text') {
                        // Story de texto
                        document.getElementById('storyTextContent').value = story.text || '';
                        document.getElementById('storyBgColor').value = story.bgColor || '#E4405F';
                    } else {
                        // Story de midia
                        if (story.image) {
                            document.getElementById('storyMediaUrl').value = story.image;
                            const previewDiv = document.getElementById('storyFilePreview');
                            const previewImg = document.getElementById('storyFilePreviewImg');
                            const previewVideo = document.getElementById('storyFilePreviewVideo');
                            
                            previewDiv.style.display = 'block';
                            if (story.isVideo) {
                                previewImg.style.display = 'none';
                                previewVideo.style.display = 'block';
                                previewVideo.src = story.image;
                            } else {
                                previewVideo.style.display = 'none';
                                previewImg.style.display = 'block';
                                previewImg.src = story.image;
                            }
                        }
                    }
                    
                    document.getElementById('storyModalOverlay').classList.add('active');
                }
            } catch (error) {
                console.error('[Admin] Erro ao carregar story:', error);
            }
        }

        async function deleteStory(id) {
            if (!confirm('Tem certeza que deseja excluir este story?')) return;
            
            try {
                const docRef = db.collection('stories').doc(id);
                const docSnapshot = await docRef.get();
                const r2Keys = docSnapshot.exists ? collectR2KeysFromStoryData(docSnapshot.data() || {}) : [];

                await docRef.delete();
                const cleanup = await deleteR2MediaKeys(r2Keys);

                if (cleanup.failed.length > 0) {
                    showModal(
                        'Sucesso com aviso',
                        `Story excluido, mas ${cleanup.failed.length} arquivo(s) de midia nao foram removidos do R2.`,
                        'info'
                    );
                } else {
                    showModal('Sucesso!', 'Story excluido com sucesso!', 'success');
                }
                loadStoriesAdmin();
            } catch (error) {
                console.error('[Admin] Erro ao excluir story:', error);
                showModal('Erro!', 'Nao foi possivel excluir o story.', 'error');
            }
        }

    </script>
    <!-- Story Modal -->
    <div class="modal-overlay" id="storyModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-card); border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="storyFormTitle" style="font-size: 1.25rem; font-weight: 600;">Novo Story</h3>
                <button onclick="closeStoryModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div style="padding: 1.5rem;">
                <!-- Tipo de Story -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Tipo de Story</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="storyType" value="media" checked onchange="toggleStoryType('media')">
                            <span>Foto/Video</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="storyType" value="text" onchange="toggleStoryType('text')">
                            <span>Texto</span>
                        </label>
                    </div>
                </div>

                <!-- Upload de Midia -->
                <div id="storyMediaSection">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Upload Foto/Video <span style="color: var(--destructive);">*</span></label>
                        <div id="storyUploadArea" style="background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius); padding: 2rem; text-align: center; cursor: pointer;" onclick="document.getElementById('storyFileInput').click()">
                            <input type="file" id="storyFileInput" accept="image/*,video/*" style="display: none;" onchange="handleStoryFileUpload(event)">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 0.5rem; opacity: 0.5;">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke-width="2"/>
                                <polyline points="17 8 12 3 7 8" stroke-width="2"/>
                                <line x1="12" y1="3" x2="12" y2="15" stroke-width="2"/>
                            </svg>
                            <p style="font-size: 0.875rem; color: var(--text-muted);">Clique para fazer upload</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">JPG, PNG, GIF, MP4, MOV (max. 50MB)</p>
                        </div>
                        <div id="storyFilePreview" style="display: none; margin-top: 0.75rem;">
                            <img id="storyFilePreviewImg" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: var(--radius); border: 1px solid var(--border);">
                            <video id="storyFilePreviewVideo" style="width: 100%; max-height: 300px; border-radius: var(--radius); border: 1px solid var(--border);" controls style="display: none;"></video>
                            <input type="hidden" id="storyMediaUrl">
                        </div>
                        <div id="storyUploadProgress" style="display: none; margin-top: 0.5rem;">
                            <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                                <div id="storyUploadProgressBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s;"></div>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; text-align: center;">Enviando...</p>
                        </div>
                    </div>
                </div>

                <!-- Story de Texto -->
                <div id="storyTextSection" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Texto do Story <span style="color: var(--destructive);">*</span></label>
                        <textarea id="storyTextContent" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;" placeholder="Digite o texto do story..."></textarea>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Cor de Fundo</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="setStoryBgColor('#E4405F')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); cursor: pointer;"></button>
                            <button onclick="setStoryBgColor('#833AB4')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: #833AB4; cursor: pointer;"></button>
                            <button onclick="setStoryBgColor('#405DE6')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: #405DE6; cursor: pointer;"></button>
                            <button onclick="setStoryBgColor('#FD1D1D')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: #FD1D1D; cursor: pointer;"></button>
                            <button onclick="setStoryBgColor('#F56040')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: #F56040; cursor: pointer;"></button>
                            <button onclick="setStoryBgColor('#000000')" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: #000000; cursor: pointer;"></button>
                        </div>
                        <input type="hidden" id="storyBgColor" value="#E4405F">
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Titulo <span style="color: var(--text-muted); font-weight: 400;">(opcional)</span></label>
                    <input type="text" id="storyTitleInput" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" placeholder="Ex: Lancamento do novo projeto">
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeStoryModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveStory()">Publicar Story</button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        #storyModalOverlay.active { display: flex !important; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

</body>

</html>





